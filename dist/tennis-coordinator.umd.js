(function(a,r){typeof exports=="object"&&typeof module<"u"?r(exports):typeof define=="function"&&define.amd?define(["exports"],r):(a=typeof globalThis<"u"?globalThis:a||self,r(a.TennisCoordinator={}))})(this,(function(a){"use strict";function r(s){return s.toLowerCase().trim().replace(/\s+/g," ")}function N(s){switch(s){case"singles":return"Singles Only";case"doubles":return"Doubles Only";case"both":return"Either";default:return"Either"}}function M(s,e){return s&&e?`${s} - ${e}`:s?`From ${s}`:e?`Until ${e}`:""}function O(s){return new Date(s+"T12:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}function $(s){return new Date(s+"T12:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}function L(s){const e=new Date(s),n=new Date().getTime()-e.getTime(),i=Math.floor(n/6e4),o=Math.floor(n/36e5);return i<1?"Just now":i<60?`${i} minute${i===1?"":"s"} ago`:o<24?`${o} hour${o===1?"":"s"} ago`:e.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}function P(){return new Date().toISOString().split("T")[0]}function I(s){const e=new Date;return e.setDate(e.getDate()+s),e.toISOString().split("T")[0]}function U(s,e){return r(s)===r(e)}function _(s,e){if(!s||!e||!s.start&&!s.end||!e.start&&!e.end)return!0;const t=y=>{const m=y.match(/(\d+):?(\d*)?\s*(AM|PM)?/i);if(!m)return 0;let f=parseInt(m[1]);const h=m[2]?parseInt(m[2]):0,p=m[3]?.toUpperCase();return p==="PM"&&f!==12&&(f+=12),p==="AM"&&f===12&&(f=0),f*60+h},n=s.start?t(s.start):0,i=s.end?t(s.end):1440,o=e.start?t(e.start):0,g=e.end?t(e.end):1440;return n<g&&o<i}function z(s){return s.replace(/[\s\-\(\)]/g,"")}function G(s){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)}function j(s){return s.replace(/\D/g,"").length>=10}function B(s){const e=document.createElement("div");return e.textContent=s,e.innerHTML}function V(s,e){let t=null;return function(...n){t&&clearTimeout(t),t=setTimeout(()=>{s.apply(this,n)},e)}}function H(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function C(s,e){return e[r(s)]||{include:[],exclude:[]}}function W(s,e,t){const n=C(s,t),i=C(e,t),o=r(s),g=r(e);return!n.exclude.includes(g)&&!i.exclude.includes(o)}function k(s,e){if(!s||!e||!s.start&&!s.end&&!e.start&&!e.end)return!0;const t=u=>{if(!u)return null;const[d,S]=u.split(":").map(Number);return d*60+S},n=t(s.start),i=t(s.end),o=t(e.start),g=t(e.end),y=360,m=1260,f=n??y,h=i??m,p=o??y;return f<(g??m)&&p<h}function v(s,e,t){return W(s.name,e.name,t)?k(s.timeRange,e.timeRange):!1}function Y(s,e={}){const t=[],n=[];let i=s.map((l,u)=>({...l,originalIndex:u}));i.sort((l,u)=>l.timestamp-u.timestamp);const o=i.filter(l=>l.playStyle==="doubles"),g=i.filter(l=>l.playStyle==="singles"),y=i.filter(l=>l.playStyle==="both"||!l.playStyle);let m=[...o,...y].sort((l,u)=>l.timestamp-u.timestamp);for(;m.length>=4;){const l=m.slice(0,4);t.push({type:"doubles",number:t.filter(u=>u.type==="doubles").length+1,players:l}),m.splice(0,4)}let f=[...g].sort((l,u)=>l.timestamp-u.timestamp);for(;f.length>=2;){let l=null;for(let u=0;u<f.length-1;u++){for(let d=u+1;d<f.length;d++)if(v(f[u],f[d],e)){l=[f[u],f[d]];break}if(l)break}if(l)t.push({type:"singles",players:l}),l.forEach(u=>{const d=f.findIndex(S=>S.originalIndex===u.originalIndex);d>-1&&f.splice(d,1)});else break}const h=m,p=f;if(h.length>0){const l=4-h.length,u=h.filter(b=>b.playStyle==="both"||!b.playStyle),d=u.length,S=h.every(b=>b.playStyle==="both"||!b.playStyle),de=h.every(b=>b.allowRotation!==!1),ye=h.length===3&&v(h[0],h[1],e)&&v(h[0],h[2],e)&&v(h[1],h[2],e);let F=!1;d>=2&&(F=v(u[0],u[1],e)),t.push({type:"doubles-forming",players:h,needed:l,canRotate:h.length===3&&S&&de&&ye,eitherCount:d,canPlaySingles:F})}return p.length>0&&p.forEach(l=>{t.push({type:"singles-forming",players:[l],needed:1})}),{matches:t,warnings:n}}function q(s,e){const t=r(s);return e.some(n=>(n.type==="doubles"||n.type==="singles")&&n.players.some(i=>r(i.name)===t))}function K(s,e){const t=r(s);for(const n of e)if(n.players.some(i=>r(i.name)===t))return n.type;return null}function A(s,e){return(e.mutedMembers||[]).some(n=>r(n)===r(s))}function J(s,e,t){return!(!e.activityAlerts||r(s)===r(t)||A(t,e))}function Q(s,e){return e.matchConfirmations===!0}function X(s,e,t={}){const n=$(e),i=[];if(t.playStyle&&i.push(N(t.playStyle)),t.timeStart||t.timeEnd){const y=M(t.timeStart,t.timeEnd);y&&i.push(y)}let o="";t.addedBy&&r(t.addedBy)!==r(s)&&(o=` (added by ${t.addedBy})`);const g=i.length>0?` [${i.join(", ")}]`:"";return`ðŸŽ¾ ${s} checked in for ${n}${g}${o}`}function Z(s,e,t){const n=$(e);let i="";return t&&r(t)!==r(s)&&(i=` (by ${t})`),`ðŸ‘‹ ${s} is no longer available for ${n}${i}`}function x(s,e,t,n){const i=$(e);return`âœ… You're in ${t==="doubles"?"Doubles":"Singles"} for ${i} with ${n.join(", ")}`}function ee(s,e){return`ðŸ‘¤ ${s} was added to the group by ${e}`}function te(s,e){return`ðŸš« ${s} was removed from the group by ${e}`}function se(s,e,t={}){return{message:e,timestamp:Date.now(),read:!1,type:s,...t}}function ne(s,e,t,n={}){return{timestamp:Date.now(),action:s,player:e,by:t,...n}}function ie(s){const e=new Date(s.timestamp).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"});switch(s.action){case"check-in":{const t=[];if(s.playStyle&&t.push(N(s.playStyle)),s.timeRange){const o=M(s.timeRange.start,s.timeRange.end);o&&t.push(o)}const n=t.length>0?` [${t.join(", ")}]`:"",i=r(s.by)!==r(s.player)?` (added by ${s.by})`:"";return`${e} - ${s.player} checked in${n}${i}`}case"removal":{const t=r(s.by)!==r(s.player)?` (by ${s.by})`:"";return`${e} - ${s.player} removed${t}`}case"member_added":{const t=s.contact?` (${s.contact})`:"";return`${e} - ${s.player}${t} added by ${s.by}`}case"member_removed":return`${e} - ${s.player} removed by ${s.by}`;case"whatsapp_share":{const t=s.type?` (${s.type})`:"";return`${e} - ${s.by} shared to WhatsApp${t}`}case"notes_saved":{const t=s.matchKey?` for ${s.matchKey}`:"";return`${e} - Notes saved${t} by ${s.by}`}default:return`${e} - ${s.action} by ${s.by}`}}function ae(s,e){return!(e.player&&r(s.player)!==r(e.player)||e.action&&s.action!==e.action||e.by&&r(s.by)!==r(e.by))}function re(s,e=!1){return[...s].sort((t,n)=>e?t.timestamp-n.timestamp:n.timestamp-t.timestamp)}function oe(s){return s.reduce((e,t)=>{switch(t.action){case"check-in":e.checkins++;break;case"removal":e.removals++;break;case"member_added":case"member_removed":e.memberChanges++;break;case"whatsapp_share":e.shares++;break}return e},{checkins:0,removals:0,memberChanges:0,shares:0})}function ce(s){const e=new Set;for(const t of s)t.player&&e.add(t.player);return Array.from(e)}const c={groups:()=>"groups",group:s=>`groups/${s}`,checkins:s=>`groups/${s}/checkins`,checkinsDate:(s,e)=>`groups/${s}/checkins/${e}`,settings:s=>`groups/${s}/settings`,activity:(s,e)=>`groups/${s}/activity/${e}`,activityAll:s=>`groups/${s}/activity`,matchNotes:(s,e)=>`groups/${s}/matchNotes/${e}`,matchNote:(s,e,t)=>`groups/${s}/matchNotes/${e}/${t}`,userPreferences:()=>"userPreferences",siteSettings:()=>"siteSettings",userNotificationPrefs:(s,e)=>`groups/${s}/userNotifications/${r(e)}/preferences`,userNotifications:(s,e)=>`groups/${s}/userNotifications/${r(e)}/items`,groupNotifications:s=>`groups/${s}/userNotifications`};class T{db;constructor(e){this.db=e}ref(e){return this.db.ref(e)}async loadAvailableGroups(){return(await this.ref(c.groups()).once("value")).val()||{}}async saveGroup(e,t){await this.ref(c.group(e)).update(t)}async deleteGroup(e){await this.ref(c.group(e)).remove()}async loadSettings(e){const n=(await this.ref(c.settings(e)).once("value")).val();return n?{groupName:n.groupName||"Unknown Group",coreMembers:n.coreMembers||[],memberDetails:n.memberDetails||{},groupPin:n.groupPin||"14675",adminPin:n.adminPin||"3250",location:n.location||{lat:37.2358,lon:-121.9623,name:"Los Gatos, CA"}}:null}async saveSettings(e,t){await this.ref(c.settings(e)).update(t)}async updateMembers(e,t,n){await this.ref(c.settings(e)).update({members:t,memberDetails:n})}async loadCheckins(e){return(await this.ref(c.checkins(e)).once("value")).val()||{}}async loadCheckinsForDate(e,t){return(await this.ref(c.checkinsDate(e,t)).once("value")).val()||[]}async saveCheckinsForDate(e,t,n){await this.ref(c.checkinsDate(e,t)).set(n)}async verifyCheckinsForDate(e,t,n){return((await this.ref(c.checkinsDate(e,t)).once("value")).val()||[]).length===n}async loadUserPreferences(){return(await this.ref(c.userPreferences()).once("value")).val()||{}}async saveUserPreferences(e){await this.ref(c.userPreferences()).set(e)}async loadActivityForDate(e,t){return(await this.ref(c.activity(e,t)).once("value")).val()||{}}async loadAllActivity(e){return(await this.ref(c.activityAll(e)).once("value")).val()||{}}async logActivity(e,t,n){await this.ref(c.activity(e,t)).push().set(n)}async loadMatchNotes(e,t){return(await this.ref(c.matchNotes(e,t)).once("value")).val()||{}}async saveMatchNote(e,t,n,i){await this.ref(c.matchNote(e,t,n)).set(i)}async loadNotificationPrefs(e,t){const i=(await this.ref(c.userNotificationPrefs(e,t)).once("value")).val();return{activityAlerts:i?.activityAlerts??!0,matchConfirmations:i?.matchConfirmations??!0,mutedMembers:i?.mutedMembers||[]}}async saveNotificationPrefs(e,t,n){await this.ref(c.userNotificationPrefs(e,t)).set(n)}async loadNotifications(e,t){return(await this.ref(c.userNotifications(e,t)).once("value")).val()||{}}async addNotification(e,t,n){await this.ref(c.userNotifications(e,t)).push().set(n)}async markNotificationRead(e,t,n){await this.ref(`${c.userNotifications(e,t)}/${n}/read`).set(!0)}async markAllNotificationsRead(e,t){const n=await this.loadNotifications(e,t),i={};for(const o of Object.keys(n))i[`${o}/read`]=!0;Object.keys(i).length>0&&await this.ref(c.userNotifications(e,t)).update(i)}async clearNotifications(e,t){await this.ref(c.userNotifications(e,t)).remove()}async loadSiteSettings(){return(await this.ref(c.siteSettings()).once("value")).val()||{}}async saveSiteSettings(e){await this.ref(c.siteSettings()).set(e)}}function le(s){return new T(s)}const ue={activityAlerts:!0,matchConfirmations:!0,mutedMembers:[]},fe={lat:37.2358,lon:-121.9623,name:"Los Gatos, CA"};function D(){return{currentGroupId:null,currentGroupName:"",availableGroups:{},allCheckins:{},userPreferences:{},coreMembers:[],memberDetails:{},matchNotes:{},groupPin:"14675",adminPin:"3250",weatherLocation:fe,weatherCache:{},selectedDate:P(),selectedPreference:"both",selectedName:"",isGuest:!1,addedBy:"",sessionUser:"",currentEditingUser:null,tempInclude:[],tempExclude:[],userNotificationPrefs:ue}}class R{state;listeners;constructor(e){this.state={...D(),...e},this.listeners=new Map}getState(){return this.state}get(e){return this.state[e]}set(e,t){const n=this.state[e];this.state[e]=t,this.notifyListeners(e,t,n)}update(e){for(const[t,n]of Object.entries(e)){const i=t,o=this.state[i];this.state[i]=n,this.notifyListeners(i,n,o)}}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{this.listeners.get(e)?.delete(t)}}notifyListeners(e,t,n){const i=this.listeners.get(e);if(i)for(const o of i)o(t,n)}getCheckinsForSelectedDate(){const e=this.state.selectedDate;return e?this.state.allCheckins[e]||[]:[]}getCheckinsForDate(e){return this.state.allCheckins[e]||[]}addCheckin(e){const t=this.state.selectedDate;if(!t)return;const n=this.state.allCheckins[t]||[],i={...this.state.allCheckins,[t]:[...n,e]};this.set("allCheckins",i)}removeCheckin(e){const t=this.state.selectedDate;if(!t)return null;const n=this.state.allCheckins[t]||[];if(e<0||e>=n.length)return null;const i=n[e],o={...this.state.allCheckins,[t]:n.filter((g,y)=>y!==e)};return this.set("allCheckins",o),i}setCheckinsForDate(e,t){const n={...this.state.allCheckins,[e]:t};this.set("allCheckins",n)}getUserPreference(e){const t=r(e);return this.state.userPreferences[t]||{include:[],exclude:[]}}setUserPreference(e,t){const n=r(e),i={...this.state.userPreferences,[n]:t};this.set("userPreferences",i)}isCoreMember(e){const t=r(e);return this.state.coreMembers.some(n=>r(n)===t)}addCoreMember(e){this.isCoreMember(e)||this.set("coreMembers",[...this.state.coreMembers,e])}removeCoreMember(e){const t=r(e);this.set("coreMembers",this.state.coreMembers.filter(n=>r(n)!==t))}getMatchNote(e){return this.state.matchNotes[e]||""}setMatchNote(e,t){const n={...this.state.matchNotes,[e]:t};this.set("matchNotes",n)}isMemberMuted(e){const t=this.state.userNotificationPrefs.mutedMembers||[],n=r(e);return t.some(i=>r(i)===n)}toggleMutedMember(e){const t=this.state.userNotificationPrefs.mutedMembers||[],n=r(e);let i;this.isMemberMuted(e)?i=t.filter(o=>r(o)!==n):i=[...t,e],this.set("userNotificationPrefs",{...this.state.userNotificationPrefs,mutedMembers:i})}reset(){this.state=D()}resetForNewGroup(){this.update({allCheckins:{},coreMembers:[],memberDetails:{},matchNotes:{},userPreferences:{}})}}function E(s){return new R(s)}let w=null;function he(){return w||(w=E()),w}function me(){w=null}a.AppStore=R,a.FirebaseService=T,a.canPlayTogetherWithTime=v,a.cleanPhoneNumber=z,a.createActivityEntry=ne,a.createAppStore=E,a.createFirebaseService=le,a.createInitialState=D,a.createNotificationData=se,a.debounce=V,a.escapeHtml=B,a.firebasePaths=c,a.formatActivityDisplay=ie,a.formatCheckinNotification=X,a.formatDate=O,a.formatDateForNotification=$,a.formatMatchFormedNotification=x,a.formatMemberAddedNotification=ee,a.formatMemberRemovedNotification=te,a.formatRemovalNotification=Z,a.formatTime=L,a.formatTimeRange=M,a.generateId=H,a.getActivitySummary=oe,a.getDateOffset=I,a.getDefaultStore=he,a.getPlayerMatchType=K,a.getPreferenceLabel=N,a.getTodayDate=P,a.getUniquePlayers=ce,a.isMemberMuted=A,a.isPlayerInMatch=q,a.isSameName=U,a.isValidEmail=G,a.isValidPhone=j,a.matchesActivityFilter=ae,a.normalizeName=r,a.organizeMatches=Y,a.resetDefaultStore=me,a.shouldReceiveActivityNotification=J,a.shouldReceiveMatchNotification=Q,a.sortActivitiesByTime=re,a.timeRangesOverlap=_,a.timesOverlap=k,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})}));
