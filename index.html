<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tue/Thu+ Midday Doubles</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- PWA Support -->
    <link rel="manifest" id="manifestLink" href="/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tennis">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 12px;
            background: #f5f5f5;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-icon {
            background: transparent;
            color: #666;
            border: none;
            padding: 8px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-icon:hover {
            background: #f0f0f0;
        }
        
        .settings-icon:active {
            transform: scale(0.95);
        }
        
        .date-selector {
            margin-bottom: 16px;
        }

        .date-selector h2 {
            font-size: 13px;
            margin-bottom: 6px;
            color: #666;
        }

        .date-grid {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 0 8px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .date-grid::-webkit-scrollbar {
            height: 4px;
        }

        .date-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .date-grid::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 4px;
        }

        .date-btn {
            padding: 8px 12px;
            background: #d0d0d0;
            color: #333;
            border: 2px solid #b0b0b0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 11px;
            transition: all 0.2s;
            min-height: 56px;
            min-width: 64px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            white-space: nowrap;
        }
        
        .date-btn:active {
            transform: scale(0.95);
        }
        
        .date-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .date-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: 600;
        }
        
        .date-btn .day-name {
            font-size: 9px;
            text-transform: uppercase;
            opacity: 0.8;
            display: block;
        }

        .date-btn .day-num {
            font-size: 14px;
            font-weight: 600;
            display: block;
            margin: 2px 0;
        }
        
        .date-btn .checkin-badge {
            font-size: 9px;
            background: #ff9800;
            color: white;
            border-radius: 10px;
            padding: 2px 5px;
            margin-top: 2px;
            display: inline-block;
        }
        
        .date-btn.selected .checkin-badge {
            background: rgba(255,255,255,0.3);
        }
        
        .input-group {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        input {
            flex: 1 1 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            min-width: 0;
        }
        
        @media (min-width: 400px) {
            input {
                flex: 1 1 auto;
            }
        }
        
        .preference-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 16px;
        }
        
        .preference-btn {
            padding: 10px 6px;
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .preference-btn:active {
            transform: scale(0.95);
        }
        
        .preference-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .preference-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .preference-btn.singles.selected {
            background: #ff9800;
            border-color: #ff9800;
        }
        
        .preference-btn.doubles.selected {
            background: #2196F3;
            border-color: #2196F3;
        }
        
        input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            padding: 12px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 600;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:active {
            transform: scale(0.97);
        }
        
        button:hover {
            background: #45a049;
        }
        
        .reset-btn {
            background: #f44336;
            width: 100%;
            margin-top: 16px;
        }
        
        .reset-btn:hover {
            background: #da190b;
        }

        .share-whatsapp-btn {
            background: #25D366;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
            touch-action: manipulation;
        }

        .share-whatsapp-btn:hover {
            background: #20BA5A;
        }

        .share-whatsapp-btn:active {
            transform: scale(0.97);
        }

        .checkins {
            margin: 16px 0;
        }
        
        .checkins h2 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #666;
        }
        
        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .checkin-item > span {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        @media (min-width: 500px) {
            .checkin-item > span {
                flex-direction: row;
                align-items: center;
                flex-wrap: wrap;
            }
        }
        
        .checkin-name {
            font-weight: 500;
            font-size: 15px;
        }
        
        .preference-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .preference-badge.singles {
            background: #fff3e0;
            color: #e65100;
        }
        
        .preference-badge.doubles {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .preference-badge.both {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .checkin-time {
            font-size: 12px;
            color: #999;
        }
        
        .remove-btn {
            padding: 8px 12px;
            background: #ff5252;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .matches {
            margin-top: 20px;
        }
        
        .match-group {
            margin-bottom: 16px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .match-group h3 {
            font-size: 15px;
            margin-bottom: 8px;
            color: #2e7d32;
        }
        
        .match-group ul {
            list-style: none;
            padding-left: 0;
        }
        
        .match-group li {
            padding: 6px 0;
            color: #333;
            font-size: 14px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
        }
        
        .singles-group {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        
        .singles-group h3 {
            color: #e65100;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: calc(100% - 40px);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-header h2 {
            font-size: 18px;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .pref-section {
            margin-bottom: 20px;
        }
        
        .pref-section h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .pref-section p {
            margin: 0 0 8px 0;
        }
        
        .pref-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .pref-input-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .pref-input-group button {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .pref-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .pref-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f5f5f5;
            border-radius: 16px;
            font-size: 13px;
        }
        
        .pref-tag.include {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .pref-tag.exclude {
            background: #ffebee;
            color: #c62828;
        }
        
        .pref-tag button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
            font-size: 16px;
            line-height: 1;
            opacity: 0.6;
        }
        
        .pref-tag button:hover {
            opacity: 1;
        }
        
        .pref-summary {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        
        .edit-prefs-btn {
            background: transparent;
            color: #4CAF50;
            border: 1px solid #4CAF50;
            padding: 6px 12px;
            font-size: 13px;
            margin-left: 8px;
        }
        
        .edit-prefs-btn:hover {
            background: #e8f5e9;
        }
        
        .match-indicator {
            font-size: 11px;
            margin-left: 4px;
        }
        
        .match-indicator.satisfied {
            color: #4CAF50;
        }
        
        .match-indicator.conflict {
            color: #f44336;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .member-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        
        .member-item button {
            padding: 6px 10px;
            background: #f44336;
            font-size: 12px;
        }
        
        .add-member-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .add-member-input input {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }
        
        .add-member-input button {
            padding: 10px 16px;
            font-size: 14px;
        }
        
        .guest-indicator {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            margin-bottom: 10px;
        }
        
        .guest-form {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .guest-form.active {
            display: block;
        }
        
        .guest-form input {
            margin-bottom: 8px;
        }
        
        .weather-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 13px;
        }

        .weather-widget h3 {
            font-size: 12px;
            margin: 0;
            opacity: 0.9;
            font-weight: 500;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .weather-temp {
            font-size: 22px;
            font-weight: bold;
        }

        .weather-desc {
            font-size: 13px;
            text-transform: capitalize;
        }
        
        .weather-details {
            display: flex;
            gap: 8px;
            font-size: 11px;
            opacity: 0.9;
        }

        .weather-details > span {
            white-space: nowrap;
        }

        .collapsible-form {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }

        .collapsible-form.expanded {
            max-height: 1000px;
            opacity: 1;
            transition: max-height 0.4s ease-in, opacity 0.4s ease-in;
        }

        .weather-error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .weather-loading {
            background: #e3f2fd;
            color: #1565c0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 13px;
        }
        
        .time-slots {
            margin-bottom: 16px;
        }
        
        .time-slots h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .time-slot-btn {
            padding: 10px 6px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
        }
        
        .time-slot-btn:active {
            transform: scale(0.95);
        }
        
        .time-slot-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .time-slot-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: 600;
        }
        
        .time-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
            margin-left: 4px;
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #4CAF50;
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast.success {
            border-left-color: #4CAF50;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Landing Page (shown when no group selected) -->
    <div id="landingPage" style="display: none; max-width: 800px; margin: 60px auto; padding: 40px 20px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
        <h1 style="font-size: 48px; margin-bottom: 20px;">üéæ Tennis Coordinator</h1>
        <p style="font-size: 20px; color: #666; margin-bottom: 40px; line-height: 1.6;">
            Organize tennis matches, coordinate players, and manage check-ins for your tennis group.
        </p>

        <div style="background: #f5f5f5; padding: 30px; border-radius: 12px; margin-bottom: 40px;">
            <h2 style="font-size: 24px; margin-bottom: 20px;">How It Works</h2>
            <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                <p style="margin-bottom: 15px;">‚úì <strong>Check In</strong> - Select your name, play style, and availability</p>
                <p style="margin-bottom: 15px;">‚úì <strong>Auto-Match</strong> - System organizes doubles, singles, and rotation matches</p>
                <p style="margin-bottom: 15px;">‚úì <strong>Real-Time Sync</strong> - Everyone sees updates instantly</p>
                <p style="margin-bottom: 15px;">‚úì <strong>Weather Forecast</strong> - Check conditions before you play</p>
            </div>
        </div>

        <div style="margin-bottom: 40px;">
            <p style="font-size: 18px; color: #666; margin-bottom: 20px;">
                To access your tennis group, visit your group's unique URL or contact your group admin for the link.
            </p>
        </div>

        <div style="font-size: 14px; color: #999;">
            <p>Site Administrator? <a href="/admin" style="color: #4CAF50; text-decoration: none;">Access Site Admin ‚Üí</a></p>
        </div>
    </div>

    <div class="container" id="appContainer">
        <h1>
            <span>
                <span id="groupNameDisplay">üéæ Tennis Coordinator</span>
                <br><small style="font-size: 12px; font-weight: 400; opacity: 0.8;">
                    <span id="groupSubtitle">Tennis Coordinator</span>
                </small>
            </span>
            <div style="display: flex; gap: 8px;">
                <button class="settings-icon" onclick="window.open('tennis-coordinator-help.md', '_blank')" title="Help">‚ùì</button>
                <button class="settings-icon" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
            </div>
        </h1>
        
        <div class="date-selector">
            <h2>Select Date</h2>
            <div class="date-grid" id="dateGrid"></div>
        </div>
        
        <div id="weatherWidget"></div>
        
        <div class="input-group">
            <select id="nameSelect" onchange="handleNameSelect()">
                <option value="">Select your name...</option>
            </select>
            <button class="edit-prefs-btn" onclick="openPreferencesModal()">‚öôÔ∏è</button>
            <button onclick="checkIn()">Check In</button>
        </div>
        
        <!-- Collapsible form fields -->
        <div class="collapsible-form" id="checkInFormFields">
            <div class="guest-form" id="guestForm">
                <input
                    type="text"
                    id="guestNameInput"
                    placeholder="Guest's name"
                >
                <select id="addedBySelect">
                    <option value="">Who is adding this guest?</option>
                </select>
            </div>

            <div class="preference-group">
                <button class="preference-btn singles" id="singlesBtn" onclick="selectPreference('singles')">
                    Singles Only
                </button>
                <button class="preference-btn selected" id="bothBtn" onclick="selectPreference('both')">
                    Either
                </button>
                <button class="preference-btn doubles" id="doublesBtn" onclick="selectPreference('doubles')">
                    Doubles Only
                </button>
            </div>

            <div class="time-slots">
                <h3>Available Time (optional)</h3>
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <input
                        type="time"
                        id="startTimeInput"
                        style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                        placeholder="Start"
                    >
                    <span style="color: #666;">to</span>
                    <input
                        type="time"
                        id="endTimeInput"
                        style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                        placeholder="End"
                    >
                    <button
                        onclick="clearTimeInputs()"
                        style="padding: 10px 12px; background: #f5f5f5; color: #666; font-size: 13px;"
                    >
                        Clear
                    </button>
                </div>
                <div style="font-size: 12px; color: #999; margin-top: 6px;">
                    Leave blank if available any time
                </div>
            </div>

            <div style="margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 14px;">
                    <input
                        type="checkbox"
                        id="allowRotationCheckbox"
                        checked
                        style="width: 18px; height: 18px; cursor: pointer; margin-right: 4px;"
                    >
                    <span>Willing to play 3-player rotation (1v1 or 1v2 format)</span>
                </label>
                <div style="font-size: 12px; color: #666; margin-top: 4px; margin-left: 26px;">
                    If unchecked, you'll only be placed in doubles or singles matches
                </div>
            </div>
        </div>

        <div class="checkins">
            <h2>Check-ins (<span id="count">0</span>)</h2>
            <div id="checkinList"></div>
        </div>
        
        <div class="matches" id="matches"></div>

        <button class="reset-btn" onclick="resetAll()">üîí Reset All (Admin Only)</button>
    </div>
    
    <!-- Preferences Modal -->
    <div class="modal" id="preferencesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Singles Match Preferences</h2>
                <button class="close-btn" onclick="closePreferencesModal()">√ó</button>
            </div>

            <div class="pref-section">
                <h3>Exclude Players</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">You won't be paired with these players in singles matches</p>
                <div class="pref-input-group">
                    <input
                        type="text"
                        id="excludeInput"
                        placeholder="Enter name"
                        onkeypress="if(event.key==='Enter') addExclude()"
                    >
                    <button onclick="addExclude()">Add</button>
                </div>
                <div class="pref-list" id="excludeList"></div>
            </div>

            <button onclick="savePreferences()" style="width: 100%;">Save Preferences</button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Admin Settings</h2>
                <p style="font-size: 12px; color: #666; margin: 4px 0 0 0;">Managing: <strong id="adminGroupName">Current Group</strong></p>
                <button class="close-btn" onclick="closeSettingsModal()">√ó</button>
            </div>
            
            <div class="pref-section">
                <h3>Core Members</h3>
                <div class="member-list" id="memberList"></div>
                <div class="add-member-input">
                    <input 
                        type="text" 
                        id="newMemberInput" 
                        placeholder="New member name"
                        onkeypress="if(event.key==='Enter') addCoreMember()"
                    >
                    <button onclick="addCoreMember()">Add</button>
                </div>
            </div>
            
            <div class="pref-section">
                <h3>Admin PIN</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Required to access admin settings</p>
                <input
                    type="text"
                    id="adminPinInput"
                    value="3250"
                    style="width: 100%; margin-bottom: 12px;"
                >
            </div>

            <div class="pref-section">
                <h3>Group PIN</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Share this PIN with all group members to access the app</p>
                <input
                    type="text"
                    id="groupPinInput"
                    value="14675"
                    style="width: 100%; margin-bottom: 12px;"
                >
            </div>

            <div class="pref-section">
                <h3>Weather Location</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Set the location for weather forecasts</p>
                <input
                    type="text"
                    id="locationNameInput"
                    placeholder="Location name (e.g., Los Gatos, CA)"
                    style="width: 100%; margin-bottom: 8px;"
                >
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input
                        type="number"
                        step="0.0001"
                        id="locationLatInput"
                        placeholder="Latitude"
                        style="flex: 1;"
                    >
                    <input
                        type="number"
                        step="0.0001"
                        id="locationLonInput"
                        placeholder="Longitude"
                        style="flex: 1;"
                    >
                </div>
                <p style="font-size: 11px; color: #999; margin-bottom: 12px;">Tip: Use <a href="https://www.latlong.net/" target="_blank" style="color: #4CAF50;">latlong.net</a> to find coordinates</p>
                <button onclick="saveSettings()" style="width: 100%;">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Site Admin Modal -->
    <div id="siteAdminModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Site Admin - Manage Groups</h2>
                <button class="close-btn" onclick="closeSiteAdmin()">√ó</button>
            </div>

            <button onclick="showCreateGroupForm()" style="margin-bottom: 20px; background: #4CAF50;">‚ûï Create New Group</button>

            <div id="groupsTable" style="margin-bottom: 20px;">
                <!-- Groups table will be rendered here -->
            </div>

            <!-- Create/Edit Group Form -->
            <div id="groupForm" style="display: none; border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h3 id="groupFormTitle">Create New Group</h3>
                <input type="hidden" id="editingGroupId">

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Group Name:</label>
                    <input type="text" id="formGroupName" placeholder="e.g., Tue/Thu+ Midday Doubles" style="width: 100%;">
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">URL Short Code:</label>
                    <input type="text" id="formShortCode" placeholder="e.g., ttmd" style="width: 100%;">
                    <small style="color: #666;">Short code for URL (e.g., /ttmd)</small>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Group PIN:</label>
                        <input type="text" id="formGroupPin" placeholder="e.g., 14675" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Admin PIN:</label>
                        <input type="text" id="formAdminPin" placeholder="e.g., 3250" style="width: 100%;">
                    </div>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Weather Location Name:</label>
                    <input type="text" id="formLocationName" placeholder="e.g., Los Gatos, CA" style="width: 100%;">
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Latitude:</label>
                        <input type="number" step="0.0001" id="formLocationLat" placeholder="e.g., 37.2358" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Longitude:</label>
                        <input type="number" step="0.0001" id="formLocationLon" placeholder="e.g., -121.9623" style="width: 100%;">
                    </div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button onclick="saveGroup()" style="flex: 1; background: #4CAF50;">üíæ Save Group</button>
                    <button onclick="cancelGroupForm()" style="flex: 1; background: #999;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Selector Modal -->
    <div id="groupSelectorModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="margin-top: 0;">Select Tennis Group</h2>
            <div id="groupsList" style="margin-bottom: 20px;">
                <!-- Groups will be loaded here -->
            </div>
            <div id="groupPinSection" style="display: none;">
                <p style="font-size: 14px; color: #666; margin-bottom: 8px;">Enter PIN for <strong id="selectedGroupName"></strong>:</p>
                <input
                    type="password"
                    id="groupPinEntry"
                    placeholder="Enter group PIN"
                    style="width: 100%; margin-bottom: 12px;"
                    onkeypress="if(event.key === 'Enter') confirmGroupSelection()"
                >
                <div style="display: flex; gap: 8px;">
                    <button onclick="confirmGroupSelection()" style="flex: 1;">Access Group</button>
                    <button onclick="cancelGroupSelection()" style="flex: 1; background-color: #999;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCr-Ej5jeuV3kdvquu2W_R0ffSrUW0OUcQ",
            authDomain: "tennis-coordinator-43f53.firebaseapp.com",
            databaseURL: "https://tennis-coordinator-43f53-default-rtdb.firebaseio.com",
            projectId: "tennis-coordinator-43f53",
            storageBucket: "tennis-coordinator-43f53.firebasestorage.app",
            messagingSenderId: "665148711646",
            appId: "1:665148711646:web:66d14722800a12f5a3184f",
            measurementId: "G-J0KVB2Q93W"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase not configured. Please add your Firebase configuration.');
        }

        // Current selected group (determined by URL path)
        let currentGroupId = null;
        let currentGroupName = '';
        let availableGroups = {};

        // Short code to group ID mapping
        async function resolveShortCode(code) {
            // Load all groups and find matching short code
            const groupsSnapshot = await firebaseRef.groups().once('value');
            const groups = groupsSnapshot.val() || {};

            for (const [groupId, groupData] of Object.entries(groups)) {
                if (groupData.settings && groupData.settings.shortCode === code) {
                    return groupId;
                }
            }
            return null;
        }

        // Parse group from URL path
        async function getGroupIdFromUrl() {
            // Check if we were redirected from 404.html
            const redirect = sessionStorage.getItem('redirect');
            if (redirect) {
                sessionStorage.removeItem('redirect');
                const groupPath = redirect.replace(/^\/+|\/+$/g, '');

                // Handle admin route from redirect
                if (groupPath === 'admin') {
                    history.replaceState(null, '', redirect);
                    return 'admin';
                }

                if (groupPath && groupPath !== 'index.html') {
                    // Update browser URL without page reload
                    history.replaceState(null, '', redirect);

                    // Check if it's a short code
                    const resolvedGroupId = await resolveShortCode(groupPath);
                    return resolvedGroupId || groupPath;
                }
            }

            const path = window.location.pathname;
            // Remove leading/trailing slashes and get the group ID
            const groupPath = path.replace(/^\/+|\/+$/g, '');

            // Special routes
            if (groupPath === 'admin') {
                return 'admin'; // Special case for site admin
            }

            // If empty or index.html, return null (will show group selector)
            if (!groupPath || groupPath === 'index.html') {
                return null;
            }

            // Check if it's a short code first
            const resolvedGroupId = await resolveShortCode(groupPath);
            return resolvedGroupId || groupPath;
        }

        // Firebase helper functions (group-scoped)
        const firebaseRef = {
            groups: () => db.ref('groups'),
            group: (groupId) => db.ref(`groups/${groupId}`),
            checkins: (groupId) => db.ref(`groups/${groupId}/checkins`),
            settings: (groupId) => db.ref(`groups/${groupId}/settings`),
            userPreferences: () => db.ref('userPreferences'),
            siteSettings: () => db.ref('siteSettings')
        };

        let allCheckins = {};
        let userPreferences = {};
        let coreMembers = [];
        let groupPin = '14675';
        let adminPin = '3250';
        let selectedDate = null;
        let selectedPreference = 'both';
        let currentEditingUser = null;
        let tempInclude = [];
        let tempExclude = [];
        let selectedName = '';
        let isGuest = false;
        let addedBy = '';

        // Weather location (defaults to Los Gatos, CA)
        let weatherLocation = {
            lat: 37.2358,
            lon: -121.9623,
            name: 'Los Gatos, CA'
        };

        let weatherCache = {};

        // Firebase Data Loading and Sync
        async function loadAvailableGroups() {
            try {
                // Always check for old data to migrate first
                await migrateOldData();

                const groupsSnapshot = await firebaseRef.groups().once('value');
                availableGroups = groupsSnapshot.val() || {};

                console.log('Current groups in Firebase:', availableGroups);

                // If no groups exist, create default groups
                if (Object.keys(availableGroups).length === 0) {
                    console.log('No groups found, initializing defaults...');
                    await initializeDefaultGroups();
                    const groupsSnapshot2 = await firebaseRef.groups().once('value');
                    availableGroups = groupsSnapshot2.val() || {};
                    console.log('Groups after initialization:', availableGroups);
                }

                return true;
            } catch (error) {
                console.error('Error loading groups:', error);
                return false;
            }
        }

        async function loadFirebaseData(groupId) {
            try {
                if (!groupId) {
                    console.log('No group ID provided');
                    return false;
                }

                // Load settings for the group
                const settingsSnapshot = await firebaseRef.settings(groupId).once('value');
                const settings = settingsSnapshot.val() || {};

                currentGroupName = settings.groupName || 'Unknown Group';
                coreMembers = settings.members || [];
                groupPin = settings.groupPin || '14675';
                adminPin = settings.adminPin || '3250';

                // Load weather location (default to Los Gatos if not set)
                if (settings.location) {
                    weatherLocation = settings.location;
                } else {
                    weatherLocation = {
                        lat: 37.2358,
                        lon: -121.9623,
                        name: 'Los Gatos, CA'
                    };
                }

                // Load check-ins for the group
                const checkinsSnapshot = await firebaseRef.checkins(groupId).once('value');
                allCheckins = checkinsSnapshot.val() || {};

                // Load user preferences (shared across all groups)
                const prefsSnapshot = await firebaseRef.userPreferences().once('value');
                userPreferences = prefsSnapshot.val() || {};

                console.log(`Firebase data loaded for group: ${currentGroupName}`);
                return true;
            } catch (error) {
                console.error('Error loading Firebase data:', error);
                return false;
            }
        }

        async function migrateOldData() {
            // Check if migration has already been completed
            const migrationFlagSnapshot = await db.ref('_migrationCompleted').once('value');
            if (migrationFlagSnapshot.val() === true) {
                console.log('Migration already completed, skipping');
                return;
            }

            // Check if old data structure exists
            const oldSettingsSnapshot = await db.ref('settings').once('value');
            const oldSettings = oldSettingsSnapshot.val();

            console.log('Checking for old data at /settings:', oldSettings);

            if (oldSettings && oldSettings.coreMembers) {
                console.log('Found old data structure, migrating members:', oldSettings.coreMembers);

                // Migrate to new structure for Tue/Thu+ group
                await firebaseRef.settings('tue-thu-midday-doubles').update({
                    groupName: 'Tue/Thu+ Midday Doubles',
                    groupPin: oldSettings.groupPin || '14675',
                    adminPin: oldSettings.adminPin || '3250',
                    members: oldSettings.coreMembers || []
                });

                // Migrate old check-ins
                const oldCheckinsSnapshot = await db.ref('checkins').once('value');
                const oldCheckins = oldCheckinsSnapshot.val();
                if (oldCheckins) {
                    await firebaseRef.checkins('tue-thu-midday-doubles').set(oldCheckins);
                }

                // Set migration flag so this doesn't run again
                await db.ref('_migrationCompleted').set(true);

                console.log('Migration completed successfully');
            } else {
                // No old data exists, mark migration as complete
                await db.ref('_migrationCompleted').set(true);
                console.log('No old data found to migrate. Marking migration as complete.');
            }
        }

        async function initializeDefaultGroups() {
            // Check if groups already exist
            const groupsSnapshot = await firebaseRef.groups().once('value');
            const existingGroups = groupsSnapshot.val() || {};

            // Only create groups that don't exist yet
            if (!existingGroups['tue-thu-midday-doubles']) {
                await firebaseRef.group('tue-thu-midday-doubles').set({
                    settings: {
                        groupName: 'Tue/Thu+ Midday Doubles',
                        shortCode: 'ttmd',
                        groupPin: '14675',
                        adminPin: '3250',
                        members: [],
                        location: {
                            name: 'Los Gatos, CA',
                            lat: 37.2358,
                            lon: -121.9623
                        }
                    },
                    checkins: {}
                });
                console.log('Initialized tue-thu-midday-doubles group');
            }

            if (!existingGroups['singles-tuneup-tourny']) {
                await firebaseRef.group('singles-tuneup-tourny').set({
                    settings: {
                        groupName: '18+ Singles Tune-up Tourny',
                        shortCode: 'stt',
                        groupPin: '8888',
                        adminPin: '9999',
                        members: [],
                        location: {
                            name: 'Los Gatos, CA',
                            lat: 37.2358,
                            lon: -121.9623
                        }
                    },
                    checkins: {}
                });
                console.log('Initialized singles-tuneup-tourny group');
            }
        }

        let activeListeners = {
            settings: null,
            checkins: null,
            preferences: null
        };

        function setupFirebaseListeners(groupId) {
            if (!groupId) return;

            // Clean up old listeners if they exist
            if (activeListeners.settings) {
                activeListeners.settings.off();
            }
            if (activeListeners.checkins) {
                activeListeners.checkins.off();
            }
            if (activeListeners.preferences) {
                activeListeners.preferences.off();
            }

            // Listen for changes to settings for current group
            activeListeners.settings = firebaseRef.settings(groupId);
            activeListeners.settings.on('value', (snapshot) => {
                const settings = snapshot.val() || {};
                currentGroupName = settings.groupName || 'Unknown Group';
                coreMembers = settings.members || [];
                groupPin = settings.groupPin || '14675';
                adminPin = settings.adminPin || '3250';
                populateNameDropdown();
                updateGroupDisplay();
            });

            // Listen for changes to check-ins for current group
            activeListeners.checkins = firebaseRef.checkins(groupId);
            activeListeners.checkins.on('value', (snapshot) => {
                try {
                    console.log('Firebase check-ins updated:', snapshot.val());
                    allCheckins = snapshot.val() || {};
                    console.log('Listener calling initDates()');
                    initDates();
                    console.log('Listener calling render()');
                    render();
                    console.log('Listener render() completed');
                } catch (error) {
                    console.error('Error in Firebase listener:', error);
                }
            });

            // Listen for changes to user preferences (shared)
            activeListeners.preferences = firebaseRef.userPreferences();
            activeListeners.preferences.on('value', (snapshot) => {
                userPreferences = snapshot.val() || {};
            });
        }

        let isSaving = false;

        async function saveFirebaseCheckins() {
            console.log('saveFirebaseCheckins called, currentGroupId:', currentGroupId);
            if (!currentGroupId) {
                console.error('Cannot save: currentGroupId is null');
                return;
            }
            try {
                isSaving = true;
                const checkinsForDate = allCheckins[selectedDate] || [];
                const savePath = `groups/${currentGroupId}/checkins/${selectedDate}`;

                console.log('=== SAVE DEBUG ===');
                console.log('Selected date:', selectedDate);
                console.log('Check-ins to save:', checkinsForDate);
                console.log('Full save path:', savePath);
                console.log('All checkins object:', allCheckins);
                console.log('=================');

                // Update only the specific date to avoid race conditions
                const ref = firebaseRef.checkins(currentGroupId).child(selectedDate);
                console.log('Firebase ref path:', ref.toString());
                await ref.set(checkinsForDate);

                console.log('Check-ins saved successfully, verifying...');

                // Verify the save by reading back
                const snapshot = await firebaseRef.checkins(currentGroupId).child(selectedDate).once('value');
                const savedData = snapshot.val();
                console.log('Verification read from path:', savePath);
                console.log('Verification data:', savedData);

                if (!savedData || savedData.length !== checkinsForDate.length) {
                    throw new Error('Data verification failed - saved data does not match');
                }

                console.log('Save verified successfully');
            } catch (error) {
                console.error('Error saving check-ins:', error);
                showToast('Error saving to database', 'error');
                throw error;
            } finally {
                isSaving = false;
            }
        }

        async function saveFirebaseSettings() {
            if (!currentGroupId) return;
            try {
                await firebaseRef.settings(currentGroupId).set({
                    groupName: currentGroupName,
                    members: coreMembers,
                    groupPin: groupPin,
                    adminPin: adminPin,
                    location: weatherLocation
                });
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        async function saveFirebasePreferences() {
            try {
                await firebaseRef.userPreferences().set(userPreferences);
            } catch (error) {
                console.error('Error saving preferences:', error);
            }
        }

        // PIN Authentication for specific group
        function checkAuth(groupId, groupName, correctPin) {
            const authKey = `tennisAuth_${groupId}`;
            const isAuth = sessionStorage.getItem(authKey);

            if (!isAuth) {
                const pin = prompt(`Enter PIN for ${groupName}:`);
                if (pin === null || pin === '') {
                    // User clicked cancel - deny access
                    return false;
                } else if (pin === correctPin) {
                    sessionStorage.setItem(authKey, 'true');
                    return true;
                } else {
                    alert('Invalid PIN. Try again.');
                    return checkAuth(groupId, groupName, correctPin); // Try again
                }
            }
            return true;
        }

        // Toast Notification System
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '‚úì' : '‚úï';
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300); // Wait for animation to complete
            }, 3000);
        }

        function normalizeName(name) {
            return name.trim().toLowerCase();
        }
        
        function handleNameSelect() {
            const select = document.getElementById('nameSelect');
            const value = select.value;
            const guestForm = document.getElementById('guestForm');
            const formFields = document.getElementById('checkInFormFields');

            if (value === '__GUEST__') {
                isGuest = true;
                selectedName = '';
                guestForm.classList.add('active');
                populateAddedByDropdown();
                formFields.classList.add('expanded');
            } else if (value !== '') {
                isGuest = false;
                selectedName = value;
                addedBy = '';
                guestForm.classList.remove('active');
                formFields.classList.add('expanded');
            } else {
                // No name selected - collapse form
                formFields.classList.remove('expanded');
                guestForm.classList.remove('active');
            }
        }
        
        function populateAddedByDropdown() {
            const select = document.getElementById('addedBySelect');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));
            select.innerHTML = '<option value="">Who is adding this guest?</option>' +
                sortedMembers.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        function populateNameDropdown() {
            const select = document.getElementById('nameSelect');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));

            // Get remembered user name for this group
            const rememberedName = currentGroupId ? localStorage.getItem(`tennisUserName_${currentGroupId}`) : null;

            select.innerHTML = '<option value="">Select your name...</option>' +
                sortedMembers.map(name => `<option value="${name}" ${name === rememberedName ? 'selected' : ''}>${name}</option>`).join('') +
                '<option value="__GUEST__">+ Add Guest</option>';

            // If we pre-selected a name, update the selectedName variable
            if (rememberedName && sortedMembers.includes(rememberedName)) {
                selectedName = rememberedName;
            }
        }
        
        function openSettingsModal() {
            const pin = prompt('Enter admin PIN:');
            if (pin === null) {
                return; // User cancelled
            }
            if (pin !== adminPin) {
                alert('Invalid admin PIN - Only admin can access admin settings');
                return;
            }

            renderMemberList();
            document.getElementById('adminPinInput').value = adminPin;
            document.getElementById('groupPinInput').value = groupPin;
            document.getElementById('adminGroupName').textContent = currentGroupName;
            document.getElementById('locationNameInput').value = weatherLocation.name;
            document.getElementById('locationLatInput').value = weatherLocation.lat;
            document.getElementById('locationLonInput').value = weatherLocation.lon;
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Site Admin Functions
        async function openSiteAdmin() {
            // Check site admin PIN
            const siteSettingsSnapshot = await firebaseRef.siteSettings().once('value');
            const siteSettings = siteSettingsSnapshot.val() || {};
            const siteAdminPin = siteSettings.siteAdminPin || 'Ilovetennis';

            // Initialize site admin PIN if doesn't exist
            if (!siteSettings.siteAdminPin) {
                await firebaseRef.siteSettings().set({ siteAdminPin: 'Ilovetennis' });
            }

            const pin = prompt('Enter Site Admin PIN:');
            if (pin === null) {
                window.location.href = '/';
                return;
            }

            if (pin !== siteAdminPin) {
                alert('Invalid Site Admin PIN');
                window.location.href = '/';
                return;
            }

            // Show site admin modal
            document.getElementById('siteAdminModal').classList.add('active');
            await renderGroupsTable();
        }

        function closeSiteAdmin() {
            document.getElementById('siteAdminModal').classList.remove('active');
            window.location.href = '/';
        }

        async function renderGroupsTable() {
            const groupsSnapshot = await firebaseRef.groups().once('value');
            const groups = groupsSnapshot.val() || {};

            const table = document.getElementById('groupsTable');

            if (Object.keys(groups).length === 0) {
                table.innerHTML = '<p style="color: #666;">No groups yet. Create one!</p>';
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f5f5f5;"><th style="padding: 12px; text-align: left;">Group Name</th><th>Short Code</th><th>Group PIN</th><th>Admin PIN</th><th>Actions</th></tr></thead><tbody>';

            for (const [groupId, groupData] of Object.entries(groups)) {
                const settings = groupData.settings || {};
                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;"><strong>${settings.groupName || groupId}</strong></td>
                        <td style="padding: 12px; text-align: center;"><code>${settings.shortCode || '-'}</code></td>
                        <td style="padding: 12px; text-align: center;">${settings.groupPin || '-'}</td>
                        <td style="padding: 12px; text-align: center;">${settings.adminPin || '-'}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="editGroup('${groupId}')" style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">‚úèÔ∏è Edit</button>
                            <button onclick="cloneGroup('${groupId}')" style="padding: 4px 8px; font-size: 12px; margin-right: 4px; background: #2196F3;">üìã Clone</button>
                            <button onclick="deleteGroup('${groupId}')" style="padding: 4px 8px; font-size: 12px; background: #f44336;">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            table.innerHTML = html;
        }

        function showCreateGroupForm() {
            document.getElementById('groupFormTitle').textContent = 'Create New Group';
            document.getElementById('editingGroupId').value = '';
            document.getElementById('formGroupName').value = '';
            document.getElementById('formShortCode').value = '';
            document.getElementById('formGroupPin').value = '';
            document.getElementById('formAdminPin').value = '';
            document.getElementById('formLocationName').value = 'Los Gatos, CA';
            document.getElementById('formLocationLat').value = '37.2358';
            document.getElementById('formLocationLon').value = '-121.9623';
            document.getElementById('groupForm').style.display = 'block';
        }

        async function editGroup(groupId) {
            const groupSnapshot = await firebaseRef.group(groupId).once('value');
            const groupData = groupSnapshot.val();
            const settings = groupData.settings || {};

            document.getElementById('groupFormTitle').textContent = 'Edit Group';
            document.getElementById('editingGroupId').value = groupId;
            document.getElementById('formGroupName').value = settings.groupName || '';
            document.getElementById('formShortCode').value = settings.shortCode || '';
            document.getElementById('formGroupPin').value = settings.groupPin || '';
            document.getElementById('formAdminPin').value = settings.adminPin || '';
            document.getElementById('formLocationName').value = settings.location?.name || 'Los Gatos, CA';
            document.getElementById('formLocationLat').value = settings.location?.lat || 37.2358;
            document.getElementById('formLocationLon').value = settings.location?.lon || -121.9623;
            document.getElementById('groupForm').style.display = 'block';
        }

        async function cloneGroup(sourceGroupId) {
            const groupSnapshot = await firebaseRef.group(sourceGroupId).once('value');
            const groupData = groupSnapshot.val();
            const settings = groupData.settings || {};

            document.getElementById('groupFormTitle').textContent = 'Clone Group';
            document.getElementById('editingGroupId').value = '';
            document.getElementById('formGroupName').value = (settings.groupName || '') + ' (Copy)';
            document.getElementById('formShortCode').value = '';
            document.getElementById('formGroupPin').value = settings.groupPin || '';
            document.getElementById('formAdminPin').value = settings.adminPin || '';
            document.getElementById('formLocationName').value = settings.location?.name || 'Los Gatos, CA';
            document.getElementById('formLocationLat').value = settings.location?.lat || 37.2358;
            document.getElementById('formLocationLon').value = settings.location?.lon || -121.9623;
            document.getElementById('groupForm').style.display = 'block';
        }

        async function saveGroup() {
            const editingGroupId = document.getElementById('editingGroupId').value;
            const groupName = document.getElementById('formGroupName').value.trim();
            const shortCode = document.getElementById('formShortCode').value.trim();
            const groupPin = document.getElementById('formGroupPin').value.trim();
            const adminPin = document.getElementById('formAdminPin').value.trim();
            const locationName = document.getElementById('formLocationName').value.trim();
            const locationLat = parseFloat(document.getElementById('formLocationLat').value);
            const locationLon = parseFloat(document.getElementById('formLocationLon').value);

            if (!groupName || !shortCode || !groupPin || !adminPin) {
                alert('Please fill in all required fields');
                return;
            }

            // Create slug from group name if editing, or use shortcode
            const groupId = editingGroupId || shortCode.toLowerCase().replace(/[^a-z0-9]+/g, '-');

            const groupData = {
                settings: {
                    groupName,
                    shortCode,
                    groupPin,
                    adminPin,
                    members: [],
                    location: {
                        name: locationName,
                        lat: locationLat,
                        lon: locationLon
                    }
                },
                checkins: {}
            };

            await firebaseRef.group(groupId).set(groupData);

            showToast(`Group "${groupName}" saved successfully!`, 'success');
            cancelGroupForm();
            await renderGroupsTable();

            // Reload available groups
            await loadAvailableGroups();
        }

        async function deleteGroup(groupId) {
            const groupSnapshot = await firebaseRef.group(groupId).once('value');
            const groupData = groupSnapshot.val();
            const groupName = groupData?.settings?.groupName || groupId;

            if (!confirm(`Are you sure you want to delete "${groupName}"? This cannot be undone.`)) {
                return;
            }

            await firebaseRef.group(groupId).remove();
            showToast(`Group "${groupName}" deleted`, 'success');
            await renderGroupsTable();
            await loadAvailableGroups();
        }

        function cancelGroupForm() {
            document.getElementById('groupForm').style.display = 'none';
        }

        // Group Selection Functions
        let selectedGroupIdTemp = null;

        async function openGroupSelector() {
            // Load available groups
            const groupsSnapshot = await firebaseRef.groups().once('value');
            availableGroups = groupsSnapshot.val() || {};

            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';

            Object.keys(availableGroups).forEach(groupId => {
                const groupSettings = availableGroups[groupId].settings || {};
                const groupName = groupSettings.groupName || groupId;

                const groupButton = document.createElement('button');
                groupButton.textContent = groupName;
                groupButton.style.cssText = 'width: 100%; margin-bottom: 8px; padding: 12px; font-size: 16px;';
                groupButton.onclick = () => promptForGroupPin(groupId, groupName);
                groupsList.appendChild(groupButton);
            });

            document.getElementById('groupPinSection').style.display = 'none';
            document.getElementById('groupSelectorModal').classList.add('active');
        }

        function promptForGroupPin(groupId, groupName) {
            selectedGroupIdTemp = groupId;
            document.getElementById('selectedGroupName').textContent = groupName;
            document.getElementById('groupsList').style.display = 'none';
            document.getElementById('groupPinSection').style.display = 'block';
            document.getElementById('groupPinEntry').value = '';
            document.getElementById('groupPinEntry').focus();
        }

        async function confirmGroupSelection() {
            const enteredPin = document.getElementById('groupPinEntry').value.trim();

            if (!selectedGroupIdTemp || !availableGroups[selectedGroupIdTemp]) {
                alert('Invalid group selection');
                return;
            }

            const groupSettings = availableGroups[selectedGroupIdTemp].settings || {};
            const correctPin = groupSettings.groupPin || '';

            if (enteredPin !== correctPin) {
                alert('Invalid PIN for this group');
                return;
            }

            // Store auth in session and navigate to group URL
            const authKey = `tennisAuth_${selectedGroupIdTemp}`;
            sessionStorage.setItem(authKey, 'true');

            // Navigate to the group's URL
            window.location.href = `/${selectedGroupIdTemp}`;
        }

        function cancelGroupSelection() {
            selectedGroupIdTemp = null;
            document.getElementById('groupsList').style.display = 'block';
            document.getElementById('groupPinSection').style.display = 'none';
        }

        function closeGroupSelector() {
            document.getElementById('groupSelectorModal').classList.remove('active');
            selectedGroupIdTemp = null;
        }

        async function selectGroup(groupId) {
            currentGroupId = groupId;

            // Load group settings
            const groupSettings = availableGroups[groupId]?.settings || {};
            currentGroupName = groupSettings.groupName || groupId;

            // Update global settings for this group
            coreMembers = groupSettings.members || [];
            groupPin = groupSettings.groupPin || '';
            adminPin = groupSettings.adminPin || '';

            updateGroupDisplay();
            await loadFirebaseData(currentGroupId);
            setupFirebaseListeners(currentGroupId);
            render();
        }

        function updateGroupDisplay() {
            document.getElementById('groupNameDisplay').textContent = currentGroupName;
            document.getElementById('groupSubtitle').textContent = 'Tennis Coordinator';
        }

        function renderMemberList() {
            const list = document.getElementById('memberList');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));
            list.innerHTML = sortedMembers.map((name) => `
                <div class="member-item">
                    <span>${name}</span>
                    <button onclick="removeCoreMember('${name.replace(/'/g, "\\'")}')">Remove</button>
                </div>
            `).join('');
        }
        
        function addCoreMember() {
            const input = document.getElementById('newMemberInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            if (coreMembers.some(m => normalizeName(m) === normalizeName(name))) {
                alert('Member already exists');
                input.value = '';
                return;
            }
            
            coreMembers.push(name);
            input.value = '';
            renderMemberList();
        }
        
        function removeCoreMember(name) {
            if (confirm(`Remove ${name} from core members?`)) {
                const index = coreMembers.indexOf(name);
                if (index > -1) {
                    coreMembers.splice(index, 1);
                }
                renderMemberList();
            }
        }
        
        function saveSettings() {
            const newGroupPin = document.getElementById('groupPinInput').value.trim();
            const newAdminPin = document.getElementById('adminPinInput').value.trim();
            const locationName = document.getElementById('locationNameInput').value.trim();
            const locationLat = parseFloat(document.getElementById('locationLatInput').value);
            const locationLon = parseFloat(document.getElementById('locationLonInput').value);

            if (!newGroupPin || !newAdminPin) {
                alert('PINs cannot be empty');
                return;
            }

            // Validate location if provided
            if (locationName && (isNaN(locationLat) || isNaN(locationLon))) {
                alert('Please enter valid latitude and longitude coordinates');
                return;
            }

            groupPin = newGroupPin;
            adminPin = newAdminPin;

            // Update weather location if provided
            if (locationName && !isNaN(locationLat) && !isNaN(locationLon)) {
                weatherLocation = {
                    name: locationName,
                    lat: locationLat,
                    lon: locationLon
                };
            }

            saveFirebaseSettings();

            showToast('Settings saved! Changes will sync to all users.', 'success');
            closeSettingsModal();
            populateNameDropdown();
        }
        
        async function fetchWeather(dateStr) {
            // Check cache first
            if (weatherCache[dateStr]) {
                return weatherCache[dateStr];
            }
            
            const widget = document.getElementById('weatherWidget');
            widget.innerHTML = '<div class="weather-loading">Loading weather...</div>';
            
            try {
                // Using Open-Meteo API (free, no key needed)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${weatherLocation.lat}&longitude=${weatherLocation.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode&temperature_unit=fahrenheit&timezone=America/Los_Angeles&forecast_days=14`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.daily || !data.daily.time) {
                    throw new Error('Invalid weather data format');
                }
                
                // Find the index for our selected date
                const dateIndex = data.daily.time.indexOf(dateStr);
                
                if (dateIndex === -1) {
                    throw new Error('Weather data not available for this date');
                }
                
                const weatherData = {
                    tempMax: Math.round(data.daily.temperature_2m_max[dateIndex]),
                    tempMin: Math.round(data.daily.temperature_2m_min[dateIndex]),
                    precipProb: data.daily.precipitation_probability_max[dateIndex] || 0,
                    weatherCode: data.daily.weathercode[dateIndex]
                };
                
                weatherCache[dateStr] = weatherData;
                return weatherData;
                
            } catch (error) {
                console.error('Weather fetch error:', error);
                widget.innerHTML = `<div class="weather-error">Unable to load weather (${error.message})</div>`;
                return null;
            }
        }
        
        function getWeatherDescription(code) {
            const weatherCodes = {
                0: '‚òÄÔ∏è Clear sky',
                1: 'üå§Ô∏è Mainly clear',
                2: '‚õÖ Partly cloudy',
                3: '‚òÅÔ∏è Overcast',
                45: 'üå´Ô∏è Foggy',
                48: 'üå´Ô∏è Foggy',
                51: 'üå¶Ô∏è Light drizzle',
                53: 'üå¶Ô∏è Drizzle',
                55: 'üåßÔ∏è Heavy drizzle',
                61: 'üåßÔ∏è Light rain',
                63: 'üåßÔ∏è Rain',
                65: 'üåßÔ∏è Heavy rain',
                71: 'üå®Ô∏è Light snow',
                73: 'üå®Ô∏è Snow',
                75: 'üå®Ô∏è Heavy snow',
                77: 'üå®Ô∏è Snow grains',
                80: 'üå¶Ô∏è Rain showers',
                81: 'üåßÔ∏è Rain showers',
                82: '‚õàÔ∏è Heavy rain showers',
                85: 'üå®Ô∏è Snow showers',
                86: 'üå®Ô∏è Heavy snow showers',
                95: '‚õàÔ∏è Thunderstorm',
                96: '‚õàÔ∏è Thunderstorm with hail',
                99: '‚õàÔ∏è Severe thunderstorm'
            };
            
            return weatherCodes[code] || 'üå°Ô∏è Weather';
        }
        
        async function displayWeather() {
            const widget = document.getElementById('weatherWidget');
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const daysFromToday = Math.floor((dateObj - today) / (1000 * 60 * 60 * 24));
            
            // Only show weather for next 14 days (API limitation)
            if (daysFromToday < 0 || daysFromToday > 13) {
                widget.innerHTML = '';
                return;
            }
            
            const weather = await fetchWeather(selectedDate);
            
            if (!weather) return;
            
            const dateDisplay = dateObj.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
            
            widget.innerHTML = `
                <div class="weather-widget">
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <h3>${weatherLocation.name}</h3>
                        <div class="weather-desc">${getWeatherDescription(weather.weatherCode)}</div>
                    </div>
                    <div class="weather-main">
                        <div class="weather-temp">${weather.tempMax}¬∞</div>
                        <div class="weather-details">
                            <span>${weather.tempMin}¬∞-${weather.tempMax}¬∞F</span>
                            ${weather.precipProb > 0 ? `<span>üíß${weather.precipProb}%</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function normalizeName(name) {
            return name.trim().toLowerCase();
        }
        
        function initDates() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            console.log('Today is:', today.toISOString().split('T')[0], '(', today, ')');

            if (!selectedDate) {
                selectedDate = today.toISOString().split('T')[0];
            }
            console.log('selectedDate:', selectedDate);

            const dateGrid = document.getElementById('dateGrid');
            const dates = [];

            // Show 30 days (weather only available for first 14)
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                dates.push(date);
            }
            
            dateGrid.innerHTML = dates.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();
                const month = date.toLocaleDateString('en-US', { month: 'short' });
                const checkinCount = (allCheckins[dateStr] || []).length;
                
                return `
                    <button class="date-btn ${dateStr === selectedDate ? 'selected' : ''}" 
                            onclick="selectDate('${dateStr}')">
                        <span class="day-name">${dayName}</span>
                        <span class="day-num">${dayNum}</span>
                        <span class="day-name">${month}</span>
                        ${checkinCount > 0 ? `<span class="checkin-badge">${checkinCount}</span>` : ''}
                    </button>
                `;
            }).join('');
        }
        
        function selectDate(dateStr) {
            selectedDate = dateStr;
            initDates();
            displayWeather();
            render();
        }
        
        function selectPreference(pref) {
            selectedPreference = pref;
            document.querySelectorAll('.preference-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById(pref + 'Btn').classList.add('selected');
        }
        
        function clearTimeInputs() {
            document.getElementById('startTimeInput').value = '';
            document.getElementById('endTimeInput').value = '';
        }
        
        function formatTimeRange(start, end) {
            if (!start && !end) return '';
            
            const format12Hour = (time24) => {
                if (!time24) return '';
                const [hours, minutes] = time24.split(':');
                const h = parseInt(hours);
                const ampm = h >= 12 ? 'PM' : 'AM';
                const h12 = h % 12 || 12;
                return `${h12}:${minutes}${ampm}`;
            };
            
            if (start && end) {
                return `${format12Hour(start)}-${format12Hour(end)}`;
            } else if (start) {
                return `from ${format12Hour(start)}`;
            } else if (end) {
                return `until ${format12Hour(end)}`;
            }
            return '';
        }
        
        function getCurrentCheckins() {
            return allCheckins[selectedDate] || [];
        }
        
        function setCurrentCheckins(checkins) {
            allCheckins[selectedDate] = checkins;
        }
        
        function openPreferencesModal() {
            if (!selectedName && !isGuest) {
                alert('Please select your name first');
                return;
            }
            
            const name = isGuest ? document.getElementById('guestNameInput').value.trim() : selectedName;
            
            if (!name) {
                alert('Please enter a name first');
                return;
            }
            
            currentEditingUser = normalizeName(name);
            const prefs = userPreferences[currentEditingUser] || { include: [], exclude: [] };
            tempInclude = [...prefs.include];
            tempExclude = [...prefs.exclude];
            
            renderPreferencesModal();
            document.getElementById('preferencesModal').classList.add('active');
        }
        
        function closePreferencesModal() {
            document.getElementById('preferencesModal').classList.remove('active');
            currentEditingUser = null;
        }
        
        function addInclude() {
            const input = document.getElementById('includeInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            const normalized = normalizeName(name);
            
            if (normalized === currentEditingUser) {
                alert("You can't add yourself!");
                input.value = '';
                return;
            }
            
            if (tempInclude.includes(normalized)) {
                alert('Already in your include list');
                input.value = '';
                return;
            }
            
            // Remove from exclude if present
            const excludeIdx = tempExclude.indexOf(normalized);
            if (excludeIdx > -1) {
                tempExclude.splice(excludeIdx, 1);
            }
            
            tempInclude.push(normalized);
            input.value = '';
            renderPreferencesModal();
        }
        
        function addExclude() {
            const input = document.getElementById('excludeInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            const normalized = normalizeName(name);
            
            if (normalized === currentEditingUser) {
                alert("You can't add yourself!");
                input.value = '';
                return;
            }
            
            if (tempExclude.includes(normalized)) {
                alert('Already in your exclude list');
                input.value = '';
                return;
            }
            
            // Remove from include if present
            const includeIdx = tempInclude.indexOf(normalized);
            if (includeIdx > -1) {
                tempInclude.splice(includeIdx, 1);
            }
            
            tempExclude.push(normalized);
            input.value = '';
            renderPreferencesModal();
        }
        
        function removeInclude(name) {
            const idx = tempInclude.indexOf(name);
            if (idx > -1) {
                tempInclude.splice(idx, 1);
                renderPreferencesModal();
            }
        }
        
        function removeExclude(name) {
            const idx = tempExclude.indexOf(name);
            if (idx > -1) {
                tempExclude.splice(idx, 1);
                renderPreferencesModal();
            }
        }
        
        function renderPreferencesModal() {
            const excludeList = document.getElementById('excludeList');

            if (tempExclude.length === 0) {
                excludeList.innerHTML = '<div class="pref-summary">No exclusions set</div>';
            } else {
                excludeList.innerHTML = tempExclude.map(name => `
                    <div class="pref-tag exclude">
                        ${name}
                        <button onclick="removeExclude('${name}')">√ó</button>
                    </div>
                `).join('');
            }
        }
        
        function savePreferences() {
            userPreferences[currentEditingUser] = {
                include: tempInclude,
                exclude: tempExclude
            };

            saveFirebasePreferences();
            closePreferencesModal();
        }
        
        function checkIn() {
            let name, guestAddedBy;
            
            if (isGuest) {
                name = document.getElementById('guestNameInput').value.trim();
                guestAddedBy = document.getElementById('addedBySelect').value;
                
                if (!name) {
                    alert('Please enter guest name');
                    return;
                }
                
                if (!guestAddedBy) {
                    alert('Please select who is adding this guest');
                    return;
                }
            } else {
                name = selectedName;
                
                if (!name) {
                    alert('Please select your name');
                    return;
                }
            }
            
            const checkins = getCurrentCheckins();
            const normalized = normalizeName(name);
            
            if (checkins.some(c => normalizeName(c.name) === normalized)) {
                alert('Already checked in for this date!');
                return;
            }
            
            const startTime = document.getElementById('startTimeInput').value;
            const endTime = document.getElementById('endTimeInput').value;
            const allowRotation = document.getElementById('allowRotationCheckbox').checked;

            const checkinData = {
                name: name,
                timestamp: Date.now(),
                playStyle: selectedPreference,
                allowRotation: allowRotation
            };

            if (startTime || endTime) {
                checkinData.timeRange = {
                    start: startTime,
                    end: endTime
                };
            }

            if (isGuest) {
                checkinData.isGuest = true;
                checkinData.addedBy = guestAddedBy;
            }
            
            checkins.push(checkinData);

            setCurrentCheckins(checkins);

            // Remember user's name for next time (if not a guest)
            if (!isGuest && currentGroupId) {
                localStorage.setItem(`tennisUserName_${currentGroupId}`, name);
            }

            // Show success notification
            showToast('‚úì Checked in successfully!', 'success');

            // Reset form
            document.getElementById('nameSelect').value = '';
            document.getElementById('guestNameInput').value = '';
            document.getElementById('addedBySelect').value = '';
            document.getElementById('guestForm').classList.remove('active');
            document.getElementById('checkInFormFields').classList.remove('expanded');
            document.getElementById('allowRotationCheckbox').checked = true;
            clearTimeInputs();
            selectedName = '';
            isGuest = false;

            saveAndRender();
        }
        
        function removeCheckIn(index) {
            const checkins = getCurrentCheckins();
            const person = checkins[index];
            const personName = person ? person.name : 'this person';

            // Get current user - check remembered name or selected name
            const currentUser = localStorage.getItem(`tennisUserName_${currentGroupId}`) || selectedName;

            // Permission check: Can only remove your own check-in unless you're admin
            const isOwner = currentUser && normalizeName(currentUser) === normalizeName(personName);
            const isAdmin = sessionStorage.getItem(`adminAuth_${currentGroupId}`) === 'true';

            if (!isOwner && !isAdmin) {
                showToast(`You can only remove your own check-in`, 'error');
                return;
            }

            // Confirmation dialog
            if (!confirm(`Remove ${personName} from check-ins?`)) {
                return; // User cancelled
            }

            checkins.splice(index, 1);
            setCurrentCheckins(checkins);
            saveAndRender();

            // Show success notification
            showToast(`Removed ${personName}`, 'success');
        }
        
        function resetAll() {
            // Admin-only function
            const isAdmin = sessionStorage.getItem(`adminAuth_${currentGroupId}`) === 'true';

            if (!isAdmin) {
                // Prompt for admin PIN
                const enteredPin = prompt('Enter Admin PIN to reset all check-ins:');
                if (enteredPin === null) return; // User cancelled

                if (enteredPin !== adminPin) {
                    showToast('Incorrect admin PIN', 'error');
                    return;
                }

                // Set admin session for this action
                sessionStorage.setItem(`adminAuth_${currentGroupId}`, 'true');
            }

            // Fix timezone bug - append T00:00:00 to parse in local time
            const dateDisplay = new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            if (confirm(`Reset all check-ins for ${dateDisplay}?`)) {
                setCurrentCheckins([]);
                saveAndRender();
                showToast('All check-ins reset', 'success');
            }
        }

        // WhatsApp Sharing Functions
        function formatMatchDetailsForWhatsApp() {
            const checkins = getCurrentCheckins();
            if (checkins.length === 0) {
                return '';
            }

            const { matches } = organizeMatches(checkins);

            // Format date - compact
            const dateObj = new Date(selectedDate);
            const dateStr = dateObj.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short',
                day: 'numeric'
            });

            // Start message - compact header
            let message = `üéæ ${dateStr}\n\n`;

            // Add each match group
            matches.forEach(match => {
                if (match.type === 'doubles') {
                    message += `Court ___ - Doubles\n`;
                    const players = match.players.map(p => p.name);
                    message += `${players.join(', ')}\n`;

                    // Add time window if available - compact format
                    const times = match.players
                        .filter(p => p.timeRange)
                        .map(p => formatTimeRange(p.timeRange.start, p.timeRange.end));
                    if (times.length > 0) {
                        message += `${times[0]}\n`;
                    }
                    message += '\n';
                } else if (match.type === 'singles') {
                    message += `Court ___ - Singles\n`;
                    const players = match.players.map(p => p.name);
                    message += `${players.join(', ')}\n`;

                    // Add time window if available - compact format
                    const times = match.players
                        .filter(p => p.timeRange)
                        .map(p => formatTimeRange(p.timeRange.start, p.timeRange.end));
                    if (times.length > 0) {
                        message += `${times[0]}\n`;
                    }
                    message += '\n';
                } else if (match.type === 'singles-or-practice') {
                    message += `Court ___ - Rotation\n`;
                    message += `${match.players.map(p => p.name).join(', ')}\n`;

                    // Add time window if available - compact format
                    const times = match.players
                        .filter(p => p.timeRange)
                        .map(p => formatTimeRange(p.timeRange.start, p.timeRange.end));
                    if (times.length > 0) {
                        message += `${times[0]}\n`;
                    }
                    message += '\n';
                }
            });

            // Add standby list if any
            const standbyMatch = matches.find(m => m.type === 'waiting');
            if (standbyMatch && standbyMatch.players.length > 0) {
                message += `Standby:\n`;
                message += standbyMatch.players.map(p => p.name).join(', ') + '\n\n';
            }

            // Add weather if available - compact format
            const weatherData = weatherCache[selectedDate];
            if (weatherData) {
                const weatherDesc = getWeatherDescription(weatherData.weatherCode);
                message += `${weatherDesc}, ${weatherData.tempMax}¬∞F`;
            }

            return message.trim();
        }

        function shareToWhatsApp() {
            const message = formatMatchDetailsForWhatsApp();
            if (!message) {
                showToast('No matches to share', 'error');
                return;
            }

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;

            // Open WhatsApp in new window/tab
            window.open(whatsappUrl, '_blank');
        }

        async function saveAndRender() {
            try {
                console.log('saveAndRender called');
                await saveFirebaseCheckins();
                console.log('About to call initDates()');
                initDates();
                console.log('About to call render()');
                render();
                console.log('render() completed');
            } catch (error) {
                console.error('Error in saveAndRender:', error);
                showToast('Error updating display', 'error');
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }
        
        function getPreferenceLabel(pref) {
            if (pref === 'singles') return 'Singles';
            if (pref === 'doubles') return 'Doubles';
            return 'Either';
        }
        
        function getUserPrefs(name) {
            return userPreferences[normalizeName(name)] || { include: [], exclude: [] };
        }
        
        function canPlayTogether(name1, name2) {
            const prefs1 = getUserPrefs(name1);
            const prefs2 = getUserPrefs(name2);
            const n1 = normalizeName(name1);
            const n2 = normalizeName(name2);
            
            return !prefs1.exclude.includes(n2) && !prefs2.exclude.includes(n1);
        }
        
        function timesOverlap(time1, time2) {
            // If either has no time restriction, they can play together
            if (!time1 || !time2) return true;
            
            // If both have no start/end times, they're flexible
            if (!time1.start && !time1.end && !time2.start && !time2.end) return true;
            
            // Convert times to minutes for easier comparison
            const timeToMinutes = (timeStr) => {
                if (!timeStr) return null;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            
            // Get time ranges in minutes
            const t1Start = timeToMinutes(time1.start);
            const t1End = timeToMinutes(time1.end);
            const t2Start = timeToMinutes(time2.start);
            const t2End = timeToMinutes(time2.end);
            
            // Handle open-ended ranges
            // "from X" means X to end of day
            // "until X" means start of day to X
            const START_OF_DAY = 6 * 60;  // 6 AM
            const END_OF_DAY = 21 * 60;    // 9 PM
            
            const range1Start = t1Start || START_OF_DAY;
            const range1End = t1End || END_OF_DAY;
            const range2Start = t2Start || START_OF_DAY;
            const range2End = t2End || END_OF_DAY;
            
            // Check if ranges overlap
            // Ranges overlap if: start1 < end2 AND start2 < end1
            return range1Start < range2End && range2Start < range1End;
        }
        
        function canPlayTogetherWithTime(player1, player2) {
            // First check exclusion preferences
            if (!canPlayTogether(player1.name, player2.name)) {
                return false;
            }
            
            // Then check time overlap
            return timesOverlap(player1.timeRange, player2.timeRange);
        }
        
        function organizeMatches(checkins) {
            const matches = [];
            const warnings = [];
            let remaining = checkins.map((c, idx) => ({ ...c, originalIndex: idx }));
            
            // Separate by play style
            const doublesOnly = remaining.filter(p => p.playStyle === 'doubles');
            const singlesOnly = remaining.filter(p => p.playStyle === 'singles');
            const either = remaining.filter(p => p.playStyle === 'both');
            
            // Form doubles matches (NO preference filtering for doubles)
            let doublesPool = [...doublesOnly, ...either];
            const usedInDoubles = new Set();
            
            while (doublesPool.length >= 4) {
                // Just take first 4 players for doubles - no preference filtering
                const group = doublesPool.slice(0, 4);
                
                matches.push({
                    type: 'doubles',
                    number: matches.filter(m => m.type === 'doubles').length + 1,
                    players: group
                });
                
                // Mark these players as used in doubles
                group.forEach(p => usedInDoubles.add(p.originalIndex));
                
                // Remove from pool
                doublesPool.splice(0, 4);
            }
            
            // Form singles matches (WITH preference filtering AND time overlap)
            // Only include: singles-only players + "either" players not used in doubles
            let singlesPool = [
                ...singlesOnly,
                ...doublesPool.filter(p => p.playStyle === 'both')
            ];

            // Special case: if exactly 3 players in singles pool, try rotation first
            if (singlesPool.length === 3) {
                const canAll3Play =
                    canPlayTogetherWithTime(singlesPool[0], singlesPool[1]) &&
                    canPlayTogetherWithTime(singlesPool[0], singlesPool[2]) &&
                    canPlayTogetherWithTime(singlesPool[1], singlesPool[2]);

                // Check if all 3 are willing to play rotation
                const allAllowRotation =
                    (singlesPool[0].allowRotation !== false) &&
                    (singlesPool[1].allowRotation !== false) &&
                    (singlesPool[2].allowRotation !== false);

                if (canAll3Play && allAllowRotation) {
                    matches.push({
                        type: 'singles-or-practice',
                        players: [...singlesPool]
                    });
                    singlesPool = []; // Clear the pool
                }
            }

            while (singlesPool.length >= 2) {
                let pair = null;
                
                // Try to find a valid pair respecting exclusions AND time overlap
                for (let i = 0; i < singlesPool.length - 1; i++) {
                    for (let j = i + 1; j < singlesPool.length; j++) {
                        if (canPlayTogetherWithTime(singlesPool[i], singlesPool[j])) {
                            pair = [singlesPool[i], singlesPool[j]];
                            break;
                        }
                    }
                    if (pair) break;
                }
                
                if (pair) {
                    matches.push({
                        type: 'singles',
                        players: pair
                    });
                    
                    // Remove from pool
                    pair.forEach(p => {
                        const idx = singlesPool.findIndex(sp => sp.originalIndex === p.originalIndex);
                        if (idx > -1) singlesPool.splice(idx, 1);
                    });
                } else {
                    // No valid pairs possible due to exclusions or time conflicts
                    break;
                }
            }
            
            // Handle remaining (only from singlesPool and doubles-only players in doublesPool)
            const allRemaining = [
                ...doublesPool.filter(p => p.playStyle === 'doubles'),
                ...singlesPool
            ];
            
            if (allRemaining.length === 3) {
                // Check if they can all play together (preferences AND time)
                const canAll3Play = allRemaining.length === 3 && 
                    canPlayTogetherWithTime(allRemaining[0], allRemaining[1]) &&
                    canPlayTogetherWithTime(allRemaining[0], allRemaining[2]) &&
                    canPlayTogetherWithTime(allRemaining[1], allRemaining[2]);
                
                if (canAll3Play) {
                    matches.push({
                        type: 'singles-or-practice',
                        players: allRemaining
                    });
                } else {
                    // Can't all play together
                    warnings.push(`3 remaining players have conflicts (preferences or time) - placed in waiting`);
                    allRemaining.forEach(p => {
                        matches.push({
                            type: 'waiting',
                            players: [p]
                        });
                    });
                }
            } else if (allRemaining.length === 2) {
                if (canPlayTogetherWithTime(allRemaining[0], allRemaining[1])) {
                    matches.push({
                        type: 'singles',
                        players: allRemaining
                    });
                } else {
                    // Can't pair them
                    allRemaining.forEach(p => {
                        matches.push({
                            type: 'waiting',
                            players: [p]
                        });
                    });
                    
                    // Determine conflict type for warning
                    const prefConflict = !canPlayTogether(allRemaining[0].name, allRemaining[1].name);
                    const timeConflict = !timesOverlap(allRemaining[0].timeRange, allRemaining[1].timeRange);
                    
                    if (prefConflict && timeConflict) {
                        warnings.push(`${allRemaining[0].name} and ${allRemaining[1].name} cannot be paired (exclusion preference + time conflict)`);
                    } else if (prefConflict) {
                        warnings.push(`${allRemaining[0].name} and ${allRemaining[1].name} cannot be paired (exclusion preference)`);
                    } else if (timeConflict) {
                        warnings.push(`${allRemaining[0].name} and ${allRemaining[1].name} cannot be paired (time conflict)`);
                    }
                }
            } else if (allRemaining.length === 1) {
                matches.push({
                    type: 'waiting',
                    players: allRemaining
                });
            } else if (allRemaining.length > 3) {
                warnings.push(`${allRemaining.length} players could not be matched due to preference conflicts`);
                allRemaining.forEach(p => {
                    matches.push({
                        type: 'waiting',
                        players: [p]
                    });
                });
            }
            
            return { matches, warnings };
        }
        
        function getMatchIndicators(player, matchPlayers, matchType) {
            // Only show indicators for singles matches
            if (matchType !== 'singles') return '';
            
            const prefs = getUserPrefs(player.name);
            const indicators = [];
            
            matchPlayers.forEach(other => {
                if (other.name === player.name) return;
                
                const otherNorm = normalizeName(other.name);
                if (prefs.include.includes(otherNorm)) {
                    indicators.push(`<span class="match-indicator satisfied">‚úì with ${other.name}</span>`);
                }
            });
            
            return indicators.join(' ');
        }
        
        function render() {
            const checkins = getCurrentCheckins();
            console.log('render() called. selectedDate:', selectedDate, 'checkins:', checkins, 'allCheckins:', allCheckins);

            document.getElementById('count').textContent = checkins.length;
            
            const checkinList = document.getElementById('checkinList');
            if (checkins.length === 0) {
                checkinList.innerHTML = '<div class="empty-state">No check-ins yet</div>';
            } else {
                checkinList.innerHTML = checkins.map((c, i) => {
                    const guestInfo = c.isGuest ? `<span class="guest-indicator">guest of ${c.addedBy}</span>` : '';
                    const timeInfo = c.timeRange ? `<span class="time-badge">${formatTimeRange(c.timeRange.start, c.timeRange.end)}</span>` : '';
                    const rotationInfo = c.allowRotation === false ? `<span class="time-badge" style="background: #ffebee; color: #c62828;">No rotation</span>` : '';

                    return `
                        <div class="checkin-item">
                            <span>
                                <span class="checkin-name">${i + 1}. ${c.name} ${guestInfo}${timeInfo}${rotationInfo}</span>
                                <span class="preference-badge ${c.playStyle || 'both'}">${getPreferenceLabel(c.playStyle || 'both')}</span>
                                <span class="checkin-time">${formatTime(c.timestamp)}</span>
                            </span>
                            <button class="remove-btn" onclick="removeCheckIn(${i})">Remove</button>
                        </div>
                    `;
                }).join('');
            }
            
            const matchesDiv = document.getElementById('matches');
            if (checkins.length === 0) {
                matchesDiv.innerHTML = '';
                return;
            }
            
            const { matches, warnings } = organizeMatches(checkins);
            let html = '<h2>Organized Matches</h2>';

            // Add WhatsApp share button if there are matches
            const hasMatches = matches.some(m => m.type !== 'waiting' || m.players.length > 0);
            if (hasMatches) {
                html += '<button class="share-whatsapp-btn" onclick="shareToWhatsApp()">üì± Share to WhatsApp</button>';
            }

            if (warnings.length > 0) {
                html += '<div class="warning-box">' + warnings.join('<br>') + '</div>';
            }
            
            matches.forEach(match => {
                if (match.type === 'doubles') {
                    html += `
                        <div class="match-group">
                            <h3>Doubles ${match.number}</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                } else if (match.type === 'singles') {
                    html += `
                        <div class="match-group singles-group">
                            <h3>Singles Match</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                } else if (match.type === 'singles-or-practice') {
                    html += `
                        <div class="match-group singles-group">
                            <h3>Rotation (3 players) - 1v1 or 1v2</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                } else if (match.type === 'waiting') {
                    html += `
                        <div class="match-group singles-group">
                            <h3>Waiting</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                }
            });
            
            matchesDiv.innerHTML = html;
        }
        
        // Initial setup
        async function init() {
            // Load available groups from Firebase
            await loadAvailableGroups();

            // Get group ID from URL path
            const urlGroupId = await getGroupIdFromUrl();

            if (urlGroupId === 'admin') {
                // Site admin route
                await openSiteAdmin();
                return;
            }

            if (urlGroupId && availableGroups[urlGroupId]) {
                // URL has a valid group - authenticate and load it
                const groupSettings = availableGroups[urlGroupId].settings || {};
                const groupName = groupSettings.groupName || urlGroupId;
                const groupPin = groupSettings.groupPin || '';

                if (checkAuth(urlGroupId, groupName, groupPin)) {
                    await selectGroup(urlGroupId);
                    // Show app, hide landing page
                    document.getElementById('appContainer').style.display = 'block';
                    document.getElementById('landingPage').style.display = 'none';
                } else {
                    // Authentication failed - redirect to root
                    window.location.href = '/';
                    return;
                }
            } else {
                // No valid group in URL - show landing page
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('landingPage').style.display = 'block';
                return;
            }

            // Initialize UI
            initDates();
            displayWeather();
        }

        // Create dynamic manifest based on current URL
        function createDynamicManifest() {
            const currentPath = window.location.pathname;
            const currentUrl = window.location.origin + currentPath;

            const manifest = {
                name: currentGroupName || "Tennis Coordinator",
                short_name: "Tennis",
                description: "Tennis match coordination and check-in system",
                start_url: currentPath || "/",
                display: "standalone",
                background_color: "#ffffff",
                theme_color: "#4CAF50",
                orientation: "portrait-primary",
                icons: [
                    {
                        src: window.location.origin + "/icon-192.png",
                        sizes: "192x192",
                        type: "image/png",
                        purpose: "any"
                    },
                    {
                        src: window.location.origin + "/icon-512.png",
                        sizes: "512x512",
                        type: "image/png",
                        purpose: "any"
                    },
                    {
                        src: window.location.origin + "/apple-touch-icon.png",
                        sizes: "180x180",
                        type: "image/png",
                        purpose: "any"
                    }
                ]
            };

            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);

            // Update manifest link
            const manifestLink = document.getElementById('manifestLink');
            if (manifestLink) {
                manifestLink.href = manifestURL;
            }
        }

        // Start the app
        init();

        // Create dynamic manifest after group is loaded
        setTimeout(createDynamicManifest, 1000);

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
