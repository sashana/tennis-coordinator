<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tennis Coordinator</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- PWA Support -->
    <link rel="manifest" id="manifestLink" href="/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tennis">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- Google Analytics 4 (loaded dynamically) -->
    <script id="ga-script"></script>
    <script id="ga-config"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 12px;
            background: #f5f5f5;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-icon {
            background: transparent;
            color: #666;
            border: none;
            padding: 8px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-icon:hover {
            background: #f0f0f0;
        }
        
        .settings-icon:active {
            transform: scale(0.95);
        }

        /* User menu dropdown */
        .user-menu-container {
            position: relative;
            display: inline-block;
        }

        .user-menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 100;
            overflow: hidden;
            margin-top: 4px;
        }

        .user-menu-dropdown.active {
            display: block;
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-menu-item:hover {
            background: #f5f5f5;
        }

        .user-menu-item:active {
            background: #e8e8e8;
        }

        /* Notification bell */
        .notification-bell {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #f44336;
            color: white;
            font-size: 10px;
            font-weight: 600;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* Notifications panel */
        .notifications-panel {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .notification-item:hover {
            background: #f9f9f9;
        }

        .notification-item.unread {
            background: #e8f5e9;
        }

        .notification-item.unread:hover {
            background: #c8e6c9;
        }

        .notification-message {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 12px;
            color: #999;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        /* Toggle switch */
        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .toggle-container:last-child {
            border-bottom: none;
        }

        .toggle-label {
            flex: 1;
        }

        .toggle-label-title {
            font-size: 15px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }

        .toggle-label-desc {
            font-size: 13px;
            color: #666;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 28px;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .date-selector {
            margin-bottom: 16px;
        }

        .date-selector h2 {
            font-size: 13px;
            margin-bottom: 6px;
            color: #666;
        }

        .date-grid {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 0 8px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .date-grid::-webkit-scrollbar {
            height: 4px;
        }

        .date-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .date-grid::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 4px;
        }

        .date-btn {
            padding: 8px 12px;
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 11px;
            transition: all 0.2s;
            min-height: 56px;
            min-width: 64px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            flex-shrink: 0;
            white-space: nowrap;
        }
        
        .date-btn:active {
            transform: scale(0.95);
        }
        
        .date-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .date-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
        }
        
        .date-btn .day-name {
            font-size: 9px;
            text-transform: uppercase;
            opacity: 0.8;
            display: block;
        }

        .date-btn .day-num {
            font-size: 14px;
            font-weight: 600;
            display: block;
            margin: 2px 0;
        }
        
        .date-btn .checkin-badge {
            font-size: 9px;
            background: #ff9800;
            color: white;
            border-radius: 10px;
            padding: 2px 5px;
            margin-top: 2px;
            display: inline-block;
        }
        
        .date-btn.selected .checkin-badge {
            background: rgba(255,255,255,0.3);
        }
        
        .input-group {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        input {
            flex: 1 1 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            min-width: 0;
        }
        
        @media (min-width: 400px) {
            input {
                flex: 1 1 auto;
            }
        }
        
        .preference-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 16px;
        }
        
        .preference-btn {
            padding: 10px 6px;
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .preference-btn:active {
            transform: scale(0.95);
        }
        
        .preference-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .preference-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .preference-btn.singles.selected {
            background: #ff9800;
            border-color: #ff9800;
        }
        
        .preference-btn.doubles.selected {
            background: #2196F3;
            border-color: #2196F3;
        }
        
        input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            padding: 12px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 600;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:active {
            transform: scale(0.97);
        }
        
        button:hover {
            background: #45a049;
        }
        
        .reset-btn {
            background: #f44336;
            width: 100%;
            margin-top: 16px;
        }
        
        .reset-btn:hover {
            background: #da190b;
        }

        .share-whatsapp-btn {
            background: #25D366;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
            touch-action: manipulation;
        }

        .share-whatsapp-btn:hover {
            background: #20BA5A;
        }

        .share-whatsapp-btn:active {
            transform: scale(0.97);
        }

        .checkins {
            margin: 16px 0;
        }
        
        .checkins h2 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #666;
        }
        
        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 8px;
        }

        .checkin-item.current-user {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.1);
        }

        .current-user-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 600;
        }

        .checkin-item > span {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        @media (min-width: 500px) {
            .checkin-item > span {
                flex-direction: row;
                align-items: center;
                flex-wrap: wrap;
            }
        }
        
        .checkin-name {
            font-weight: 500;
            font-size: 15px;
        }
        
        .preference-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .preference-badge.singles {
            background: #fff3e0;
            color: #e65100;
        }
        
        .preference-badge.doubles {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .preference-badge.both {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .checkin-time {
            font-size: 12px;
            color: #999;
        }
        
        .remove-btn {
            padding: 8px 12px;
            background: #ff5252;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .matches {
            margin-top: 20px;
        }
        
        .match-group {
            margin-bottom: 16px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .match-group h3 {
            font-size: 15px;
            margin-bottom: 8px;
            color: #2e7d32;
        }
        
        .match-group ul {
            list-style: none;
            padding-left: 0;
        }
        
        .match-group li {
            padding: 6px 0;
            color: #333;
            font-size: 14px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
        }
        
        .singles-group {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .singles-group h3 {
            color: #e65100;
        }

        .match-notes {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ddd;
        }

        .match-note-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fafafa;
        }

        .match-note-input:focus {
            outline: none;
            border-color: #4CAF50;
            background: #fff;
        }

        .match-note-input::placeholder {
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: calc(100% - 40px);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-header h2 {
            font-size: 18px;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .pref-section {
            margin-bottom: 20px;
        }
        
        .pref-section h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .pref-section p {
            margin: 0 0 8px 0;
        }
        
        .pref-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .pref-input-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .pref-input-group button {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .pref-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .pref-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f5f5f5;
            border-radius: 16px;
            font-size: 13px;
        }
        
        .pref-tag.include {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .pref-tag.exclude {
            background: #ffebee;
            color: #c62828;
        }
        
        .pref-tag button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
            font-size: 16px;
            line-height: 1;
            opacity: 0.6;
        }
        
        .pref-tag button:hover {
            opacity: 1;
        }
        
        .pref-summary {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        
        .edit-prefs-btn {
            background: transparent;
            color: #4CAF50;
            border: 1px solid #4CAF50;
            padding: 6px 12px;
            font-size: 13px;
            margin-left: 8px;
        }
        
        .edit-prefs-btn:hover {
            background: #e8f5e9;
        }
        
        .match-indicator {
            font-size: 11px;
            margin-left: 4px;
        }
        
        .match-indicator.satisfied {
            color: #4CAF50;
        }
        
        .match-indicator.conflict {
            color: #f44336;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .member-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        
        .member-item button {
            padding: 6px 10px;
            background: #f44336;
            font-size: 12px;
        }
        
        .add-member-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .add-member-input input {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }
        
        .add-member-input button {
            padding: 10px 16px;
            font-size: 14px;
        }
        
        .guest-indicator {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            margin-bottom: 10px;
        }
        
        .guest-form {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .guest-form.active {
            display: block;
        }
        
        .guest-form input {
            margin-bottom: 8px;
        }

        .member-form {
            margin-top: 10px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }

        /* Hide other form elements when new member form is visible */
        .member-form:not([style*="display: none"]) ~ .preference-group,
        .member-form:not([style*="display: none"]) ~ .time-slots,
        .member-form:not([style*="display: none"]) ~ .rotation-option,
        .member-form:not([style*="display: none"]) ~ div[style*="flex"] {
            display: none !important;
        }

        .weather-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 13px;
        }

        .weather-widget h3 {
            font-size: 12px;
            margin: 0;
            opacity: 0.9;
            font-weight: 500;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .weather-temp {
            font-size: 22px;
            font-weight: bold;
        }

        .weather-desc {
            font-size: 13px;
            text-transform: capitalize;
        }
        
        .weather-details {
            display: flex;
            gap: 8px;
            font-size: 11px;
            opacity: 0.9;
        }

        .weather-details > span {
            white-space: nowrap;
        }

        .collapsible-form {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }

        .collapsible-form.expanded {
            max-height: 1500px;
            opacity: 1;
            transition: max-height 0.4s ease-in, opacity 0.4s ease-in;
        }

        .time-preset-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px 8px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #333;
            transition: all 0.2s;
            line-height: 1.3;
        }

        .time-preset-btn:hover {
            background: #f0f7ff;
            border-color: #667eea;
            color: #667eea;
        }

        .time-preset-btn:active {
            transform: scale(0.98);
        }

        .time-preset-btn small {
            display: block;
            font-size: 10px;
            opacity: 0.7;
            margin-top: 2px;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .checkin-item {
            animation: slideInUp 0.3s ease-out;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .weather-error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .weather-loading {
            background: #e3f2fd;
            color: #1565c0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 13px;
        }
        
        .time-slots {
            margin-bottom: 16px;
        }
        
        .time-slots h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .time-slot-btn {
            padding: 10px 6px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
        }
        
        .time-slot-btn:active {
            transform: scale(0.95);
        }
        
        .time-slot-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .time-slot-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: 600;
        }
        
        .time-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
            margin-left: 4px;
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #4CAF50;
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast.success {
            border-left-color: #4CAF50;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .toast-action {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .toast-action:hover {
            background: #388E3C;
        }

        .toast-action:active {
            transform: scale(0.95);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Landing Page (shown when no group selected) -->
    <div id="landingPage" style="display: none; max-width: 800px; margin: 60px auto; padding: 40px 20px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
        <h1 style="font-size: 48px; margin-bottom: 20px;">üéæ Tennis Coordinator</h1>
        <p style="font-size: 24px; color: #333; margin-bottom: 10px; font-weight: 500;">
            Turn your love for tennis into more games.
        </p>
        <p style="font-size: 18px; color: #666; margin-bottom: 40px; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto;">
            A simple tool that helps tennis groups self-organize matches with minimal friction‚Äîso you spend less time coordinating and more time on the court.
        </p>

        <div style="background: #f5f5f5; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
            <h2 style="font-size: 22px; margin-bottom: 20px;">Why It Works</h2>
            <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                <p style="margin-bottom: 12px;">‚ô¶ <strong>Frictionless</strong> ‚Äî Check in with a few taps. No accounts, no apps to download.</p>
                <p style="margin-bottom: 12px;">‚ô¶ <strong>Flexible</strong> ‚Äî Handles doubles, singles, odd numbers, guests, and preferences.</p>
                <p style="margin-bottom: 12px;">‚ô¶ <strong>Adaptable</strong> ‚Äî Works for tight-knit groups of 20 or club communities of 50+.</p>
                <p style="margin-bottom: 0;">‚ô¶ <strong>Real-Time</strong> ‚Äî Everyone sees who's playing instantly.</p>
            </div>
        </div>

        <div style="background: #fff; border: 1px solid #e0e0e0; padding: 30px; border-radius: 12px; margin-bottom: 40px;">
            <h2 style="font-size: 22px; margin-bottom: 20px;">How It Works</h2>
            <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                <p style="margin-bottom: 12px;"><strong>1. Check In</strong> ‚Äî Select your name, play style, and when you're available</p>
                <p style="margin-bottom: 12px;"><strong>2. Auto-Match</strong> ‚Äî System organizes matches based on who's playing</p>
                <p style="margin-bottom: 0;"><strong>3. Play</strong> ‚Äî Show up and enjoy the game</p>
            </div>
        </div>

        <div style="margin-bottom: 40px;">
            <p style="font-size: 18px; color: #666;">
                To access your tennis group, visit your group's unique URL or contact your group admin for the link.
            </p>
        </div>

        <div style="font-size: 14px; color: #999;">
            <p>Site Administrator? <a href="/admin" style="color: #4CAF50; text-decoration: none;">Access Site Admin ‚Üí</a></p>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <h1>
            <span>
                <span id="groupNameDisplay">üéæ Tennis Coordinator</span>
                <br><small style="font-size: 12px; font-weight: 400; opacity: 0.8;">
                    <span id="groupSubtitle">Tennis Coordinator</span>
                </small>
            </span>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="settings-icon notification-bell" id="notificationBellBtn" onclick="openNotificationsModal()" title="Notifications" style="display: none;">
                    üîî
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <div class="user-menu-container" id="userMenuContainer" style="display: none;">
                    <button id="sessionUserBtn" class="settings-icon" onclick="toggleUserMenu()" title="User menu" style="padding: 6px 10px; width: auto; font-size: 14px;">
                        <span id="sessionUserIcon"><span id="sessionUserNameBtn"></span> ‚ñº</span>
                    </button>
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <button class="user-menu-item" onclick="openNotificationPrefsModal()">
                            <span>üîî</span> Notifications
                        </button>
                        <button class="user-menu-item" onclick="openActivityModalFromMenu()">
                            <span>üìã</span> Activity History
                        </button>
                        <button class="user-menu-item" onclick="openSettingsModalFromMenu()">
                            <span>‚öôÔ∏è</span> Admin Settings
                        </button>
                        <button class="user-menu-item" onclick="openHelpFromMenu()">
                            <span>‚ùì</span> User Guide
                        </button>
                        <div style="border-top: 1px solid #e0e0e0; margin: 4px 0;"></div>
                        <button class="user-menu-item" onclick="confirmChangeUser()">
                            <span>üîÑ</span> Change User
                        </button>
                    </div>
                </div>
            </div>
        </h1>
        
        <div class="date-selector">
            <h2>Select Date</h2>
            <div class="date-grid" id="dateGrid"></div>
        </div>
        
        <div id="weatherWidget"></div>

        <div class="input-group">
            <select id="nameSelect" onchange="handleNameSelect()">
                <option value="">Select your name...</option>
            </select>
            <button id="prefsBtn" class="edit-prefs-btn" onclick="openPreferencesModal()" title="Edit Singles Preferences" style="display: none;">‚öôÔ∏è</button>
        </div>

        <!-- Collapsible form fields -->
        <div class="collapsible-form" id="checkInFormFields">
            <div class="guest-form" id="guestForm">
                <input
                    type="text"
                    id="guestNameInput"
                    placeholder="Guest's name"
                >
                <select id="addedBySelect">
                    <option value="">Who is adding this guest?</option>
                </select>
            </div>

            <div class="member-form" id="newMemberForm" style="display: none;">
                <h3 style="font-size: 14px; margin-bottom: 12px; color: #333;">Add New Member</h3>
                <input
                    type="text"
                    id="newMemberNameInput"
                    placeholder="Member's full name"
                    style="margin-bottom: 8px;"
                >
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input
                        type="tel"
                        id="newMemberPhoneInput"
                        placeholder="Phone (optional)"
                        style="flex: 1;"
                    >
                    <input
                        type="email"
                        id="newMemberEmailInput"
                        placeholder="Email (optional)"
                        style="flex: 1;"
                    >
                </div>
                <textarea
                    id="newMemberNotesInput"
                    placeholder="Notes (skill level, how you know them, etc.) - optional"
                    rows="3"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical; margin-bottom: 12px;"
                ></textarea>
                <div style="font-size: 12px; color: #666; margin-bottom: 12px;">
                    Added by: <strong id="newMemberAddedBy"></strong>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="cancelNewMember()" style="flex: 1; background: #ccc; color: #333;">Cancel</button>
                    <button onclick="submitNewMember()" style="flex: 2; background: #4CAF50; color: white;">Add Member</button>
                </div>
            </div>

            <div class="preference-group">
                <button class="preference-btn singles" id="singlesBtn" onclick="selectPreference('singles')">
                    Singles Only
                </button>
                <button class="preference-btn selected" id="bothBtn" onclick="selectPreference('both')">
                    Either
                </button>
                <button class="preference-btn doubles" id="doublesBtn" onclick="selectPreference('doubles')">
                    Doubles Only
                </button>
            </div>

            <div class="time-slots">
                <h3>Available Time (optional)</h3>

                <!-- Time presets -->
                <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                    <button class="time-preset-btn" onclick="setTimePreset('08:00', '12:00')">Morning<br><small>8am-12pm</small></button>
                    <button class="time-preset-btn" onclick="setTimePreset('12:00', '15:00')">Midday<br><small>12-3pm</small></button>
                    <button class="time-preset-btn" onclick="setTimePreset('15:00', '18:00')">Afternoon<br><small>3-6pm</small></button>
                    <button class="time-preset-btn" onclick="setTimePreset('18:00', '21:00')">Evening<br><small>6-9pm</small></button>
                </div>

                <!-- Custom time inputs -->
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <input
                        type="time"
                        id="startTimeInput"
                        style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                        placeholder="Start"
                    >
                    <span style="color: #666;">to</span>
                    <input
                        type="time"
                        id="endTimeInput"
                        style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                        placeholder="End"
                    >
                    <button
                        onclick="clearTimeInputs()"
                        style="padding: 10px 12px; background: #f5f5f5; color: #666; font-size: 13px;"
                    >
                        Clear
                    </button>
                </div>
                <div style="font-size: 12px; color: #999; margin-top: 6px;">
                    Use presets above or set custom times
                </div>
            </div>

            <div class="rotation-option" style="margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 14px;">
                    <input
                        type="checkbox"
                        id="allowRotationCheckbox"
                        checked
                        style="width: 18px; height: 18px; cursor: pointer; margin-right: 4px;"
                    >
                    <span>Willing to play 3-player rotation (1v1 or 1v2 format)</span>
                </label>
                <div style="font-size: 12px; color: #666; margin-top: 4px; margin-left: 26px;">
                    If unchecked, you'll only be placed in doubles or singles matches
                </div>
            </div>

            <!-- Action buttons at bottom -->
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button onclick="cancelCheckIn()" style="flex: 1; background: #f5f5f5; color: #666;">Cancel</button>
                <button onclick="checkIn()" style="flex: 2; background: #4CAF50; color: white;">Check In</button>
            </div>
        </div>

        <!-- Organized Matches (primary view) -->
        <div class="matches" id="matches" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #f0f0f0;"></div>

        <!-- Check-ins (collapsible) -->
        <div class="checkins" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #f0f0f0;">
            <h2 onclick="toggleCheckinList()" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span id="checkinToggleIcon">‚ñº</span>
                <span>Check-ins (<span id="count">0</span>)</span>
            </h2>
            <div id="checkinList"></div>
        </div>
    </div>
    
    <!-- Preferences Modal -->
    <div class="modal" id="preferencesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Singles Match Preferences</h2>
                <button class="close-btn" onclick="closePreferencesModal()">√ó</button>
            </div>

            <div id="excludeSection" class="pref-section" style="display: none;">
                <h3>Exclude Players</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">You won't be paired with these players in singles matches</p>
                <div class="pref-input-group">
                    <input
                        type="text"
                        id="excludeInput"
                        placeholder="Enter name"
                        onkeypress="if(event.key==='Enter') addExclude()"
                    >
                    <button onclick="addExclude()">Add</button>
                </div>
                <div class="pref-list" id="excludeList"></div>
            </div>

            <button onclick="savePreferences()" style="width: 100%;">Save Preferences</button>
        </div>
    </div>

    <!-- Activity Modal -->
    <div class="modal" id="activityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Activity History</h2>
                <button class="close-btn" onclick="closeActivityModal()">√ó</button>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <p style="font-size: 13px; color: #666; margin: 0;">Recent activity for <strong id="activityDateDisplay"></strong></p>
                <label id="showAllDatesToggle" style="display: none; font-size: 13px; color: #666; cursor: pointer;">
                    <input type="checkbox" id="showAllDatesCheckbox" onchange="loadActivityLog()" style="margin-right: 4px;">
                    Show All Dates
                </label>
            </div>
            <div id="activityList" style="max-height: 400px; overflow-y: auto;">
                <p style="color: #999; text-align: center;">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Admin Settings</h2>
                <p style="font-size: 12px; color: #666; margin: 4px 0 0 0;">Managing: <strong id="adminGroupName">Current Group</strong></p>
                <button class="close-btn" onclick="closeSettingsModal()">√ó</button>
            </div>
            
            <div class="pref-section">
                <h3>Group Name</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Display name for this tennis group</p>
                <input
                    type="text"
                    id="groupNameInput"
                    placeholder="e.g., Tue/Thu Midday Doubles"
                    style="width: 100%; margin-bottom: 12px;"
                >
            </div>

            <div class="pref-section">
                <h3>Core Members</h3>
                <div class="member-list" id="memberList"></div>
                <div class="add-member-input">
                    <input
                        type="text"
                        id="newMemberInput"
                        placeholder="New member name"
                        onkeypress="if(event.key==='Enter') addCoreMember()"
                    >
                    <button onclick="addCoreMember()">Add</button>
                </div>
            </div>
            
            <div class="pref-section">
                <h3>Admin PIN</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Required to access admin settings</p>
                <input
                    type="text"
                    id="adminPinInput"
                    value="3250"
                    style="width: 100%; margin-bottom: 12px;"
                >
            </div>

            <div class="pref-section">
                <h3>Group PIN</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Share this PIN with all group members to access the app</p>
                <input
                    type="text"
                    id="groupPinInput"
                    value="14675"
                    style="width: 100%; margin-bottom: 12px;"
                >
            </div>

            <div class="pref-section">
                <h3>Weather Location</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Set the location for weather forecasts</p>
                <input
                    type="text"
                    id="locationNameInput"
                    placeholder="Location name (e.g., Los Gatos, CA)"
                    style="width: 100%; margin-bottom: 8px;"
                >
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input
                        type="number"
                        step="0.0001"
                        id="locationLatInput"
                        placeholder="Latitude"
                        style="flex: 1;"
                    >
                    <input
                        type="number"
                        step="0.0001"
                        id="locationLonInput"
                        placeholder="Longitude"
                        style="flex: 1;"
                    >
                </div>
                <p style="font-size: 11px; color: #999; margin-bottom: 12px;">Tip: Use <a href="https://www.latlong.net/" target="_blank" style="color: #4CAF50;">latlong.net</a> to find coordinates</p>
                <button onclick="saveSettings()" style="width: 100%; margin-bottom: 12px;">Save Settings</button>
            </div>

        </div>
    </div>

    <!-- Site Admin Modal -->
    <div id="siteAdminModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Site Admin - Manage Groups</h2>
                <button class="close-btn" onclick="closeSiteAdmin()">√ó</button>
            </div>

            <!-- Site Settings Section -->
            <div style="border: 1px solid #ddd; padding: 16px; border-radius: 8px; margin-bottom: 20px; background: #f9f9f9;">
                <h3 style="margin-top: 0; margin-bottom: 12px;">üìä Site Settings</h3>
                <div style="display: flex; gap: 12px; align-items: end;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Google Analytics ID:</label>
                        <input type="text" id="gaTrackingId" placeholder="e.g., G-XXXXXXXXXX" style="width: 100%;">
                    </div>
                    <button onclick="saveSiteSettings()" style="white-space: nowrap;">Save</button>
                </div>
                <small style="color: #666; margin-top: 4px; display: block;">Measurement ID from Google Analytics 4</small>
            </div>

            <button onclick="showCreateGroupForm()" style="margin-bottom: 20px; background: #4CAF50;">‚ûï Create New Group</button>

            <div id="groupsTable" style="margin-bottom: 20px;">
                <!-- Groups table will be rendered here -->
            </div>

            <!-- Create/Edit Group Form -->
            <div id="groupForm" style="display: none; border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h3 id="groupFormTitle">Create New Group</h3>
                <input type="hidden" id="editingGroupId">

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Group Name:</label>
                    <input type="text" id="formGroupName" placeholder="e.g., Tue/Thu+ Midday Doubles" style="width: 100%;">
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">URL Short Code:</label>
                    <input type="text" id="formShortCode" placeholder="e.g., ttmd" style="width: 100%;">
                    <small style="color: #666;">Short code for URL (e.g., /ttmd)</small>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Group PIN:</label>
                        <input type="text" id="formGroupPin" placeholder="e.g., 14675" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Admin PIN:</label>
                        <input type="text" id="formAdminPin" placeholder="e.g., 3250" style="width: 100%;">
                    </div>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Weather Location Name:</label>
                    <input type="text" id="formLocationName" placeholder="e.g., Los Gatos, CA" style="width: 100%;">
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Latitude:</label>
                        <input type="number" step="0.0001" id="formLocationLat" placeholder="e.g., 37.2358" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Longitude:</label>
                        <input type="number" step="0.0001" id="formLocationLon" placeholder="e.g., -121.9623" style="width: 100%;">
                    </div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button onclick="saveGroup()" style="flex: 1; background: #4CAF50;">üíæ Save Group</button>
                    <button onclick="cancelGroupForm()" style="flex: 1; background: #999;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Selector Modal -->
    <div id="groupSelectorModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="margin-top: 0;">Select Tennis Group</h2>
            <div id="groupsList" style="margin-bottom: 20px;">
                <!-- Groups will be loaded here -->
            </div>
            <div id="groupPinSection" style="display: none;">
                <p style="font-size: 14px; color: #666; margin-bottom: 8px;">Enter PIN for <strong id="selectedGroupName"></strong>:</p>
                <input
                    type="password"
                    id="groupPinEntry"
                    placeholder="Enter group PIN"
                    style="width: 100%; margin-bottom: 12px;"
                    onkeypress="if(event.key === 'Enter') confirmGroupSelection()"
                >
                <div style="display: flex; gap: 8px;">
                    <button onclick="confirmGroupSelection()" style="flex: 1;">Access Group</button>
                    <button onclick="cancelGroupSelection()" style="flex: 1; background-color: #999;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal (shown after PIN for first-time users) -->
    <div id="welcomeModal" class="modal">
        <div class="modal-content" style="max-width: 380px; text-align: center;">
            <h2 style="margin-top: 0;">üëã Welcome!</h2>
            <p id="welcomeGroupName" style="color: #4CAF50; font-weight: 500; margin-bottom: 16px;"></p>
            <p style="color: #666; margin-bottom: 20px;">Select your name to start</p>
            <select id="welcomeNameSelect" onchange="onWelcomeNameSelect()" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;">
                <option value="">Select your name...</option>
            </select>
        </div>
    </div>

    <!-- Notification Preferences Modal -->
    <div id="notificationPrefsModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center;">
                üîî Notifications
                <button onclick="closeNotificationPrefsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </h2>
            <p style="color: #666; margin-bottom: 16px; font-size: 14px;">Choose what you want to be notified about</p>

            <div class="toggle-container">
                <div class="toggle-label">
                    <div class="toggle-label-title">Activity alerts</div>
                    <div class="toggle-label-desc">When someone checks in or cancels</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="notifActivityAlerts" onchange="saveNotificationPrefs()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-container">
                <div class="toggle-label">
                    <div class="toggle-label-title">Match confirmations</div>
                    <div class="toggle-label-desc">When you're placed in a match</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="notifMatchConfirmations" onchange="saveNotificationPrefs()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Muted members section -->
            <div id="mutedMembersSection" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div>
                        <div style="font-weight: 500; font-size: 14px;">Muted members</div>
                        <div style="font-size: 12px; color: #666;">You won't receive alerts from these members</div>
                    </div>
                    <button onclick="openMuteMemberPicker()" style="background: #f0f0f0; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer;">
                        + Add
                    </button>
                </div>
                <div id="mutedMembersList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <!-- Muted members will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mute Member Picker Modal -->
    <div id="muteMemberPickerModal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <h2 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center; font-size: 16px;">
                Mute Member
                <button onclick="closeMuteMemberPicker()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </h2>
            <p style="color: #666; font-size: 13px; margin-bottom: 12px;">Select a member to mute their activity alerts</p>
            <select id="muteMemberSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 12px;">
                <option value="">Select a member...</option>
            </select>
            <div style="display: flex; gap: 8px;">
                <button onclick="closeMuteMemberPicker()" style="flex: 1; padding: 10px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Cancel</button>
                <button onclick="muteMember()" style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Mute</button>
            </div>
        </div>
    </div>

    <!-- Notifications List Modal -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content" style="max-width: 400px; padding: 0;">
            <div style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 18px;">Notifications</h2>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button onclick="clearAllNotifications()" style="background: none; border: none; color: #4CAF50; font-size: 14px; cursor: pointer; font-weight: 500;">Clear all</button>
                    <button onclick="closeNotificationsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                </div>
            </div>
            <div class="notifications-panel" id="notificationsList">
                <div class="notification-empty">No notifications yet</div>
            </div>
        </div>
    </div>

    <!-- Invite Prompt Modal -->
    <div id="invitePromptModal" class="modal">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <div id="invitePromptContent">
                <!-- Content populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center;">
                Edit Member
                <button onclick="closeEditMemberModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </h2>
            <p style="font-weight: 500; margin-bottom: 16px;" id="editMemberName"></p>

            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Phone</label>
                <input type="tel" id="editMemberPhone" placeholder="Phone number" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Email</label>
                <input type="email" id="editMemberEmail" placeholder="Email address" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Notes</label>
                <textarea id="editMemberNotes" placeholder="Notes (skill level, etc.)" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
            </div>

            <div style="display: flex; gap: 8px;">
                <button onclick="closeEditMemberModal()" style="flex: 1; padding: 12px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Cancel</button>
                <button onclick="saveEditMember()" style="flex: 2; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Save</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCr-Ej5jeuV3kdvquu2W_R0ffSrUW0OUcQ",
            authDomain: "tennis-coordinator-43f53.firebaseapp.com",
            databaseURL: "https://tennis-coordinator-43f53-default-rtdb.firebaseio.com",
            projectId: "tennis-coordinator-43f53",
            storageBucket: "tennis-coordinator-43f53.firebasestorage.app",
            messagingSenderId: "665148711646",
            appId: "1:665148711646:web:66d14722800a12f5a3184f",
            measurementId: "G-J0KVB2Q93W"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase not configured. Please add your Firebase configuration.');
        }

        // Google Analytics 4 Initialization
        let gaInitialized = false;

        function initGoogleAnalytics(trackingId) {
            if (!trackingId) return;

            // Remove existing GA scripts if reinitializing
            const existingScript = document.getElementById('ga-script');
            const existingConfig = document.getElementById('ga-config');

            // Load gtag.js
            if (existingScript) {
                existingScript.src = `https://www.googletagmanager.com/gtag/js?id=${trackingId}`;
                existingScript.async = true;
            }

            // Initialize gtag
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            window.gtag = gtag;
            gtag('js', new Date());
            gtag('config', trackingId, {
                page_title: currentGroupName || 'Tennis Coordinator',
                page_location: window.location.href
            });

            gaInitialized = true;
            console.log('Google Analytics initialized with ID:', trackingId);
        }

        function trackEvent(eventName, eventParams = {}) {
            if (gaInitialized && window.gtag) {
                // Add common parameters
                eventParams.group_id = currentGroupId || 'none';
                eventParams.group_name = currentGroupName || 'none';
                window.gtag('event', eventName, eventParams);
            }
        }

        // Current selected group (determined by URL path)
        let currentGroupId = null;
        let currentGroupName = '';
        let availableGroups = {};

        // Short code to group ID mapping
        async function resolveShortCode(code) {
            // Load all groups and find matching short code
            const groupsSnapshot = await firebaseRef.groups().once('value');
            const groups = groupsSnapshot.val() || {};

            for (const [groupId, groupData] of Object.entries(groups)) {
                if (groupData.settings && groupData.settings.shortCode === code) {
                    return groupId;
                }
            }
            return null;
        }

        // Parse group from URL path
        async function getGroupIdFromUrl() {
            // Check if we were redirected from 404.html
            const redirect = sessionStorage.getItem('redirect');
            if (redirect) {
                sessionStorage.removeItem('redirect');
                const groupPath = redirect.replace(/^\/+|\/+$/g, '');

                // Handle admin route from redirect
                if (groupPath === 'admin') {
                    history.replaceState(null, '', redirect);
                    return 'admin';
                }

                if (groupPath && groupPath !== 'index.html') {
                    // Update browser URL without page reload
                    history.replaceState(null, '', redirect);

                    // Check if it's a short code
                    const resolvedGroupId = await resolveShortCode(groupPath);
                    return resolvedGroupId || groupPath;
                }
            }

            const path = window.location.pathname;
            // Remove leading/trailing slashes and get the group ID
            const groupPath = path.replace(/^\/+|\/+$/g, '');

            // Special routes
            if (groupPath === 'admin') {
                return 'admin'; // Special case for site admin
            }

            // If empty or index.html, return null (will show group selector)
            if (!groupPath || groupPath === 'index.html') {
                return null;
            }

            // Check if it's a short code first
            const resolvedGroupId = await resolveShortCode(groupPath);
            return resolvedGroupId || groupPath;
        }

        // Firebase helper functions (group-scoped)
        const firebaseRef = {
            groups: () => db.ref('groups'),
            group: (groupId) => db.ref(`groups/${groupId}`),
            checkins: (groupId) => db.ref(`groups/${groupId}/checkins`),
            settings: (groupId) => db.ref(`groups/${groupId}/settings`),
            activity: (groupId, date) => db.ref(`groups/${groupId}/activity/${date}`),
            activityAll: (groupId) => db.ref(`groups/${groupId}/activity`),
            matchNotes: (groupId, date) => db.ref(`groups/${groupId}/matchNotes/${date}`),
            userPreferences: () => db.ref('userPreferences'),
            siteSettings: () => db.ref('siteSettings'),
            userNotificationPrefs: (groupId, userName) => db.ref(`groups/${groupId}/userNotifications/${normalizeName(userName)}/preferences`),
            userNotifications: (groupId, userName) => db.ref(`groups/${groupId}/userNotifications/${normalizeName(userName)}/items`),
            groupNotifications: (groupId) => db.ref(`groups/${groupId}/userNotifications`)
        };

        // Match notes cache (per date)
        let matchNotes = {};

        // Group Feature Configuration
        // Simplified config for tight-knit groups - will expand to full template system later
        const groupFeatures = {
            excludeListForSingles: false  // Hide for tight-knit groups, enable for club/competitive groups later
        };

        let allCheckins = {};
        let userPreferences = {};
        let coreMembers = [];
        let memberDetails = {}; // Stores details about who added each member
        let groupPin = '14675';
        let adminPin = '3250';
        let selectedDate = null;
        let selectedPreference = 'both';
        let currentEditingUser = null;
        let tempInclude = [];
        let tempExclude = [];
        let selectedName = '';
        let isGuest = false;
        let addedBy = '';
        let sessionUser = ''; // The actual person using the app (persists across check-ins)

        // Weather location (defaults to Los Gatos, CA)
        let weatherLocation = {
            lat: 37.2358,
            lon: -121.9623,
            name: 'Los Gatos, CA'
        };

        let weatherCache = {};

        // Firebase Data Loading and Sync
        async function loadAvailableGroups() {
            try {
                // Always check for old data to migrate first
                await migrateOldData();

                const groupsSnapshot = await firebaseRef.groups().once('value');
                availableGroups = groupsSnapshot.val() || {};

                console.log('Current groups in Firebase:', availableGroups);

                // If no groups exist, create default groups
                if (Object.keys(availableGroups).length === 0) {
                    console.log('No groups found, initializing defaults...');
                    await initializeDefaultGroups();
                    const groupsSnapshot2 = await firebaseRef.groups().once('value');
                    availableGroups = groupsSnapshot2.val() || {};
                    console.log('Groups after initialization:', availableGroups);
                }

                // Load site settings and initialize Google Analytics
                const siteSettingsSnapshot = await firebaseRef.siteSettings().once('value');
                const siteSettings = siteSettingsSnapshot.val() || {};
                if (siteSettings.gaTrackingId) {
                    initGoogleAnalytics(siteSettings.gaTrackingId);
                }

                return true;
            } catch (error) {
                console.error('Error loading groups:', error);
                return false;
            }
        }

        async function loadFirebaseData(groupId) {
            try {
                if (!groupId) {
                    console.log('No group ID provided');
                    return false;
                }

                // Load settings for the group
                const settingsSnapshot = await firebaseRef.settings(groupId).once('value');
                const settings = settingsSnapshot.val() || {};

                currentGroupName = settings.groupName || 'Unknown Group';
                coreMembers = settings.members || [];
                memberDetails = settings.memberDetails || {};
                groupPin = settings.groupPin || '14675';
                adminPin = settings.adminPin || '3250';

                // Load weather location (default to Los Gatos if not set)
                if (settings.location) {
                    weatherLocation = settings.location;
                } else {
                    weatherLocation = {
                        lat: 37.2358,
                        lon: -121.9623,
                        name: 'Los Gatos, CA'
                    };
                }

                // Load check-ins for the group
                const checkinsSnapshot = await firebaseRef.checkins(groupId).once('value');
                allCheckins = checkinsSnapshot.val() || {};

                // Load user preferences (shared across all groups)
                const prefsSnapshot = await firebaseRef.userPreferences().once('value');
                userPreferences = prefsSnapshot.val() || {};

                console.log(`Firebase data loaded for group: ${currentGroupName}`);
                return true;
            } catch (error) {
                console.error('Error loading Firebase data:', error);
                return false;
            }
        }

        async function migrateOldData() {
            // Check if migration has already been completed
            const migrationFlagSnapshot = await db.ref('_migrationCompleted').once('value');
            if (migrationFlagSnapshot.val() === true) {
                console.log('Migration already completed, skipping');
                return;
            }

            // Check if old data structure exists
            const oldSettingsSnapshot = await db.ref('settings').once('value');
            const oldSettings = oldSettingsSnapshot.val();

            console.log('Checking for old data at /settings:', oldSettings);

            if (oldSettings && oldSettings.coreMembers) {
                console.log('Found old data structure, migrating members:', oldSettings.coreMembers);

                // Migrate to new structure for Tue/Thu+ group
                await firebaseRef.settings('tue-thu-midday-doubles').update({
                    groupName: 'Tue/Thu+ Midday Doubles',
                    groupPin: oldSettings.groupPin || '14675',
                    adminPin: oldSettings.adminPin || '3250',
                    members: oldSettings.coreMembers || []
                });

                // Migrate old check-ins
                const oldCheckinsSnapshot = await db.ref('checkins').once('value');
                const oldCheckins = oldCheckinsSnapshot.val();
                if (oldCheckins) {
                    await firebaseRef.checkins('tue-thu-midday-doubles').set(oldCheckins);
                }

                // Set migration flag so this doesn't run again
                await db.ref('_migrationCompleted').set(true);

                console.log('Migration completed successfully');
            } else {
                // No old data exists, mark migration as complete
                await db.ref('_migrationCompleted').set(true);
                console.log('No old data found to migrate. Marking migration as complete.');
            }
        }

        async function initializeDefaultGroups() {
            // Check if groups already exist
            const groupsSnapshot = await firebaseRef.groups().once('value');
            const existingGroups = groupsSnapshot.val() || {};

            // Only create groups that don't exist yet
            if (!existingGroups['tue-thu-midday-doubles']) {
                await firebaseRef.group('tue-thu-midday-doubles').set({
                    settings: {
                        groupName: 'Tue/Thu+ Midday Doubles',
                        shortCode: 'ttmd',
                        groupPin: '14675',
                        adminPin: '3250',
                        members: [],
                        location: {
                            name: 'Los Gatos, CA',
                            lat: 37.2358,
                            lon: -121.9623
                        }
                    },
                    checkins: {}
                });
                console.log('Initialized tue-thu-midday-doubles group');
            }

            if (!existingGroups['singles-tuneup-tourny']) {
                await firebaseRef.group('singles-tuneup-tourny').set({
                    settings: {
                        groupName: '18+ Singles Tune-up Tourny',
                        shortCode: 'stt',
                        groupPin: '8888',
                        adminPin: '9999',
                        members: [],
                        location: {
                            name: 'Los Gatos, CA',
                            lat: 37.2358,
                            lon: -121.9623
                        }
                    },
                    checkins: {}
                });
                console.log('Initialized singles-tuneup-tourny group');
            }
        }

        let activeListeners = {
            settings: null,
            checkins: null,
            preferences: null
        };

        function setupFirebaseListeners(groupId) {
            if (!groupId) return;

            // Clean up old listeners if they exist
            if (activeListeners.settings) {
                activeListeners.settings.off();
            }
            if (activeListeners.checkins) {
                activeListeners.checkins.off();
            }
            if (activeListeners.preferences) {
                activeListeners.preferences.off();
            }

            // Listen for changes to settings for current group
            activeListeners.settings = firebaseRef.settings(groupId);
            activeListeners.settings.on('value', (snapshot) => {
                const settings = snapshot.val() || {};
                currentGroupName = settings.groupName || 'Unknown Group';
                coreMembers = settings.members || [];
                memberDetails = settings.memberDetails || {};
                groupPin = settings.groupPin || '14675';
                adminPin = settings.adminPin || '3250';
                populateNameDropdown();
                updateGroupDisplay();
            });

            // Listen for changes to check-ins for current group
            activeListeners.checkins = firebaseRef.checkins(groupId);
            activeListeners.checkins.on('value', (snapshot) => {
                try {
                    console.log('Firebase check-ins updated:', snapshot.val());
                    allCheckins = snapshot.val() || {};
                    console.log('Listener calling initDates()');
                    initDates();
                    console.log('Listener calling render()');
                    render();
                    console.log('Listener render() completed');
                } catch (error) {
                    console.error('Error in Firebase listener:', error);
                }
            });

            // Listen for changes to user preferences (shared)
            activeListeners.preferences = firebaseRef.userPreferences();
            activeListeners.preferences.on('value', (snapshot) => {
                userPreferences = snapshot.val() || {};
            });
        }

        let isSaving = false;

        async function saveFirebaseCheckins() {
            console.log('saveFirebaseCheckins called, currentGroupId:', currentGroupId);
            if (!currentGroupId) {
                console.error('Cannot save: currentGroupId is null');
                return;
            }
            try {
                isSaving = true;
                const checkinsForDate = allCheckins[selectedDate] || [];
                const savePath = `groups/${currentGroupId}/checkins/${selectedDate}`;

                console.log('=== SAVE DEBUG ===');
                console.log('Selected date:', selectedDate);
                console.log('Check-ins to save:', checkinsForDate);
                console.log('Full save path:', savePath);
                console.log('All checkins object:', allCheckins);
                console.log('=================');

                // Update only the specific date to avoid race conditions
                const ref = firebaseRef.checkins(currentGroupId).child(selectedDate);
                console.log('Firebase ref path:', ref.toString());
                await ref.set(checkinsForDate);

                console.log('Check-ins saved successfully, verifying...');

                // Verify the save by reading back
                const snapshot = await firebaseRef.checkins(currentGroupId).child(selectedDate).once('value');
                const savedData = snapshot.val();
                console.log('Verification read from path:', savePath);
                console.log('Verification data:', savedData);

                // Firebase returns null for empty arrays, so convert to array for comparison
                const savedDataArray = savedData || [];
                if (savedDataArray.length !== checkinsForDate.length) {
                    console.error('Verification mismatch:', { saved: savedDataArray.length, expected: checkinsForDate.length });
                    throw new Error('Data verification failed - saved data does not match');
                }

                console.log('Save verified successfully');
            } catch (error) {
                console.error('Error saving check-ins:', error);
                showToast('Error saving to database', 'error');
                throw error;
            } finally {
                isSaving = false;
            }
        }

        async function saveFirebaseSettings() {
            if (!currentGroupId) return;
            try {
                // Use update() instead of set() to preserve fields like shortCode
                await firebaseRef.settings(currentGroupId).update({
                    groupName: currentGroupName,
                    members: coreMembers,
                    memberDetails: memberDetails,
                    groupPin: groupPin,
                    adminPin: adminPin,
                    location: weatherLocation
                });
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        async function saveFirebasePreferences() {
            try {
                await firebaseRef.userPreferences().set(userPreferences);
            } catch (error) {
                console.error('Error saving preferences:', error);
            }
        }

        // PIN Authentication for specific group
        function checkAuth(groupId, groupName, correctPin) {
            const authKey = `tennisAuth_${groupId}`;
            const isAuth = sessionStorage.getItem(authKey);

            if (!isAuth) {
                const pin = prompt(`Enter PIN for ${groupName}:`);
                if (pin === null || pin === '') {
                    // User clicked cancel - deny access
                    return false;
                } else if (pin === correctPin) {
                    sessionStorage.setItem(authKey, 'true');
                    return true;
                } else {
                    alert('Invalid PIN. Try again.');
                    return checkAuth(groupId, groupName, correctPin); // Try again
                }
            }
            return true;
        }

        // Toast Notification System
        function showToast(message, type = 'success', action = null) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '‚úì' : '‚úï';
            let actionHtml = '';
            if (action) {
                actionHtml = `<button class="toast-action">${action.label}</button>`;
            }

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
                ${actionHtml}
            `;

            // Add click handler for action button
            if (action) {
                const actionBtn = toast.querySelector('.toast-action');
                actionBtn.addEventListener('click', () => {
                    action.onClick();
                    // Remove toast after action
                    toast.classList.add('removing');
                    setTimeout(() => {
                        if (toast.parentNode) container.removeChild(toast);
                    }, 300);
                });
            }

            container.appendChild(toast);

            // Auto-remove after specified duration (longer if there's an action)
            const duration = action ? 5000 : 3000;
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    if (toast.parentNode) container.removeChild(toast);
                }, 300); // Wait for animation to complete
            }, duration);
        }

        function normalizeName(name) {
            return name.trim().toLowerCase();
        }
        
        function handleNameSelect() {
            const select = document.getElementById('nameSelect');
            const value = select.value;
            const guestForm = document.getElementById('guestForm');
            const newMemberForm = document.getElementById('newMemberForm');
            const formFields = document.getElementById('checkInFormFields');

            if (value === '__GUEST__') {
                isGuest = true;
                selectedName = '';
                guestForm.classList.add('active');
                newMemberForm.style.display = 'none';
                populateAddedByDropdown();
                formFields.classList.add('expanded');
                // Auto-scroll to form after a brief delay for animation
                setTimeout(() => {
                    formFields.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else if (value === '__NEW_MEMBER__') {
                // Show new member form
                if (!sessionUser) {
                    showToast('Please select your name first', 'error');
                    select.value = '';
                    return;
                }
                guestForm.classList.remove('active');
                newMemberForm.style.display = 'block';
                document.getElementById('newMemberAddedBy').textContent = sessionUser;
                formFields.classList.add('expanded');
                // Auto-scroll to form after a brief delay for animation
                setTimeout(() => {
                    formFields.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else if (value !== '') {
                // Set session user if not already set (first time selecting a name)
                if (!sessionUser && !isGuest) {
                    sessionUser = value;
                    localStorage.setItem(`tennisSessionUser_${currentGroupId}`, value);
                    console.log('Session user set to:', sessionUser);
                    updateSessionUserDisplay();
                }

                isGuest = false;
                selectedName = value;
                addedBy = '';
                guestForm.classList.remove('active');
                newMemberForm.style.display = 'none';
                formFields.classList.add('expanded');
                // Auto-scroll to form after a brief delay for animation
                setTimeout(() => {
                    formFields.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else {
                // No name selected - collapse form
                formFields.classList.remove('expanded');
                guestForm.classList.remove('active');
                newMemberForm.style.display = 'none';
            }
        }
        
        function populateAddedByDropdown() {
            const select = document.getElementById('addedBySelect');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));
            select.innerHTML = '<option value="">Who is adding this guest?</option>' +
                sortedMembers.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        function populateNameDropdown() {
            const select = document.getElementById('nameSelect');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));

            // Initialize session user from localStorage
            if (currentGroupId && !sessionUser) {
                const savedSessionUser = localStorage.getItem(`tennisSessionUser_${currentGroupId}`);
                if (savedSessionUser) {
                    sessionUser = savedSessionUser;
                    console.log('Loaded session user from storage:', sessionUser);
                }
            }

            // Get remembered user name for this group (for backwards compatibility)
            const rememberedName = currentGroupId ? localStorage.getItem(`tennisUserName_${currentGroupId}`) : null;

            // Check if session user is already checked in for today
            const checkins = getCurrentCheckins();
            const sessionUserCheckedIn = sessionUser && checkins.some(c => normalizeName(c.name) === normalizeName(sessionUser));
            const placeholder = sessionUserCheckedIn ? 'Check in another player...' : 'Select your name...';

            // Only pre-select remembered name if they're NOT already checked in
            const shouldPreselect = rememberedName && !sessionUserCheckedIn;

            select.innerHTML = `<option value="">${placeholder}</option>` +
                sortedMembers.map(name => `<option value="${name}" ${name === rememberedName && shouldPreselect ? 'selected' : ''}>${name}</option>`).join('') +
                '<option value="__GUEST__">+ Add Guest</option>' +
                '<option value="__NEW_MEMBER__">+ Add New Member</option>';

            // If we pre-selected a name, update the selectedName variable and expand form
            if (shouldPreselect && sortedMembers.includes(rememberedName)) {
                selectedName = rememberedName;
                // Expand the form so user can check in
                document.getElementById('checkInFormFields').classList.add('expanded');
            } else if (sessionUserCheckedIn) {
                selectedName = '';
                // Collapse form when already checked in
                document.getElementById('checkInFormFields').classList.remove('expanded');
            }

            // Update session user display
            updateSessionUserDisplay();
        }

        function updateSessionUserDisplay() {
            const container = document.getElementById('userMenuContainer');
            const nameDisplay = document.getElementById('sessionUserNameBtn');
            const bellBtn = document.getElementById('notificationBellBtn');

            if (sessionUser) {
                nameDisplay.textContent = sessionUser;
                container.style.display = 'inline-block';
                bellBtn.style.display = 'flex';
                // Load notification prefs and items
                loadNotificationPrefs();
                loadNotifications();
            } else {
                container.style.display = 'none';
                bellBtn.style.display = 'none';
            }
        }

        // User menu functions
        function toggleUserMenu() {
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown.classList.toggle('active');

            // Close dropdown when clicking outside
            if (dropdown.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeUserMenuOnClickOutside);
                }, 0);
            }
        }

        function closeUserMenuOnClickOutside(e) {
            const container = document.getElementById('userMenuContainer');
            if (!container.contains(e.target)) {
                document.getElementById('userMenuDropdown').classList.remove('active');
                document.removeEventListener('click', closeUserMenuOnClickOutside);
            }
        }

        function confirmChangeUser() {
            document.getElementById('userMenuDropdown').classList.remove('active');
            if (confirm('Change logged-in user? This will clear your current session.')) {
                sessionUser = '';
                localStorage.removeItem(`tennisSessionUser_${currentGroupId}`);
                selectedName = '';
                document.getElementById('nameSelect').value = '';
                document.getElementById('checkInFormFields').classList.remove('expanded');
                updateSessionUserDisplay();
                showToast('Please select your name again', 'info');
            }
        }

        function openActivityModalFromMenu() {
            document.getElementById('userMenuDropdown').classList.remove('active');
            openActivityModal();
        }

        function openSettingsModalFromMenu() {
            document.getElementById('userMenuDropdown').classList.remove('active');
            openSettingsModal();
        }

        function openHelpFromMenu() {
            document.getElementById('userMenuDropdown').classList.remove('active');
            window.open('tennis-coordinator-help.md', '_blank');
        }

        // Notification preferences
        let userNotificationPrefs = {
            activityAlerts: false,
            matchConfirmations: false
        };
        let userNotifications = [];

        async function loadNotificationPrefs() {
            if (!sessionUser || !currentGroupId) return;

            try {
                const snapshot = await firebaseRef.userNotificationPrefs(currentGroupId, sessionUser).once('value');
                const prefs = snapshot.val();
                if (prefs) {
                    userNotificationPrefs = prefs;
                    document.getElementById('notifActivityAlerts').checked = prefs.activityAlerts || false;
                    document.getElementById('notifMatchConfirmations').checked = prefs.matchConfirmations || false;
                }
            } catch (error) {
                console.error('Error loading notification prefs:', error);
            }
        }

        async function saveNotificationPrefs() {
            if (!sessionUser || !currentGroupId) return;

            // Preserve mutedMembers when saving toggles
            const currentMuted = userNotificationPrefs.mutedMembers || [];

            userNotificationPrefs = {
                activityAlerts: document.getElementById('notifActivityAlerts').checked,
                matchConfirmations: document.getElementById('notifMatchConfirmations').checked,
                mutedMembers: currentMuted
            };

            try {
                await firebaseRef.userNotificationPrefs(currentGroupId, sessionUser).set(userNotificationPrefs);
                showToast('Notification preferences saved', 'success');
            } catch (error) {
                console.error('Error saving notification prefs:', error);
                showToast('Failed to save preferences', 'error');
            }
        }

        function openNotificationPrefsModal() {
            document.getElementById('userMenuDropdown').classList.remove('active');
            document.getElementById('notifActivityAlerts').checked = userNotificationPrefs.activityAlerts || false;
            document.getElementById('notifMatchConfirmations').checked = userNotificationPrefs.matchConfirmations || false;
            renderMutedMembersList();
            document.getElementById('notificationPrefsModal').classList.add('active');
        }

        function closeNotificationPrefsModal() {
            document.getElementById('notificationPrefsModal').classList.remove('active');
        }

        // Muted members functionality
        function renderMutedMembersList() {
            const container = document.getElementById('mutedMembersList');
            const mutedMembers = userNotificationPrefs.mutedMembers || [];

            if (mutedMembers.length === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 13px;">No members muted</span>';
                return;
            }

            container.innerHTML = mutedMembers.map(name => `
                <div style="display: inline-flex; align-items: center; gap: 6px; background: #f5f5f5; padding: 4px 8px 4px 12px; border-radius: 16px; font-size: 13px;">
                    <span>${name}</span>
                    <button onclick="unmuteMember('${name.replace(/'/g, "\\'")}')" style="background: none; border: none; cursor: pointer; padding: 2px; color: #999; font-size: 16px; line-height: 1;">&times;</button>
                </div>
            `).join('');
        }

        function openMuteMemberPicker() {
            const select = document.getElementById('muteMemberSelect');
            const mutedMembers = userNotificationPrefs.mutedMembers || [];

            // Populate with members not already muted (and not self)
            const availableMembers = coreMembers.filter(m =>
                normalizeName(m) !== normalizeName(sessionUser) &&
                !mutedMembers.some(muted => normalizeName(muted) === normalizeName(m))
            );

            select.innerHTML = '<option value="">Select a member...</option>' +
                availableMembers.map(m => `<option value="${m}">${m}</option>`).join('');

            document.getElementById('muteMemberPickerModal').style.display = 'flex';
        }

        function closeMuteMemberPicker() {
            document.getElementById('muteMemberPickerModal').style.display = 'none';
        }

        async function muteMember() {
            const select = document.getElementById('muteMemberSelect');
            const memberName = select.value;

            if (!memberName) {
                showToast('Please select a member', 'error');
                return;
            }

            const mutedMembers = userNotificationPrefs.mutedMembers || [];
            if (!mutedMembers.includes(memberName)) {
                mutedMembers.push(memberName);
            }

            userNotificationPrefs.mutedMembers = mutedMembers;

            try {
                await firebaseRef.userNotificationPrefs(currentGroupId, sessionUser).set(userNotificationPrefs);
                renderMutedMembersList();
                closeMuteMemberPicker();
                showToast(`Muted ${memberName}`, 'success');
            } catch (error) {
                console.error('Error muting member:', error);
                showToast('Failed to mute member', 'error');
            }
        }

        async function unmuteMember(memberName) {
            const mutedMembers = userNotificationPrefs.mutedMembers || [];
            const index = mutedMembers.findIndex(m => normalizeName(m) === normalizeName(memberName));

            if (index > -1) {
                mutedMembers.splice(index, 1);
            }

            userNotificationPrefs.mutedMembers = mutedMembers;

            try {
                await firebaseRef.userNotificationPrefs(currentGroupId, sessionUser).set(userNotificationPrefs);
                renderMutedMembersList();
                showToast(`Unmuted ${memberName}`, 'success');
            } catch (error) {
                console.error('Error unmuting member:', error);
                showToast('Failed to unmute member', 'error');
            }
        }

        // Check if a member is muted for the current user
        function isMemberMuted(memberName, userPrefs) {
            const mutedMembers = userPrefs.mutedMembers || [];
            return mutedMembers.some(m => normalizeName(m) === normalizeName(memberName));
        }

        // Notifications list
        async function loadNotifications() {
            if (!sessionUser || !currentGroupId) return;

            try {
                const snapshot = await firebaseRef.userNotifications(currentGroupId, sessionUser)
                    .orderByChild('timestamp')
                    .limitToLast(50)
                    .once('value');

                const items = snapshot.val();
                userNotifications = items ? Object.entries(items).map(([id, data]) => ({ id, ...data })).reverse() : [];
                renderNotifications();
                updateNotificationBadge();
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notificationsList');

            if (userNotifications.length === 0) {
                container.innerHTML = '<div class="notification-empty">No notifications yet</div>';
                return;
            }

            container.innerHTML = userNotifications.map(notif => {
                const timeAgo = getTimeAgo(notif.timestamp);
                const unreadClass = notif.read ? '' : 'unread';
                return `
                    <div class="notification-item ${unreadClass}" onclick="markNotificationRead('${notif.id}')">
                        <div class="notification-message">${notif.message}</div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = userNotifications.filter(n => !n.read).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        async function markNotificationRead(notifId) {
            if (!sessionUser || !currentGroupId) return;

            try {
                await firebaseRef.userNotifications(currentGroupId, sessionUser).child(notifId).update({ read: true });
                const notif = userNotifications.find(n => n.id === notifId);
                if (notif) notif.read = true;
                renderNotifications();
                updateNotificationBadge();
            } catch (error) {
                console.error('Error marking notification read:', error);
            }
        }

        async function clearAllNotifications() {
            if (!sessionUser || !currentGroupId) return;

            try {
                await firebaseRef.userNotifications(currentGroupId, sessionUser).remove();
                userNotifications = [];
                renderNotifications();
                updateNotificationBadge();
                showToast('Notifications cleared', 'success');
            } catch (error) {
                console.error('Error clearing notifications:', error);
                showToast('Failed to clear notifications', 'error');
            }
        }

        function openNotificationsModal() {
            loadNotifications();
            document.getElementById('notificationsModal').classList.add('active');
        }

        function closeNotificationsModal() {
            document.getElementById('notificationsModal').classList.remove('active');
        }

        // Create notification for a user
        async function createNotification(targetUserName, type, message, extraData = {}) {
            if (!currentGroupId) return;

            // Check if user has this notification type enabled
            try {
                const prefsSnapshot = await firebaseRef.userNotificationPrefs(currentGroupId, targetUserName).once('value');
                const prefs = prefsSnapshot.val() || {};

                // Check if notification type is enabled
                if (type === 'checkin' && !prefs.activityAlerts) return;
                if (type === 'match_formed' && !prefs.matchConfirmations) return;

                // Create the notification
                const notification = {
                    type,
                    message,
                    timestamp: Date.now(),
                    read: false,
                    ...extraData
                };

                await firebaseRef.userNotifications(currentGroupId, targetUserName).push(notification);
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        // Notify all users who have activity alerts enabled (except the person who checked in)
        async function notifyActivityAlert(checkinPlayerName, date, checkinData = {}) {
            if (!currentGroupId) return;

            const formattedDate = formatDateForNotification(date);

            // Build details string
            let details = [];
            if (checkinData.playStyle) {
                const styleLabel = checkinData.playStyle === 'singles' ? 'Singles' :
                                   checkinData.playStyle === 'doubles' ? 'Doubles' : 'Either';
                details.push(styleLabel);
            }
            if (checkinData.timeRange) {
                const timeStr = formatTimeRange(checkinData.timeRange.start, checkinData.timeRange.end);
                if (timeStr) details.push(timeStr);
            }

            // Show who added the check-in if different from the player
            let addedByStr = '';
            if (checkinData.addedBy && normalizeName(checkinData.addedBy) !== normalizeName(checkinPlayerName)) {
                addedByStr = ` (added by ${checkinData.addedBy})`;
            }

            const detailsStr = details.length > 0 ? ` [${details.join(', ')}]` : '';
            const message = `üéæ ${checkinPlayerName} checked in for ${formattedDate}${detailsStr}${addedByStr}`;

            // Get all users with notification prefs
            try {
                const snapshot = await db.ref(`groups/${currentGroupId}/userNotifications`).once('value');
                const allUserNotifs = snapshot.val() || {};

                for (const [userName, userData] of Object.entries(allUserNotifs)) {
                    // Don't notify the person who checked in
                    if (normalizeName(userName) === normalizeName(checkinPlayerName)) continue;

                    const prefs = userData.preferences || {};
                    if (prefs.activityAlerts) {
                        // Check if this user has muted the checking-in player
                        if (isMemberMuted(checkinPlayerName, prefs)) continue;

                        await createNotification(userName, 'checkin', message, { date, player: checkinPlayerName });
                    }
                }
            } catch (error) {
                console.error('Error sending activity alerts:', error);
            }
        }

        function formatDateForNotification(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        // Notify all users who have activity alerts enabled when someone removes themselves
        async function notifyRemovalAlert(removedPlayerName, date, removedBy = null) {
            if (!currentGroupId) return;

            const formattedDate = formatDateForNotification(date);

            // Show who removed if different from the player
            let removedByStr = '';
            if (removedBy && normalizeName(removedBy) !== normalizeName(removedPlayerName)) {
                removedByStr = ` (by ${removedBy})`;
            }

            const message = `üëã ${removedPlayerName} is no longer available for ${formattedDate}${removedByStr}`;

            // Get all users with notification prefs
            try {
                const snapshot = await db.ref(`groups/${currentGroupId}/userNotifications`).once('value');
                const allUserNotifs = snapshot.val() || {};

                for (const [userName, userData] of Object.entries(allUserNotifs)) {
                    // Don't notify the person who was removed
                    if (normalizeName(userName) === normalizeName(removedPlayerName)) continue;
                    // Don't notify the person who did the removal (if different)
                    if (removedBy && normalizeName(userName) === normalizeName(removedBy)) continue;

                    const prefs = userData.preferences || {};
                    if (prefs.activityAlerts) {
                        // Check if this user has muted the removed player
                        if (isMemberMuted(removedPlayerName, prefs)) continue;

                        await createNotification(userName, 'removal', message, { date, player: removedPlayerName });
                    }
                }
            } catch (error) {
                console.error('Error sending removal alerts:', error);
            }
        }

        // Track previous match state to detect new match formations
        let previousMatchState = {};

        async function checkAndNotifyMatchFormations(date) {
            const checkins = allCheckins[date] || [];
            if (checkins.length === 0) return;

            const { matches } = organizeMatches(checkins);
            const currentState = {};

            // Build current state of complete matches
            matches.forEach(match => {
                if (match.type === 'doubles' || match.type === 'singles') {
                    const playerNames = match.players.map(p => normalizeName(p.name)).sort().join(',');
                    currentState[playerNames] = {
                        type: match.type,
                        players: match.players.map(p => p.name)
                    };
                }
            });

            const prevState = previousMatchState[date] || {};

            // Find new matches (in current but not in previous)
            for (const [key, matchData] of Object.entries(currentState)) {
                if (!prevState[key]) {
                    // This is a new complete match - notify all players
                    const formattedDate = formatDateForNotification(date);
                    const otherPlayers = matchData.players;
                    const matchType = matchData.type === 'doubles' ? 'Doubles' : 'Singles';

                    for (const playerName of matchData.players) {
                        const teammates = otherPlayers.filter(p => normalizeName(p) !== normalizeName(playerName));
                        const message = `‚úÖ You're in ${matchType} for ${formattedDate} with ${teammates.join(', ')}`;
                        await createNotification(playerName, 'match_formed', message, { date, matchType });
                    }
                }
            }

            // Update previous state
            previousMatchState[date] = currentState;
        }

        function showWelcomeModal() {
            // Show group name
            document.getElementById('welcomeGroupName').textContent = currentGroupName || '';

            // Populate the welcome dropdown with member names
            const select = document.getElementById('welcomeNameSelect');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));
            select.innerHTML = '<option value="">Select your name...</option>' +
                sortedMembers.map(name => `<option value="${name}">${name}</option>`).join('');

            // Show the modal
            document.getElementById('welcomeModal').classList.add('active');
        }

        function onWelcomeNameSelect() {
            const select = document.getElementById('welcomeNameSelect');
            const name = select.value;

            if (!name) return; // Ignore if placeholder selected

            // Set as session user
            sessionUser = name;
            localStorage.setItem(`tennisSessionUser_${currentGroupId}`, name);
            localStorage.setItem(`tennisUserName_${currentGroupId}`, name);

            // Close modal
            document.getElementById('welcomeModal').classList.remove('active');

            // Update UI
            updateSessionUserDisplay();
            populateNameDropdown();

            showToast(`Welcome, ${name}!`, 'success');
        }

        function cancelNewMember() {
            document.getElementById('newMemberForm').style.display = 'none';
            document.getElementById('nameSelect').value = '';
            document.getElementById('checkInFormFields').classList.remove('expanded');
            // Clear form fields
            document.getElementById('newMemberNameInput').value = '';
            document.getElementById('newMemberPhoneInput').value = '';
            document.getElementById('newMemberEmailInput').value = '';
            document.getElementById('newMemberNotesInput').value = '';
        }

        async function submitNewMember() {
            const name = document.getElementById('newMemberNameInput').value.trim();
            const phone = document.getElementById('newMemberPhoneInput').value.trim();
            const email = document.getElementById('newMemberEmailInput').value.trim();
            const notes = document.getElementById('newMemberNotesInput').value.trim();

            if (!name) {
                showToast('Please enter member name', 'error');
                return;
            }

            // Check if member already exists
            if (coreMembers.includes(name)) {
                showToast(`${name} is already a member`, 'error');
                return;
            }

            if (!sessionUser) {
                showToast('Session user not set', 'error');
                return;
            }

            // Add member to coreMembers
            coreMembers.push(name);
            coreMembers.sort((a, b) => a.localeCompare(b));

            // Create or update memberDetails object
            if (!memberDetails) {
                memberDetails = {};
            }

            memberDetails[name] = {
                addedBy: sessionUser,
                addedDate: Date.now(),
                phone: phone || '',
                email: email || '',
                notes: notes || ''
            };

            // Save to Firebase
            try {
                await firebaseRef.settings(currentGroupId).update({
                    members: coreMembers,
                    memberDetails: memberDetails
                });

                showToast(`${name} added as member`, 'success');

                // Clear form and close
                cancelNewMember();

                // Refresh dropdown
                populateNameDropdown();

                // Log activity
                logActivity('member_added', name, {
                    addedBy: sessionUser,
                    phone: phone,
                    email: email
                });

                // Track in Google Analytics
                trackEvent('member_added');

                // Send notification to users with activity alerts enabled
                notifyNewMemberAdded(name, sessionUser);

                // If phone or email provided, prompt to invite
                if (phone || email) {
                    showInvitePrompt(name, phone, email);
                }

            } catch (error) {
                console.error('Error adding member:', error);
                showToast('Error adding member', 'error');
            }
        }

        // Show invite prompt after adding a new member
        function showInvitePrompt(memberName, phone, email) {
            const modal = document.getElementById('invitePromptModal');
            const content = document.getElementById('invitePromptContent');
            const inviteMessage = getInviteMessage(memberName);
            const escapedName = memberName.replace(/'/g, "\\'");

            // Check if Web Share API is available (mobile devices)
            const canShare = navigator.share !== undefined;

            let buttons = '';

            // If phone provided, show direct SMS button with number pre-filled
            if (phone) {
                const smsUrl = getSmsUrl(phone, inviteMessage);
                buttons += `<a href="${smsUrl}" onclick="setTimeout(closeInvitePrompt, 500)" style="background: #25D366; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; text-decoration: none;">
                    <span>üì±</span> Text ${phone}
                </a>`;
            }

            // If email provided, show direct Email button with address pre-filled
            if (email) {
                const gName = currentGroupName || 'Tennis Group';
                const emailUrl = getEmailUrl(email, `You're invited to ${gName}`, inviteMessage);
                buttons += `<a href="${emailUrl}" onclick="setTimeout(closeInvitePrompt, 500)" style="background: #4285F4; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; text-decoration: none;">
                    <span>üìß</span> Email
                </a>`;
            }

            // Add Share button if available (works great on mobile) - for other apps
            if (canShare) {
                buttons += `<button onclick="shareInvite('${escapedName}')" style="background: #9C27B0; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                    <span>üì§</span> Other
                </button>`;
            }

            // Copy to clipboard button (always available as fallback)
            buttons += `<button onclick="copyInviteMessage('${escapedName}')" style="background: #607D8B; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                <span>üìã</span> Copy
            </button>`;

            content.innerHTML = `
                <h3 style="margin: 0 0 12px 0; font-size: 16px;">Invite ${memberName}?</h3>
                <p style="margin: 0 0 16px 0; color: #666; font-size: 14px;">Send them an invite with the group link and PIN</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    ${buttons}
                </div>
                <button onclick="closeInvitePrompt()" style="margin-top: 12px; background: none; border: none; color: #999; font-size: 14px; cursor: pointer;">
                    Skip
                </button>
            `;

            modal.style.display = 'flex';
        }

        // Share using Web Share API (mobile)
        async function shareInvite(memberName) {
            const inviteMessage = getInviteMessage(memberName);
            const gName = currentGroupName || 'Tennis Group';

            try {
                await navigator.share({
                    title: `Join ${gName}`,
                    text: inviteMessage
                });
                closeInvitePrompt();
                showToast('Shared successfully!', 'success');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Share failed:', err);
                    // Fallback to copy
                    copyInviteMessage(memberName);
                }
            }
        }

        // Copy invite message to clipboard
        async function copyInviteMessage(memberName) {
            const inviteMessage = getInviteMessage(memberName);

            try {
                await navigator.clipboard.writeText(inviteMessage);
                closeInvitePrompt();
                showToast('Message copied! Paste in SMS or email.', 'success');
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = inviteMessage;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                closeInvitePrompt();
                showToast('Message copied! Paste in SMS or email.', 'success');
            }
        }

        function closeInvitePrompt() {
            document.getElementById('invitePromptModal').style.display = 'none';
        }

        function getInviteMessage(memberName) {
            const gName = currentGroupName || 'our tennis group';
            const groupUrl = window.location.href.split('?')[0] + '?group=' + currentGroupId;
            const pin = groupPin || '';

            return `Hi ${memberName}! You've been added to ${gName} tennis coordination.

Check in for upcoming matches here:
${groupUrl}

PIN: ${pin}

Just select your name and check in when you can play!`;
        }

        function getSmsUrl(phone, message) {
            // Clean phone number - remove spaces, dashes, parentheses
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            // Platform-specific SMS URL format:
            // iOS: sms:number&body=message (uses & separator)
            // Android/others: sms:number?body=message (uses ? separator)
            const userAgent = navigator.userAgent || '';
            const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
            return isIOS
                ? `sms:${cleanPhone}&body=${encodeURIComponent(message)}`
                : `sms:${cleanPhone}?body=${encodeURIComponent(message)}`;
        }

        function getEmailUrl(email, subject, body) {
            return `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function sendSmsInvite(memberName, phone) {
            const message = getInviteMessage(memberName);
            const smsUrl = getSmsUrl(phone, message);
            window.location.href = smsUrl;
            setTimeout(() => closeInvitePrompt(), 100);
        }

        function sendEmailInvite(memberName, email) {
            const groupName = currentSettings?.groupName || 'Tennis Group';
            const subject = `You're invited to ${groupName}`;
            const body = getInviteMessage(memberName);
            const emailUrl = getEmailUrl(email, subject, body);
            window.location.href = emailUrl;
            setTimeout(() => closeInvitePrompt(), 100);
        }

        // Notify users when a new member is added
        async function notifyNewMemberAdded(memberName, addedBy) {
            if (!currentGroupId) return;

            const message = `üëã ${memberName} was added to the group by ${addedBy}`;

            // Get all users with activity alerts enabled
            try {
                const snapshot = await firebaseRef.groupNotifications(currentGroupId).once('value');
                const allUserNotifications = snapshot.val() || {};

                for (const [normalizedName, userData] of Object.entries(allUserNotifications)) {
                    const prefs = userData.preferences || {};
                    if (prefs.activityAlerts) {
                        // Don't notify the person who added the member
                        if (normalizedName === normalizeName(addedBy)) continue;

                        // Add notification
                        const notifRef = firebaseRef.userNotifications(currentGroupId, normalizedName).push();
                        await notifRef.set({
                            message: message,
                            timestamp: Date.now(),
                            read: false,
                            type: 'member_added'
                        });
                    }
                }
            } catch (error) {
                console.error('Error sending new member notifications:', error);
            }
        }

        function openSettingsModal() {
            const pin = prompt('Enter admin PIN:');
            if (pin === null) {
                return; // User cancelled
            }
            if (pin !== adminPin) {
                alert('Invalid admin PIN - Only admin can access admin settings');
                return;
            }

            // Set admin session when successfully authenticated
            sessionStorage.setItem(`adminAuth_${currentGroupId}`, 'true');

            renderMemberList();
            document.getElementById('groupNameInput').value = currentGroupName;
            document.getElementById('adminPinInput').value = adminPin;
            document.getElementById('groupPinInput').value = groupPin;
            document.getElementById('adminGroupName').textContent = currentGroupName;
            document.getElementById('locationNameInput').value = weatherLocation.name;
            document.getElementById('locationLatInput').value = weatherLocation.lat;
            document.getElementById('locationLonInput').value = weatherLocation.lon;
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Site Admin Functions
        async function openSiteAdmin() {
            // Check site admin PIN
            const siteSettingsSnapshot = await firebaseRef.siteSettings().once('value');
            const siteSettings = siteSettingsSnapshot.val() || {};
            const siteAdminPin = siteSettings.siteAdminPin || 'Ilovetennis';

            // Initialize site admin PIN if doesn't exist
            if (!siteSettings.siteAdminPin) {
                await firebaseRef.siteSettings().set({ siteAdminPin: 'Ilovetennis' });
            }

            const pin = prompt('Enter Site Admin PIN:');
            if (pin === null) {
                window.location.href = '/';
                return;
            }

            if (pin !== siteAdminPin) {
                alert('Invalid Site Admin PIN');
                window.location.href = '/';
                return;
            }

            // Show site admin modal
            document.getElementById('siteAdminModal').classList.add('active');
            await renderGroupsTable();

            // Load and populate site settings (including GA tracking ID)
            document.getElementById('gaTrackingId').value = siteSettings.gaTrackingId || '';
        }

        async function saveSiteSettings() {
            const gaTrackingId = document.getElementById('gaTrackingId').value.trim();

            try {
                await firebaseRef.siteSettings().update({
                    gaTrackingId: gaTrackingId
                });

                // Reinitialize GA with new tracking ID
                if (gaTrackingId) {
                    initGoogleAnalytics(gaTrackingId);
                }

                showToast('Site settings saved');
            } catch (error) {
                console.error('Error saving site settings:', error);
                showToast('Error saving settings', 'error');
            }
        }

        function closeSiteAdmin() {
            document.getElementById('siteAdminModal').classList.remove('active');
            window.location.href = '/';
        }

        async function renderGroupsTable() {
            const groupsSnapshot = await firebaseRef.groups().once('value');
            const groups = groupsSnapshot.val() || {};

            const table = document.getElementById('groupsTable');

            if (Object.keys(groups).length === 0) {
                table.innerHTML = '<p style="color: #666;">No groups yet. Create one!</p>';
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f5f5f5;"><th style="padding: 12px; text-align: left;">Group Name</th><th>Short Code</th><th>Group PIN</th><th>Admin PIN</th><th>Actions</th></tr></thead><tbody>';

            for (const [groupId, groupData] of Object.entries(groups)) {
                const settings = groupData.settings || {};
                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;"><strong>${settings.groupName || groupId}</strong></td>
                        <td style="padding: 12px; text-align: center;"><code>${settings.shortCode || '-'}</code></td>
                        <td style="padding: 12px; text-align: center;">${settings.groupPin || '-'}</td>
                        <td style="padding: 12px; text-align: center;">${settings.adminPin || '-'}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="editGroup('${groupId}')" style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">‚úèÔ∏è Edit</button>
                            <button onclick="cloneGroup('${groupId}')" style="padding: 4px 8px; font-size: 12px; margin-right: 4px; background: #2196F3;">üìã Clone</button>
                            <button onclick="deleteGroup('${groupId}')" style="padding: 4px 8px; font-size: 12px; background: #f44336;">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            table.innerHTML = html;
        }

        function showCreateGroupForm() {
            document.getElementById('groupFormTitle').textContent = 'Create New Group';
            document.getElementById('editingGroupId').value = '';
            document.getElementById('formGroupName').value = '';
            document.getElementById('formShortCode').value = '';
            document.getElementById('formGroupPin').value = '';
            document.getElementById('formAdminPin').value = '';
            document.getElementById('formLocationName').value = 'Los Gatos, CA';
            document.getElementById('formLocationLat').value = '37.2358';
            document.getElementById('formLocationLon').value = '-121.9623';
            document.getElementById('groupForm').style.display = 'block';
        }

        async function editGroup(groupId) {
            const groupSnapshot = await firebaseRef.group(groupId).once('value');
            const groupData = groupSnapshot.val();
            const settings = groupData.settings || {};

            document.getElementById('groupFormTitle').textContent = 'Edit Group';
            document.getElementById('editingGroupId').value = groupId;
            document.getElementById('formGroupName').value = settings.groupName || '';
            document.getElementById('formShortCode').value = settings.shortCode || '';
            document.getElementById('formGroupPin').value = settings.groupPin || '';
            document.getElementById('formAdminPin').value = settings.adminPin || '';
            document.getElementById('formLocationName').value = settings.location?.name || 'Los Gatos, CA';
            document.getElementById('formLocationLat').value = settings.location?.lat || 37.2358;
            document.getElementById('formLocationLon').value = settings.location?.lon || -121.9623;
            document.getElementById('groupForm').style.display = 'block';
        }

        async function cloneGroup(sourceGroupId) {
            const groupSnapshot = await firebaseRef.group(sourceGroupId).once('value');
            const groupData = groupSnapshot.val();
            const settings = groupData.settings || {};

            document.getElementById('groupFormTitle').textContent = 'Clone Group';
            document.getElementById('editingGroupId').value = '';
            document.getElementById('formGroupName').value = (settings.groupName || '') + ' (Copy)';
            document.getElementById('formShortCode').value = '';
            document.getElementById('formGroupPin').value = settings.groupPin || '';
            document.getElementById('formAdminPin').value = settings.adminPin || '';
            document.getElementById('formLocationName').value = settings.location?.name || 'Los Gatos, CA';
            document.getElementById('formLocationLat').value = settings.location?.lat || 37.2358;
            document.getElementById('formLocationLon').value = settings.location?.lon || -121.9623;
            document.getElementById('groupForm').style.display = 'block';
        }

        async function saveGroup() {
            const editingGroupId = document.getElementById('editingGroupId').value;
            const groupName = document.getElementById('formGroupName').value.trim();
            const shortCode = document.getElementById('formShortCode').value.trim();
            const groupPin = document.getElementById('formGroupPin').value.trim();
            const adminPin = document.getElementById('formAdminPin').value.trim();
            const locationName = document.getElementById('formLocationName').value.trim();
            const locationLat = parseFloat(document.getElementById('formLocationLat').value);
            const locationLon = parseFloat(document.getElementById('formLocationLon').value);

            if (!groupName || !shortCode || !groupPin || !adminPin) {
                alert('Please fill in all required fields');
                return;
            }

            // Create slug from group name if editing, or use shortcode
            const groupId = editingGroupId || shortCode.toLowerCase().replace(/[^a-z0-9]+/g, '-');

            const groupData = {
                settings: {
                    groupName,
                    shortCode,
                    groupPin,
                    adminPin,
                    members: [],
                    location: {
                        name: locationName,
                        lat: locationLat,
                        lon: locationLon
                    }
                },
                checkins: {}
            };

            await firebaseRef.group(groupId).set(groupData);

            showToast(`Group "${groupName}" saved successfully!`, 'success');
            cancelGroupForm();
            await renderGroupsTable();

            // Reload available groups
            await loadAvailableGroups();
        }

        async function deleteGroup(groupId) {
            const groupSnapshot = await firebaseRef.group(groupId).once('value');
            const groupData = groupSnapshot.val();
            const groupName = groupData?.settings?.groupName || groupId;

            if (!confirm(`Are you sure you want to delete "${groupName}"? This cannot be undone.`)) {
                return;
            }

            await firebaseRef.group(groupId).remove();
            showToast(`Group "${groupName}" deleted`, 'success');
            await renderGroupsTable();
            await loadAvailableGroups();
        }

        function cancelGroupForm() {
            document.getElementById('groupForm').style.display = 'none';
        }

        // Group Selection Functions
        let selectedGroupIdTemp = null;

        async function openGroupSelector() {
            // Load available groups
            const groupsSnapshot = await firebaseRef.groups().once('value');
            availableGroups = groupsSnapshot.val() || {};

            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';

            Object.keys(availableGroups).forEach(groupId => {
                const groupSettings = availableGroups[groupId].settings || {};
                const groupName = groupSettings.groupName || groupId;

                const groupButton = document.createElement('button');
                groupButton.textContent = groupName;
                groupButton.style.cssText = 'width: 100%; margin-bottom: 8px; padding: 12px; font-size: 16px;';
                groupButton.onclick = () => promptForGroupPin(groupId, groupName);
                groupsList.appendChild(groupButton);
            });

            document.getElementById('groupPinSection').style.display = 'none';
            document.getElementById('groupSelectorModal').classList.add('active');
        }

        function promptForGroupPin(groupId, groupName) {
            selectedGroupIdTemp = groupId;
            document.getElementById('selectedGroupName').textContent = groupName;
            document.getElementById('groupsList').style.display = 'none';
            document.getElementById('groupPinSection').style.display = 'block';
            document.getElementById('groupPinEntry').value = '';
            document.getElementById('groupPinEntry').focus();
        }

        async function confirmGroupSelection() {
            const enteredPin = document.getElementById('groupPinEntry').value.trim();

            if (!selectedGroupIdTemp || !availableGroups[selectedGroupIdTemp]) {
                alert('Invalid group selection');
                return;
            }

            const groupSettings = availableGroups[selectedGroupIdTemp].settings || {};
            const correctPin = groupSettings.groupPin || '';

            if (enteredPin !== correctPin) {
                alert('Invalid PIN for this group');
                return;
            }

            // Store auth in session and navigate to group URL
            const authKey = `tennisAuth_${selectedGroupIdTemp}`;
            sessionStorage.setItem(authKey, 'true');

            // Navigate to the group's URL
            window.location.href = `/${selectedGroupIdTemp}`;
        }

        function cancelGroupSelection() {
            selectedGroupIdTemp = null;
            document.getElementById('groupsList').style.display = 'block';
            document.getElementById('groupPinSection').style.display = 'none';
        }

        function closeGroupSelector() {
            document.getElementById('groupSelectorModal').classList.remove('active');
            selectedGroupIdTemp = null;
        }

        async function selectGroup(groupId) {
            currentGroupId = groupId;

            // Load group settings
            const groupSettings = availableGroups[groupId]?.settings || {};
            currentGroupName = groupSettings.groupName || groupId;

            // Update global settings for this group
            coreMembers = groupSettings.members || [];
            groupPin = groupSettings.groupPin || '';
            adminPin = groupSettings.adminPin || '';

            // Load session user from localStorage (must happen before welcome modal check)
            const savedSessionUser = localStorage.getItem(`tennisSessionUser_${groupId}`);
            if (savedSessionUser) {
                sessionUser = savedSessionUser;
                console.log('Loaded session user in selectGroup:', sessionUser);
                updateSessionUserDisplay();
            }

            updateGroupDisplay();
            await loadFirebaseData(currentGroupId);
            setupFirebaseListeners(currentGroupId);
            render();
        }

        function updateGroupDisplay() {
            document.getElementById('groupNameDisplay').textContent = currentGroupName;
            document.getElementById('groupSubtitle').textContent = 'Tennis Coordinator';
            document.title = currentGroupName ? `${currentGroupName} - Tennis Coordinator` : 'Tennis Coordinator';
        }

        function renderMemberList() {
            const list = document.getElementById('memberList');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));
            list.innerHTML = sortedMembers.map((name) => {
                const details = memberDetails[name];
                let detailsHtml = '';
                const escapedName = name.replace(/'/g, "\\'");
                const hasContact = details && (details.phone || details.email);

                if (details) {
                    const addedDate = new Date(details.addedDate).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    // Support both old format (contact) and new format (phone/email)
                    let contactHtml = '';
                    if (details.phone) {
                        contactHtml += `<div>üì± ${details.phone}</div>`;
                    }
                    if (details.email) {
                        contactHtml += `<div>üìß ${details.email}</div>`;
                    }
                    // Fallback for old format
                    if (!details.phone && !details.email && details.contact) {
                        contactHtml = `<div>Contact: ${details.contact}</div>`;
                    }
                    detailsHtml = `
                        <div style="font-size: 12px; color: #666; margin-top: 4px; padding-left: 12px; border-left: 3px solid #4CAF50;">
                            <div>Added by: <strong>${details.addedBy}</strong> on ${addedDate}</div>
                            ${contactHtml}
                            ${details.notes ? `<div>Notes: ${details.notes}</div>` : ''}
                        </div>
                    `;
                }

                // Action buttons row
                const actionButtons = `
                    <div style="display: flex; gap: 6px; margin-top: 8px;">
                        <button onclick="editMemberContact('${escapedName}')" style="font-size: 12px; padding: 4px 8px; background: #f0f0f0; color: #333;">‚úèÔ∏è Edit</button>
                        ${hasContact ? `<button onclick="inviteMemberFromAdmin('${escapedName}')" style="font-size: 12px; padding: 4px 8px; background: #4CAF50; color: white;">üì® Invite</button>` : ''}
                    </div>
                `;

                return `
                    <div class="member-item" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; justify-content: space-between; width: 100%;">
                            <span>${name}</span>
                            <button onclick="removeCoreMember('${escapedName}')">Remove</button>
                        </div>
                        ${detailsHtml}
                        ${actionButtons}
                    </div>
                `;
            }).join('');
        }

        // Edit member contact info
        function editMemberContact(memberName) {
            const details = memberDetails[memberName] || {};
            const currentPhone = details.phone || '';
            const currentEmail = details.email || '';
            const currentNotes = details.notes || '';

            // Show edit modal
            const modal = document.getElementById('editMemberModal');
            document.getElementById('editMemberName').textContent = memberName;
            document.getElementById('editMemberPhone').value = currentPhone;
            document.getElementById('editMemberEmail').value = currentEmail;
            document.getElementById('editMemberNotes').value = currentNotes;
            modal.dataset.memberName = memberName;
            modal.style.display = 'flex';
        }

        function closeEditMemberModal() {
            document.getElementById('editMemberModal').style.display = 'none';
        }

        async function saveEditMember() {
            const modal = document.getElementById('editMemberModal');
            const memberName = modal.dataset.memberName;
            const phone = document.getElementById('editMemberPhone').value.trim();
            const email = document.getElementById('editMemberEmail').value.trim();
            const notes = document.getElementById('editMemberNotes').value.trim();

            if (!memberDetails[memberName]) {
                memberDetails[memberName] = {
                    addedBy: sessionUser || 'Unknown',
                    addedDate: Date.now()
                };
            }

            memberDetails[memberName].phone = phone;
            memberDetails[memberName].email = email;
            memberDetails[memberName].notes = notes;

            // Save to Firebase
            try {
                await firebaseRef.settings(currentGroupId).update({
                    memberDetails: memberDetails
                });
                showToast('Member updated', 'success');
                closeEditMemberModal();
                renderMemberList();
            } catch (error) {
                console.error('Error updating member:', error);
                showToast('Error updating member', 'error');
            }
        }

        // Invite member from admin interface
        function inviteMemberFromAdmin(memberName) {
            const details = memberDetails[memberName];
            if (!details) return;

            const phone = details.phone || '';
            const email = details.email || '';

            if (phone || email) {
                showInvitePrompt(memberName, phone, email);
            } else {
                showToast('No contact info for this member', 'error');
            }
        }
        
        function addCoreMember() {
            const input = document.getElementById('newMemberInput');
            const name = input.value.trim();

            if (!name) return;

            if (coreMembers.some(m => normalizeName(m) === normalizeName(name))) {
                alert('Member already exists');
                input.value = '';
                return;
            }

            coreMembers.push(name);

            // Track who added this member (admin)
            if (sessionUser) {
                if (!memberDetails) {
                    memberDetails = {};
                }
                memberDetails[name] = {
                    addedBy: sessionUser,
                    addedDate: Date.now(),
                    phone: '',
                    email: '',
                    notes: 'Added via admin settings'
                };
            }

            input.value = '';
            renderMemberList();
        }
        
        async function removeCoreMember(name) {
            if (confirm(`Remove ${name} from core members?`)) {
                const index = coreMembers.indexOf(name);
                if (index > -1) {
                    coreMembers.splice(index, 1);
                }
                // Also remove member details if they exist
                if (memberDetails[name]) {
                    delete memberDetails[name];
                }
                renderMemberList();

                // Log to activity history
                logActivity('member_removed', name, {
                    removedBy: sessionUser
                });

                // Track in Google Analytics
                trackEvent('member_removed');
            }
        }
        
        function saveSettings() {
            const newGroupName = document.getElementById('groupNameInput').value.trim();
            const newGroupPin = document.getElementById('groupPinInput').value.trim();
            const newAdminPin = document.getElementById('adminPinInput').value.trim();
            const locationName = document.getElementById('locationNameInput').value.trim();
            const locationLat = parseFloat(document.getElementById('locationLatInput').value);
            const locationLon = parseFloat(document.getElementById('locationLonInput').value);

            if (!newGroupName) {
                alert('Group name cannot be empty');
                return;
            }

            if (!newGroupPin || !newAdminPin) {
                alert('PINs cannot be empty');
                return;
            }

            // Validate location if provided
            if (locationName && (isNaN(locationLat) || isNaN(locationLon))) {
                alert('Please enter valid latitude and longitude coordinates');
                return;
            }

            // Update group name
            currentGroupName = newGroupName;
            groupPin = newGroupPin;
            adminPin = newAdminPin;

            // Update weather location if provided
            if (locationName && !isNaN(locationLat) && !isNaN(locationLon)) {
                weatherLocation = {
                    name: locationName,
                    lat: locationLat,
                    lon: locationLon
                };
            }

            saveFirebaseSettings();

            // Update UI with new group name
            updateGroupDisplay();

            showToast('Settings saved! Changes will sync to all users.', 'success');
            closeSettingsModal();
            populateNameDropdown();
        }
        
        async function fetchWeather(dateStr) {
            // Check cache first
            if (weatherCache[dateStr]) {
                return weatherCache[dateStr];
            }
            
            const widget = document.getElementById('weatherWidget');
            widget.innerHTML = '<div class="weather-loading">Loading weather...</div>';
            
            try {
                // Using Open-Meteo API (free, no key needed)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${weatherLocation.lat}&longitude=${weatherLocation.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode&temperature_unit=fahrenheit&timezone=America/Los_Angeles&forecast_days=14`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.daily || !data.daily.time) {
                    throw new Error('Invalid weather data format');
                }
                
                // Find the index for our selected date
                const dateIndex = data.daily.time.indexOf(dateStr);
                
                if (dateIndex === -1) {
                    throw new Error('Weather data not available for this date');
                }
                
                const weatherData = {
                    tempMax: Math.round(data.daily.temperature_2m_max[dateIndex]),
                    tempMin: Math.round(data.daily.temperature_2m_min[dateIndex]),
                    precipProb: data.daily.precipitation_probability_max[dateIndex] || 0,
                    weatherCode: data.daily.weathercode[dateIndex]
                };
                
                weatherCache[dateStr] = weatherData;
                return weatherData;
                
            } catch (error) {
                console.error('Weather fetch error:', error);
                widget.innerHTML = `<div class="weather-error">Unable to load weather (${error.message})</div>`;
                return null;
            }
        }
        
        function getWeatherDescription(code) {
            const weatherCodes = {
                0: '‚òÄÔ∏è Clear sky',
                1: 'üå§Ô∏è Mainly clear',
                2: '‚õÖ Partly cloudy',
                3: '‚òÅÔ∏è Overcast',
                45: 'üå´Ô∏è Foggy',
                48: 'üå´Ô∏è Foggy',
                51: 'üå¶Ô∏è Light drizzle',
                53: 'üå¶Ô∏è Drizzle',
                55: 'üåßÔ∏è Heavy drizzle',
                61: 'üåßÔ∏è Light rain',
                63: 'üåßÔ∏è Rain',
                65: 'üåßÔ∏è Heavy rain',
                71: 'üå®Ô∏è Light snow',
                73: 'üå®Ô∏è Snow',
                75: 'üå®Ô∏è Heavy snow',
                77: 'üå®Ô∏è Snow grains',
                80: 'üå¶Ô∏è Rain showers',
                81: 'üåßÔ∏è Rain showers',
                82: '‚õàÔ∏è Heavy rain showers',
                85: 'üå®Ô∏è Snow showers',
                86: 'üå®Ô∏è Heavy snow showers',
                95: '‚õàÔ∏è Thunderstorm',
                96: '‚õàÔ∏è Thunderstorm with hail',
                99: '‚õàÔ∏è Severe thunderstorm'
            };
            
            return weatherCodes[code] || 'üå°Ô∏è Weather';
        }
        
        async function displayWeather() {
            const widget = document.getElementById('weatherWidget');
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const daysFromToday = Math.floor((dateObj - today) / (1000 * 60 * 60 * 24));
            
            // Only show weather for next 14 days (API limitation)
            if (daysFromToday < 0 || daysFromToday > 13) {
                widget.innerHTML = '';
                return;
            }
            
            const weather = await fetchWeather(selectedDate);
            
            if (!weather) return;
            
            const dateDisplay = dateObj.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
            
            widget.innerHTML = `
                <div class="weather-widget" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f4ff 100%); border-radius: 10px; margin-bottom: 16px; font-size: 13px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-weight: 600; color: #1976d2;">${weatherLocation.name}</span>
                        <span style="color: #666;">‚Ä¢</span>
                        <span style="color: #666;">${getWeatherDescription(weather.weatherCode)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 600; color: #333;">${weather.tempMin}¬∞-${weather.tempMax}¬∞F</span>
                        ${weather.precipProb > 0 ? `<span style="color: #1976d2;">üíß${weather.precipProb}%</span>` : ''}
                    </div>
                </div>
            `;
        }
        
        function normalizeName(name) {
            return name.trim().toLowerCase();
        }
        
        function initDates() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            console.log('Today is:', today.toISOString().split('T')[0], '(', today, ')');

            if (!selectedDate) {
                selectedDate = today.toISOString().split('T')[0];
            }
            console.log('selectedDate:', selectedDate);

            const dateGrid = document.getElementById('dateGrid');
            const dates = [];

            // Show 30 days (weather only available for first 14)
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                dates.push(date);
            }
            
            dateGrid.innerHTML = dates.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();
                const month = date.toLocaleDateString('en-US', { month: 'short' });
                // Filter out empty array slots (sparse arrays from deleted items)
                const checkinCount = (allCheckins[dateStr] || []).filter(c => c).length;
                
                return `
                    <button class="date-btn ${dateStr === selectedDate ? 'selected' : ''}" 
                            onclick="selectDate('${dateStr}')">
                        <span class="day-name">${dayName}</span>
                        <span class="day-num">${dayNum}</span>
                        <span class="day-name">${month}</span>
                        ${checkinCount > 0 ? `<span class="checkin-badge">${checkinCount}</span>` : ''}
                    </button>
                `;
            }).join('');
        }
        
        async function selectDate(dateStr) {
            selectedDate = dateStr;
            await loadMatchNotes();
            initDates();
            displayWeather();
            render();
            // Update dropdown placeholder based on check-in status for new date
            populateNameDropdown();
        }
        
        function selectPreference(pref) {
            selectedPreference = pref;
            document.querySelectorAll('.preference-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById(pref + 'Btn').classList.add('selected');
        }
        
        function clearTimeInputs() {
            document.getElementById('startTimeInput').value = '';
            document.getElementById('endTimeInput').value = '';
        }

        function setTimePreset(startTime, endTime) {
            document.getElementById('startTimeInput').value = startTime;
            document.getElementById('endTimeInput').value = endTime;
        }

        function cancelCheckIn() {
            // Reset form and collapse
            document.getElementById('nameSelect').value = '';
            document.getElementById('guestNameInput').value = '';
            document.getElementById('addedBySelect').value = '';
            document.getElementById('checkInFormFields').classList.remove('expanded');
            document.getElementById('guestForm').classList.remove('active');
            clearTimeInputs();
            selectedName = '';
            isGuest = false;
        }

        // Check-in list toggle (collapsible)
        let checkinListExpanded = true;

        function toggleCheckinList() {
            checkinListExpanded = !checkinListExpanded;
            const list = document.getElementById('checkinList');
            const icon = document.getElementById('checkinToggleIcon');

            if (checkinListExpanded) {
                list.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                list.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function formatTimeRange(start, end) {
            if (!start && !end) return '';
            
            const format12Hour = (time24) => {
                if (!time24) return '';
                const [hours, minutes] = time24.split(':');
                const h = parseInt(hours);
                const ampm = h >= 12 ? 'PM' : 'AM';
                const h12 = h % 12 || 12;
                return `${h12}:${minutes}${ampm}`;
            };
            
            if (start && end) {
                return `${format12Hour(start)}-${format12Hour(end)}`;
            } else if (start) {
                return `from ${format12Hour(start)}`;
            } else if (end) {
                return `until ${format12Hour(end)}`;
            }
            return '';
        }
        
        function getCurrentCheckins() {
            // Filter out empty array slots to prevent sparse arrays
            const checkins = allCheckins[selectedDate] || [];
            return checkins.filter(c => c);
        }
        
        function setCurrentCheckins(checkins) {
            allCheckins[selectedDate] = checkins;
        }
        
        function openPreferencesModal() {
            if (!selectedName && !isGuest) {
                alert('Please select your name first');
                return;
            }
            
            const name = isGuest ? document.getElementById('guestNameInput').value.trim() : selectedName;
            
            if (!name) {
                alert('Please enter a name first');
                return;
            }
            
            currentEditingUser = normalizeName(name);
            const prefs = userPreferences[currentEditingUser] || { include: [], exclude: [] };
            tempInclude = [...prefs.include];
            tempExclude = [...prefs.exclude];
            
            renderPreferencesModal();
            document.getElementById('preferencesModal').classList.add('active');
        }
        
        function closePreferencesModal() {
            document.getElementById('preferencesModal').classList.remove('active');
            currentEditingUser = null;
        }

        // Activity Log Functions
        async function logActivity(action, playerName, details = {}) {
            if (!currentGroupId || !selectedDate) return;

            const activityEntry = {
                timestamp: Date.now(),
                action: action, // 'check-in' or 'removal'
                player: playerName,
                by: sessionUser || playerName,
                ...details
            };

            // Remove undefined values (Firebase doesn't accept them)
            Object.keys(activityEntry).forEach(key => {
                if (activityEntry[key] === undefined) {
                    delete activityEntry[key];
                }
            });

            try {
                await firebaseRef.activity(currentGroupId, selectedDate).push(activityEntry);
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        async function openActivityModal() {
            if (!selectedDate) {
                showToast('Please select a date first', 'error');
                return;
            }

            document.getElementById('activityModal').classList.add('active');

            // Show "Show All Dates" toggle for admins only
            const isAdmin = sessionStorage.getItem(`adminAuth_${currentGroupId}`) === 'true';
            const toggle = document.getElementById('showAllDatesToggle');
            if (isAdmin) {
                toggle.style.display = 'block';
            } else {
                toggle.style.display = 'none';
                document.getElementById('showAllDatesCheckbox').checked = false;
            }

            // Format date for display
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('activityDateDisplay').textContent = dateStr;

            // Load activity
            await loadActivityLog();
        }

        function closeActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
        }

        // Match Notes Functions
        async function loadMatchNotes() {
            if (!currentGroupId || !selectedDate) return;

            try {
                const snapshot = await firebaseRef.matchNotes(currentGroupId, selectedDate).once('value');
                matchNotes = snapshot.val() || {};
            } catch (error) {
                console.error('Error loading match notes:', error);
                matchNotes = {};
            }
        }

        // Debounce timers for match notes
        const noteDebounceTimers = {};

        async function saveMatchNote(matchKey, note) {
            if (!currentGroupId || !selectedDate) return;

            try {
                await firebaseRef.matchNotes(currentGroupId, selectedDate).child(matchKey).set(note);
                matchNotes[matchKey] = note;

                // Log activity for non-empty notes
                if (note && note.trim()) {
                    logActivity('notes_saved', sessionUser || 'Unknown', { matchKey: matchKey });

                    // Track in Google Analytics
                    trackEvent('match_note_saved', { match_type: matchKey.split('-')[0] });
                }

                showToast('Note saved', 'success');
            } catch (error) {
                console.error('Error saving match note:', error);
                showToast('Error saving note', 'error');
            }
        }

        // Debounced version - saves 1.5 seconds after user stops typing
        function saveMatchNoteDebounced(matchKey, note) {
            // Clear existing timer for this matchKey
            if (noteDebounceTimers[matchKey]) {
                clearTimeout(noteDebounceTimers[matchKey]);
            }

            // Set new timer
            noteDebounceTimers[matchKey] = setTimeout(() => {
                saveMatchNote(matchKey, note);
            }, 1500);
        }

        // Handle Enter key on note input - save immediately
        function handleNoteKeydown(event, matchKey) {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Clear any pending debounce
                if (noteDebounceTimers[matchKey]) {
                    clearTimeout(noteDebounceTimers[matchKey]);
                }
                saveMatchNote(matchKey, event.target.value);
                event.target.blur(); // Remove focus to indicate save complete
            }
        }

        function getMatchKey(matchType, matchNumber) {
            return `${matchType}-${matchNumber || 1}`;
        }

        async function loadActivityLog() {
            const listDiv = document.getElementById('activityList');
            const showAllDates = document.getElementById('showAllDatesCheckbox').checked;

            try {
                let allActivities = [];

                if (showAllDates) {
                    // Load activity from ALL dates
                    const allActivitySnapshot = await firebaseRef.activityAll(currentGroupId).once('value');
                    const allActivityData = allActivitySnapshot.val();

                    if (allActivityData) {
                        // Flatten all dates' activities into one array with date info
                        for (const [date, dateActivities] of Object.entries(allActivityData)) {
                            if (dateActivities) {
                                for (const activity of Object.values(dateActivities)) {
                                    allActivities.push({...activity, date});
                                }
                            }
                        }
                    }
                } else {
                    // Load activity for selected date only
                    const snapshot = await firebaseRef.activity(currentGroupId, selectedDate).once('value');
                    const activities = snapshot.val();

                    if (activities) {
                        allActivities = Object.values(activities).map(a => ({...a, date: selectedDate}));
                    }
                }

                if (allActivities.length === 0) {
                    listDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No activity recorded yet.</p>';
                    return;
                }

                // Sort by timestamp (newest first)
                allActivities.sort((a, b) => b.timestamp - a.timestamp);

                let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                let currentDate = null;

                for (const activity of allActivities) {
                    // Add date header if showing all dates and date changes
                    if (showAllDates && activity.date !== currentDate) {
                        currentDate = activity.date;
                        const dateObj = new Date(activity.date + 'T00:00:00');
                        const dateStr = dateObj.toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        html += `<div style="font-weight: bold; color: #666; margin-top: 12px; padding-bottom: 4px; border-bottom: 1px solid #ddd;">${dateStr}</div>`;
                    }

                    const time = formatTime(activity.timestamp);
                    let icon = '';
                    let actionDescription = '';

                    if (activity.action === 'check-in') {
                        icon = '‚úÖ';
                        actionDescription = `<strong>${activity.player}</strong> checked in`;
                        if (activity.by && activity.by !== activity.player) {
                            actionDescription += ` <span style="color: #999;">by ${activity.by}</span>`;
                        }
                        if (activity.playStyle) {
                            actionDescription += ` (${getPreferenceLabel(activity.playStyle)}`;
                            if (activity.timeRange) {
                                const start = activity.timeRange.start || '';
                                const end = activity.timeRange.end || '';
                                if (start || end) {
                                    actionDescription += `, ${start || 'anytime'}‚Äì${end || 'anytime'}`;
                                }
                            }
                            actionDescription += ')';
                        }
                    } else if (activity.action === 'removal') {
                        icon = '‚ùå';
                        if (activity.by && activity.by !== activity.player) {
                            actionDescription = `<strong>${activity.by}</strong> removed <strong>${activity.player}</strong>`;
                        } else {
                            actionDescription = `<strong>${activity.player}</strong> removed themselves`;
                        }
                    } else if (activity.action === 'member_added') {
                        icon = 'üë§';
                        actionDescription = `<strong>${activity.by}</strong> added <strong>${activity.player}</strong> as member`;
                        if (activity.contact || activity.notes) {
                            actionDescription += '<div style="font-size: 12px; color: #666; margin-top: 4px;">';
                            if (activity.contact) actionDescription += `Contact: ${activity.contact}<br>`;
                            if (activity.notes) actionDescription += `Notes: ${activity.notes}`;
                            actionDescription += '</div>';
                        }
                    } else if (activity.action === 'member_removed') {
                        icon = 'üö´';
                        actionDescription = `<strong>${activity.by}</strong> removed <strong>${activity.player}</strong> from members`;
                    } else if (activity.action === 'whatsapp_share') {
                        icon = 'üì§';
                        const shareType = activity.type === 'matches' ? 'matches' :
                                         activity.type === 'checkin' ? 'check-in' : 'removal';
                        actionDescription = `<strong>${activity.by}</strong> shared ${shareType} to WhatsApp`;
                        if (activity.player && activity.player !== activity.by) {
                            actionDescription += ` <span style="color: #999;">for ${activity.player}</span>`;
                        }
                    } else if (activity.action === 'notes_saved') {
                        icon = 'üìù';
                        const matchLabel = activity.matchKey ? activity.matchKey.replace('-', ' #') : 'match';
                        actionDescription = `<strong>${activity.by}</strong> added note to ${matchLabel}`;
                    }

                    html += `
                        <div style="padding: 10px; background: #f9f9f9; border-radius: 6px; font-size: 14px;">
                            <span style="margin-right: 6px;">${icon}</span>
                            ${actionDescription}
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">${time}</div>
                        </div>
                    `;
                }

                html += '</div>';
                listDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading activity:', error);
                listDiv.innerHTML = '<p style="color: #c00; text-align: center;">Error loading activity log.</p>';
            }
        }

        function addInclude() {
            const input = document.getElementById('includeInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            const normalized = normalizeName(name);
            
            if (normalized === currentEditingUser) {
                alert("You can't add yourself!");
                input.value = '';
                return;
            }
            
            if (tempInclude.includes(normalized)) {
                alert('Already in your include list');
                input.value = '';
                return;
            }
            
            // Remove from exclude if present
            const excludeIdx = tempExclude.indexOf(normalized);
            if (excludeIdx > -1) {
                tempExclude.splice(excludeIdx, 1);
            }
            
            tempInclude.push(normalized);
            input.value = '';
            renderPreferencesModal();
        }
        
        function addExclude() {
            const input = document.getElementById('excludeInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            const normalized = normalizeName(name);
            
            if (normalized === currentEditingUser) {
                alert("You can't add yourself!");
                input.value = '';
                return;
            }
            
            if (tempExclude.includes(normalized)) {
                alert('Already in your exclude list');
                input.value = '';
                return;
            }
            
            // Remove from include if present
            const includeIdx = tempInclude.indexOf(normalized);
            if (includeIdx > -1) {
                tempInclude.splice(includeIdx, 1);
            }
            
            tempExclude.push(normalized);
            input.value = '';
            renderPreferencesModal();
        }
        
        function removeInclude(name) {
            const idx = tempInclude.indexOf(name);
            if (idx > -1) {
                tempInclude.splice(idx, 1);
                renderPreferencesModal();
            }
        }
        
        function removeExclude(name) {
            const idx = tempExclude.indexOf(name);
            if (idx > -1) {
                tempExclude.splice(idx, 1);
                renderPreferencesModal();
            }
        }
        
        function renderPreferencesModal() {
            const excludeList = document.getElementById('excludeList');

            if (tempExclude.length === 0) {
                excludeList.innerHTML = '<div class="pref-summary">No exclusions set</div>';
            } else {
                excludeList.innerHTML = tempExclude.map(name => `
                    <div class="pref-tag exclude">
                        ${name}
                        <button onclick="removeExclude('${name}')">√ó</button>
                    </div>
                `).join('');
            }
        }
        
        function savePreferences() {
            userPreferences[currentEditingUser] = {
                include: tempInclude,
                exclude: tempExclude
            };

            saveFirebasePreferences();
            closePreferencesModal();
        }
        
        function checkIn() {
            let name, guestAddedBy;
            
            if (isGuest) {
                name = document.getElementById('guestNameInput').value.trim();
                guestAddedBy = document.getElementById('addedBySelect').value;
                
                if (!name) {
                    alert('Please enter guest name');
                    return;
                }
                
                if (!guestAddedBy) {
                    alert('Please select who is adding this guest');
                    return;
                }
            } else {
                name = selectedName;
                
                if (!name) {
                    alert('Please select your name');
                    return;
                }
            }
            
            const checkins = getCurrentCheckins();
            const normalized = normalizeName(name);
            
            if (checkins.some(c => normalizeName(c.name) === normalized)) {
                alert('Already checked in for this date!');
                return;
            }
            
            const startTime = document.getElementById('startTimeInput').value;
            const endTime = document.getElementById('endTimeInput').value;
            const allowRotation = document.getElementById('allowRotationCheckbox').checked;

            const checkinData = {
                name: name,
                timestamp: Date.now(),
                playStyle: selectedPreference,
                allowRotation: allowRotation
            };

            if (startTime || endTime) {
                checkinData.timeRange = {
                    start: startTime,
                    end: endTime
                };
            }

            // Track who added this check-in (for permission control)
            if (isGuest) {
                checkinData.isGuest = true;
                checkinData.addedBy = guestAddedBy;
            } else {
                // For regular members, track the session user who added them
                checkinData.addedBy = sessionUser || name; // Use sessionUser, fallback to name if checking in themselves
            }

            checkins.push(checkinData);

            setCurrentCheckins(checkins);

            // Log activity
            logActivity('check-in', name, {
                playStyle: checkinData.playStyle,
                timeRange: checkinData.timeRange
            });

            // Track in Google Analytics
            trackEvent('check_in', {
                play_style: checkinData.playStyle,
                is_guest: isGuest,
                has_time_range: !!(startTime || endTime)
            });

            // Send activity notifications to users who have them enabled
            notifyActivityAlert(name, selectedDate, checkinData);

            // Check if any new matches were formed and notify players
            setTimeout(() => checkAndNotifyMatchFormations(selectedDate), 500);

            // Remember user's name for next time (if not a guest)
            if (!isGuest && currentGroupId) {
                localStorage.setItem(`tennisUserName_${currentGroupId}`, name);
            }

            // Show success notification with WhatsApp share action
            const checkinDataForShare = {...checkinData}; // Copy for closure
            const nameForShare = name;
            showToast('Checked in successfully!', 'success', {
                label: 'üì± Share',
                onClick: () => sharePersonalCheckinToWhatsApp(nameForShare, checkinDataForShare)
            });

            // Reset form
            document.getElementById('nameSelect').value = '';
            document.getElementById('guestNameInput').value = '';
            document.getElementById('addedBySelect').value = '';
            document.getElementById('guestForm').classList.remove('active');
            document.getElementById('checkInFormFields').classList.remove('expanded');
            document.getElementById('allowRotationCheckbox').checked = true;
            clearTimeInputs();
            selectedName = '';
            isGuest = false;

            saveAndRender();
        }
        
        function removeCheckIn(index) {
            const checkins = getCurrentCheckins();
            const person = checkins[index];
            const personName = person ? person.name : 'this person';

            // Use sessionUser as the current user (the person using the app)
            const currentUser = sessionUser || localStorage.getItem(`tennisSessionUser_${currentGroupId}`) || selectedName;

            // Permission check: Can remove if you're the owner, the adder, or admin
            const isOwner = currentUser && normalizeName(currentUser) === normalizeName(personName);
            const isAdder = person && person.addedBy && currentUser && normalizeName(currentUser) === normalizeName(person.addedBy);
            const isAdmin = sessionStorage.getItem(`adminAuth_${currentGroupId}`) === 'true';

            console.log('Remove permission check:', { currentUser, personName, isOwner, isAdder, addedBy: person?.addedBy, isAdmin });

            if (!isOwner && !isAdder && !isAdmin) {
                showToast(`You can only remove check-ins you added`, 'error');
                return;
            }

            // Confirmation dialog
            if (!confirm(`Remove ${personName} from check-ins?`)) {
                return; // User cancelled
            }

            checkins.splice(index, 1);
            setCurrentCheckins(checkins);

            // Log activity
            logActivity('removal', personName);

            // Track in Google Analytics
            trackEvent('check_in_removal', {
                removed_self: isOwner
            });

            // Notify users with activity alerts
            notifyRemovalAlert(personName, selectedDate, sessionUser);

            saveAndRender();

            // If the removed person is the session user, re-expand the form so they can check in again
            const removedSelf = sessionUser && normalizeName(personName) === normalizeName(sessionUser);
            if (removedSelf) {
                // Re-select the user's name and expand the form
                const select = document.getElementById('nameSelect');
                select.value = sessionUser;
                selectedName = sessionUser;
                document.getElementById('checkInFormFields').classList.add('expanded');
            }

            // Show success notification with WhatsApp share action
            const nameForShare = personName;
            showToast(`Removed ${personName}`, 'success', {
                label: 'üì± Share',
                onClick: () => shareRemovalToWhatsApp(nameForShare)
            });
        }
        
        function resetAll() {
            // Admin-only function
            const isAdmin = sessionStorage.getItem(`adminAuth_${currentGroupId}`) === 'true';

            if (!isAdmin) {
                // Prompt for admin PIN
                const enteredPin = prompt('Enter Admin PIN to reset all check-ins:');
                if (enteredPin === null) return; // User cancelled

                if (enteredPin !== adminPin) {
                    showToast('Incorrect admin PIN', 'error');
                    return;
                }

                // Set admin session for this action
                sessionStorage.setItem(`adminAuth_${currentGroupId}`, 'true');
            }

            // Fix timezone bug - append T00:00:00 to parse in local time
            const dateDisplay = new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            if (confirm(`Reset all check-ins for ${dateDisplay}?`)) {
                setCurrentCheckins([]);
                saveAndRender();
                showToast('All check-ins reset', 'success');
            }
        }

        // WhatsApp Sharing Functions
        function formatMatchDetailsForWhatsApp() {
            const checkins = getCurrentCheckins();
            if (checkins.length === 0) {
                return '';
            }

            const { matches } = organizeMatches(checkins);

            // Format date - compact
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short',
                day: 'numeric'
            });

            // Start message - compact header
            let message = `${dateStr}\n`;

            // Add each match group
            let singlesCount = 0;
            let rotationCount = 0;

            matches.forEach(match => {
                if (match.type === 'doubles') {
                    const players = match.players.map(p => p.name);
                    message += `Doubles: ${players.join(', ')}\n`;

                    // Add time window if available - compact format
                    const times = match.players
                        .filter(p => p.timeRange)
                        .map(p => formatTimeRange(p.timeRange.start, p.timeRange.end));
                    if (times.length > 0) {
                        message += `${times[0]}\n`;
                    }

                    // Add note if exists
                    const matchKey = getMatchKey('doubles', match.number);
                    if (matchNotes[matchKey]) {
                        message += `üìù ${matchNotes[matchKey]}\n`;
                    }
                    message += '\n';
                } else if (match.type === 'singles') {
                    singlesCount++;
                    const players = match.players.map(p => p.name);
                    message += `Singles: ${players.join(', ')}\n`;

                    // Check if this is a "provisional" singles - both flexible and at least one open to rotation
                    const bothFlexible = match.players.every(p => (p.playStyle || 'both') === 'both');
                    const anyOpenToRotation = match.players.some(p => p.allowRotation === true);
                    if (bothFlexible && anyOpenToRotation) {
                        message += `Open to more players\n`;
                    }

                    // Add time window if available - compact format
                    const times = match.players
                        .filter(p => p.timeRange)
                        .map(p => formatTimeRange(p.timeRange.start, p.timeRange.end));
                    if (times.length > 0) {
                        message += `${times[0]}\n`;
                    }

                    // Add note if exists
                    const matchKey = getMatchKey('singles', singlesCount);
                    if (matchNotes[matchKey]) {
                        message += `üìù ${matchNotes[matchKey]}\n`;
                    }
                    message += '\n';
                } else if (match.type === 'singles-or-practice') {
                    rotationCount++;
                    message += `Rotation: ${match.players.map(p => p.name).join(', ')}\n`;

                    // Add time window if available - compact format
                    const times = match.players
                        .filter(p => p.timeRange)
                        .map(p => formatTimeRange(p.timeRange.start, p.timeRange.end));
                    if (times.length > 0) {
                        message += `${times[0]}\n`;
                    }

                    // Add note if exists
                    const matchKey = getMatchKey('rotation', rotationCount);
                    if (matchNotes[matchKey]) {
                        message += `üìù ${matchNotes[matchKey]}\n`;
                    }
                    message += '\n';
                } else if (match.type === 'doubles-forming') {
                    const players = match.players.map(p => p.name);
                    const neededText = match.needed === 1 ? 'need 1 more' : `need ${match.needed} more`;
                    message += `Doubles (forming): ${players.join(', ')}\n`;
                    message += `${neededText}\n`;

                    // Add fallback info
                    // Only show singles fallback if there are enough Either players
                    if (match.canRotate) {
                        message += `Can rotate if no 4th\n`;
                    } else if (match.canPlaySingles && match.eitherCount >= 2) {
                        message += `Will play singles if no more join\n`;
                    } else if (match.eitherCount === 1 && match.players.length === 1) {
                        // Only show this if the 1 Either player is alone
                        message += `Can play singles if 1 more joins\n`;
                    }

                    // Add time window if available
                    const times = match.players
                        .filter(p => p.timeRange)
                        .map(p => formatTimeRange(p.timeRange.start, p.timeRange.end));
                    if (times.length > 0) {
                        message += `${times[0]}\n`;
                    }

                    // Add note if exists
                    const matchKey = getMatchKey('doubles-forming', 1);
                    if (matchNotes[matchKey]) {
                        message += `üìù ${matchNotes[matchKey]}\n`;
                    }
                    message += '\n';
                } else if (match.type === 'singles-forming') {
                    const player = match.players[0];
                    message += `Singles (forming): ${player.name}\n`;
                    message += `need 1 more\n`;

                    if (player.timeRange) {
                        message += `${formatTimeRange(player.timeRange.start, player.timeRange.end)}\n`;
                    }
                    message += '\n';
                }
            });

            // Add standby list if any (on same line)
            const standbyMatches = matches.filter(m => m.type === 'waiting');
            if (standbyMatches.length > 0) {
                const standbyPlayers = standbyMatches.flatMap(m => m.players.map(p => p.name));
                message += `Standby: ${standbyPlayers.join(', ')}\n`;
            }

            // Add weather if available - compact format
            const weatherData = weatherCache[selectedDate];
            if (weatherData) {
                const weatherDesc = getWeatherDescription(weatherData.weatherCode);
                message += `${weatherDesc}, ${weatherData.tempMax}¬∞F`;
            }

            return message.trim();
        }

        function shareToWhatsApp() {
            const message = formatMatchDetailsForWhatsApp();
            if (!message) {
                showToast('No matches to share', 'error');
                return;
            }

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;

            // Log activity
            logActivity('whatsapp_share', sessionUser || 'Unknown', { type: 'matches' });

            // Track in Google Analytics
            trackEvent('whatsapp_share', { share_type: 'matches' });

            // Open WhatsApp in new window/tab
            window.open(whatsappUrl, '_blank');
        }

        // Personal Check-in WhatsApp Share
        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        function formatPersonalCheckinForWhatsApp(name, checkinData) {
            // Format date with ordinal
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const weekday = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            const month = dateObj.toLocaleDateString('en-US', { month: 'short' });
            const day = dateObj.getDate();
            const ordinal = getOrdinalSuffix(day);
            const dateStr = `${weekday}, ${month} ${day}${ordinal}`;

            // Determine if checking in self or someone else
            const checkingInSelf = !sessionUser || !checkinData.addedBy ||
                                   normalizeName(name) === normalizeName(sessionUser) ||
                                   normalizeName(name) === normalizeName(checkinData.addedBy);

            // Build message
            let message;
            if (checkingInSelf) {
                message = `I am in for ${dateStr}`;
            } else {
                message = `${name} is in for ${dateStr}`;
            }

            // Add play style preference - simplified text
            const playStyle = checkinData.playStyle || 'both';
            let playStyleText;
            if (playStyle === 'singles') {
                playStyleText = 'Singles Only';
            } else if (playStyle === 'doubles') {
                playStyleText = 'Doubles Only';
            } else {
                playStyleText = 'Doubles or Singles';
            }
            message += `\n${playStyleText}`;

            // Add time availability
            if (checkinData.timeRange && (checkinData.timeRange.start || checkinData.timeRange.end)) {
                const timeStr = formatTimeRange(checkinData.timeRange.start, checkinData.timeRange.end);
                message += `\n${timeStr}`;
            } else {
                message += `\nFlexible on time`;
            }

            return message;
        }

        function sharePersonalCheckinToWhatsApp(name, checkinData) {
            const message = formatPersonalCheckinForWhatsApp(name, checkinData);
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;

            // Log activity
            logActivity('whatsapp_share', sessionUser || 'Unknown', { type: 'checkin', player: name });

            // Track in Google Analytics
            trackEvent('whatsapp_share', { share_type: 'checkin' });

            window.open(whatsappUrl, '_blank');
        }

        // Personal Removal WhatsApp Share
        function formatRemovalForWhatsApp(name) {
            // Format date with ordinal
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const weekday = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            const month = dateObj.toLocaleDateString('en-US', { month: 'short' });
            const day = dateObj.getDate();
            const ordinal = getOrdinalSuffix(day);
            const dateStr = `${weekday}, ${month} ${day}${ordinal}`;

            // Determine if removing self or someone else
            const currentUser = sessionUser || localStorage.getItem(`tennisSessionUser_${currentGroupId}`);
            const removingSelf = !currentUser || normalizeName(name) === normalizeName(currentUser);

            // Build message
            let message;
            if (removingSelf) {
                message = `I am out for ${dateStr}`;
            } else {
                message = `${name} is out for ${dateStr}`;
            }

            return message;
        }

        function shareRemovalToWhatsApp(name) {
            const message = formatRemovalForWhatsApp(name);
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;

            // Log activity
            logActivity('whatsapp_share', sessionUser || 'Unknown', { type: 'removal', player: name });

            // Track in Google Analytics
            trackEvent('whatsapp_share', { share_type: 'removal' });

            window.open(whatsappUrl, '_blank');
        }

        async function saveAndRender() {
            try {
                console.log('saveAndRender called');
                await saveFirebaseCheckins();
                console.log('About to call initDates()');
                initDates();
                console.log('About to call render()');
                render();
                // Update dropdown placeholder based on check-in status
                populateNameDropdown();
                console.log('render() completed');
            } catch (error) {
                console.error('Error in saveAndRender:', error);
                showToast('Error updating display', 'error');
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();

            const timeStr = date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });

            if (isToday) {
                return timeStr;
            } else {
                // Show date for check-ins from previous days
                const dateStr = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
                return `${dateStr} ${timeStr}`;
            }
        }
        
        function getPreferenceLabel(pref) {
            if (pref === 'singles') return 'Singles';
            if (pref === 'doubles') return 'Doubles';
            return 'Either';
        }
        
        function getUserPrefs(name) {
            return userPreferences[normalizeName(name)] || { include: [], exclude: [] };
        }
        
        function canPlayTogether(name1, name2) {
            const prefs1 = getUserPrefs(name1);
            const prefs2 = getUserPrefs(name2);
            const n1 = normalizeName(name1);
            const n2 = normalizeName(name2);
            
            return !prefs1.exclude.includes(n2) && !prefs2.exclude.includes(n1);
        }
        
        function timesOverlap(time1, time2) {
            // If either has no time restriction, they can play together
            if (!time1 || !time2) return true;
            
            // If both have no start/end times, they're flexible
            if (!time1.start && !time1.end && !time2.start && !time2.end) return true;
            
            // Convert times to minutes for easier comparison
            const timeToMinutes = (timeStr) => {
                if (!timeStr) return null;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            
            // Get time ranges in minutes
            const t1Start = timeToMinutes(time1.start);
            const t1End = timeToMinutes(time1.end);
            const t2Start = timeToMinutes(time2.start);
            const t2End = timeToMinutes(time2.end);
            
            // Handle open-ended ranges
            // "from X" means X to end of day
            // "until X" means start of day to X
            const START_OF_DAY = 6 * 60;  // 6 AM
            const END_OF_DAY = 21 * 60;    // 9 PM
            
            const range1Start = t1Start || START_OF_DAY;
            const range1End = t1End || END_OF_DAY;
            const range2Start = t2Start || START_OF_DAY;
            const range2End = t2End || END_OF_DAY;
            
            // Check if ranges overlap
            // Ranges overlap if: start1 < end2 AND start2 < end1
            return range1Start < range2End && range2Start < range1End;
        }
        
        function canPlayTogetherWithTime(player1, player2) {
            // First check exclusion preferences
            if (!canPlayTogether(player1.name, player2.name)) {
                return false;
            }
            
            // Then check time overlap
            return timesOverlap(player1.timeRange, player2.timeRange);
        }
        
        function organizeMatches(checkins) {
            const matches = [];
            const warnings = [];
            let remaining = checkins.map((c, idx) => ({ ...c, originalIndex: idx }));

            // Separate by play style and sort by timestamp (first-come, first-served)
            remaining.sort((a, b) => a.timestamp - b.timestamp);

            const doublesOnly = remaining.filter(p => p.playStyle === 'doubles');
            const singlesOnly = remaining.filter(p => p.playStyle === 'singles');
            const either = remaining.filter(p => p.playStyle === 'both' || !p.playStyle);

            // === STEP 1: Form complete doubles matches ===
            // Doubles pool: Doubles Only + Either players (sorted by timestamp)
            let doublesPool = [...doublesOnly, ...either].sort((a, b) => a.timestamp - b.timestamp);

            while (doublesPool.length >= 4) {
                const group = doublesPool.slice(0, 4);
                matches.push({
                    type: 'doubles',
                    number: matches.filter(m => m.type === 'doubles').length + 1,
                    players: group
                });
                doublesPool.splice(0, 4);
            }

            // === STEP 2: Form singles matches from Singles Only players ===
            let singlesPool = [...singlesOnly].sort((a, b) => a.timestamp - b.timestamp);

            while (singlesPool.length >= 2) {
                let pair = null;

                // Find first valid pair respecting exclusions AND time overlap
                for (let i = 0; i < singlesPool.length - 1; i++) {
                    for (let j = i + 1; j < singlesPool.length; j++) {
                        if (canPlayTogetherWithTime(singlesPool[i], singlesPool[j])) {
                            pair = [singlesPool[i], singlesPool[j]];
                            break;
                        }
                    }
                    if (pair) break;
                }

                if (pair) {
                    matches.push({
                        type: 'singles',
                        players: pair
                    });
                    pair.forEach(p => {
                        const idx = singlesPool.findIndex(sp => sp.originalIndex === p.originalIndex);
                        if (idx > -1) singlesPool.splice(idx, 1);
                    });
                } else {
                    break;
                }
            }

            // === STEP 3: Handle remaining players ===
            // Remaining doubles pool (Either + Doubles Only not in complete doubles)
            // Remaining singles pool (Singles Only not in complete singles)

            const remainingDoublesPool = doublesPool; // 0-3 players wanting doubles
            const remainingSinglesPool = singlesPool; // Singles Only players without a partner

            // --- Handle doubles forming ---
            if (remainingDoublesPool.length > 0) {
                const needed = 4 - remainingDoublesPool.length;

                // Count "Either" players who can play singles as fallback
                const eitherPlayers = remainingDoublesPool.filter(p => p.playStyle === 'both' || !p.playStyle);
                const eitherCount = eitherPlayers.length;

                // Check if all are "Either" and allow rotation (for 3 players)
                const allEither = remainingDoublesPool.every(p => p.playStyle === 'both' || !p.playStyle);
                const allAllowRotation = remainingDoublesPool.every(p => p.allowRotation !== false);
                const canAllPlayTogether = remainingDoublesPool.length === 3 &&
                    canPlayTogetherWithTime(remainingDoublesPool[0], remainingDoublesPool[1]) &&
                    canPlayTogetherWithTime(remainingDoublesPool[0], remainingDoublesPool[2]) &&
                    canPlayTogetherWithTime(remainingDoublesPool[1], remainingDoublesPool[2]);

                // Check if 2+ Either players can play singles together (time overlap, no exclusions)
                let canPlaySingles = false;
                if (eitherCount >= 2) {
                    // Check if first two Either players can play together
                    canPlaySingles = canPlayTogetherWithTime(eitherPlayers[0], eitherPlayers[1]);
                }

                matches.push({
                    type: 'doubles-forming',
                    players: remainingDoublesPool,
                    needed: needed,
                    canRotate: remainingDoublesPool.length === 3 && allEither && allAllowRotation && canAllPlayTogether,
                    eitherCount: eitherCount,
                    canPlaySingles: canPlaySingles
                });
            }

            // --- Handle singles forming ---
            if (remainingSinglesPool.length > 0) {
                remainingSinglesPool.forEach(p => {
                    matches.push({
                        type: 'singles-forming',
                        players: [p],
                        needed: 1
                    });
                });
            }

            return { matches, warnings };
        }
        
        function getMatchIndicators(player, matchPlayers, matchType) {
            // Only show indicators for singles matches
            if (matchType !== 'singles') return '';
            
            const prefs = getUserPrefs(player.name);
            const indicators = [];
            
            matchPlayers.forEach(other => {
                if (other.name === player.name) return;
                
                const otherNorm = normalizeName(other.name);
                if (prefs.include.includes(otherNorm)) {
                    indicators.push(`<span class="match-indicator satisfied">‚úì with ${other.name}</span>`);
                }
            });
            
            return indicators.join(' ');
        }
        
        function render() {
            const checkins = getCurrentCheckins();
            console.log('render() called. selectedDate:', selectedDate, 'checkins:', checkins, 'allCheckins:', allCheckins);

            document.getElementById('count').textContent = checkins.length;
            
            const checkinList = document.getElementById('checkinList');
            if (checkins.length === 0) {
                checkinList.innerHTML = '<div class="empty-state">No check-ins yet</div>';
            } else {
                checkinList.innerHTML = checkins.map((c, i) => {
                    // Determine if this is the current user
                    const isCurrentUser = sessionUser && normalizeName(c.name) === normalizeName(sessionUser);
                    const itemClass = isCurrentUser ? 'checkin-item current-user' : 'checkin-item';
                    const userBadge = isCurrentUser ? '<span class="current-user-badge">YOU</span>' : '';

                    // Show who added this check-in
                    let addedByInfo = '';
                    if (c.isGuest) {
                        addedByInfo = `<span class="guest-indicator">guest of ${c.addedBy}</span>`;
                    } else if (c.addedBy && normalizeName(c.addedBy) !== normalizeName(c.name)) {
                        // Show "added by X" only if someone else added this check-in
                        addedByInfo = `<span class="guest-indicator">added by ${c.addedBy}</span>`;
                    }

                    const timeInfo = c.timeRange ? `<span class="time-badge">${formatTimeRange(c.timeRange.start, c.timeRange.end)}</span>` : '';
                    const rotationInfo = c.allowRotation === false ? `<span class="time-badge" style="background: #fff3e0; color: #e65100;">No 3s</span>` : '';

                    return `
                        <div class="${itemClass}">
                            <span>
                                <span class="checkin-name">${i + 1}. ${c.name}${userBadge} ${addedByInfo}${timeInfo}${rotationInfo}</span>
                                <span class="preference-badge ${c.playStyle || 'both'}">${getPreferenceLabel(c.playStyle || 'both')}</span>
                                <span class="checkin-time">${formatTime(c.timestamp)}</span>
                            </span>
                            <button class="remove-btn" onclick="removeCheckIn(${i})">Remove</button>
                        </div>
                    `;
                }).join('');
            }
            
            const matchesDiv = document.getElementById('matches');
            if (checkins.length === 0) {
                matchesDiv.innerHTML = '';
                return;
            }
            
            const { matches, warnings } = organizeMatches(checkins);
            let html = '<h2>Organized Matches</h2>';

            // Add WhatsApp share button if there are matches
            const hasMatches = matches.some(m => m.type !== 'waiting' || m.players.length > 0);
            if (hasMatches) {
                html += '<button class="share-whatsapp-btn" onclick="shareToWhatsApp()">üì± Share to WhatsApp</button>';
            }

            // Add reset button for admins (only if there are check-ins)
            if (checkins.length > 0) {
                const isAdmin = sessionStorage.getItem(`adminAuth_${currentGroupId}`) === 'true';
                if (isAdmin) {
                    html += '<button class="reset-day-btn" onclick="resetAll()" style="background: #f44336; color: white; margin-left: 8px;">üóëÔ∏è Reset This Day</button>';
                }
            }

            if (warnings.length > 0) {
                html += '<div class="warning-box">' + warnings.join('<br>') + '</div>';
            }
            
            let singlesCount = 0;
            let rotationCount = 0;

            matches.forEach(match => {
                if (match.type === 'doubles') {
                    const matchKey = getMatchKey('doubles', match.number);
                    const existingNote = matchNotes[matchKey] || '';
                    html += `
                        <div class="match-group">
                            <h3>Doubles ${match.number}</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                            <div class="match-notes">
                                <input type="text"
                                    placeholder="üìù Add note (court, time, etc.)"
                                    value="${existingNote.replace(/"/g, '&quot;')}"
                                    oninput="saveMatchNoteDebounced('${matchKey}', this.value)"
                                    onkeydown="handleNoteKeydown(event, '${matchKey}')"
                                    class="match-note-input">
                            </div>
                        </div>
                    `;
                } else if (match.type === 'singles') {
                    singlesCount++;
                    const matchKey = getMatchKey('singles', singlesCount);
                    const existingNote = matchNotes[matchKey] || '';

                    // Check if this is a "provisional" singles - both flexible and at least one open to rotation
                    const bothFlexible = match.players.every(p => (p.playStyle || 'both') === 'both');
                    const anyOpenToRotation = match.players.some(p => p.allowRotation === true);
                    const isProvisional = bothFlexible && anyOpenToRotation;

                    html += `
                        <div class="match-group singles-group">
                            <h3>Singles Match${singlesCount > 1 ? ' ' + singlesCount : ''}</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                            ${isProvisional ? '<p style="color: #666; font-size: 13px; margin: 8px 0 4px 0; font-style: italic;">Open to more players</p>' : ''}
                            <div class="match-notes">
                                <input type="text"
                                    placeholder="üìù Add note (court, time, etc.)"
                                    value="${existingNote.replace(/"/g, '&quot;')}"
                                    oninput="saveMatchNoteDebounced('${matchKey}', this.value)"
                                    onkeydown="handleNoteKeydown(event, '${matchKey}')"
                                    class="match-note-input">
                            </div>
                        </div>
                    `;
                } else if (match.type === 'singles-or-practice') {
                    rotationCount++;
                    const matchKey = getMatchKey('rotation', rotationCount);
                    const existingNote = matchNotes[matchKey] || '';
                    html += `
                        <div class="match-group singles-group">
                            <h3>Rotation (3 players) - 1v1 or 1v2</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                            <div class="match-notes">
                                <input type="text"
                                    placeholder="üìù Add note (court, time, etc.)"
                                    value="${existingNote.replace(/"/g, '&quot;')}"
                                    oninput="saveMatchNoteDebounced('${matchKey}', this.value)"
                                    onkeydown="handleNoteKeydown(event, '${matchKey}')"
                                    class="match-note-input">
                            </div>
                        </div>
                    `;
                } else if (match.type === 'doubles-forming') {
                    const matchKey = getMatchKey('doubles-forming', 1);
                    const existingNote = matchNotes[matchKey] || '';
                    const neededText = match.needed === 1 ? 'Need 1 more' : `Need ${match.needed} more`;

                    // Build fallback text based on situation
                    // Only show singles fallback if there are enough Either players (who can actually play singles)
                    let fallbackText = '';
                    if (match.canRotate) {
                        fallbackText = '<p style="color: #666; font-size: 13px; margin: 8px 0 4px 0; font-style: italic;">Can rotate if no 4th</p>';
                    } else if (match.canPlaySingles && match.eitherCount >= 2) {
                        fallbackText = '<p style="color: #666; font-size: 13px; margin: 8px 0 4px 0; font-style: italic;">Will play singles if no more join</p>';
                    } else if (match.eitherCount === 1 && match.players.length === 1) {
                        // Only show this if the 1 Either player is alone (not mixed with Doubles Only)
                        fallbackText = '<p style="color: #666; font-size: 13px; margin: 8px 0 4px 0; font-style: italic;">Can play singles if 1 more joins</p>';
                    }

                    html += `
                        <div class="match-group doubles-group" style="border-style: dashed;">
                            <h3>Doubles (forming) - ${neededText}</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                            ${fallbackText}
                            <div class="match-notes">
                                <input type="text"
                                    placeholder="üìù Add note (court, time, etc.)"
                                    value="${existingNote.replace(/"/g, '&quot;')}"
                                    oninput="saveMatchNoteDebounced('${matchKey}', this.value)"
                                    onkeydown="handleNoteKeydown(event, '${matchKey}')"
                                    class="match-note-input">
                            </div>
                        </div>
                    `;
                } else if (match.type === 'singles-forming') {
                    html += `
                        <div class="match-group singles-group" style="border-style: dashed;">
                            <h3>Singles (forming) - Need 1 more</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                } else if (match.type === 'waiting') {
                    const playerNames = match.players.map(p => p.name).join(', ');
                    html += `
                        <div class="match-group singles-group">
                            <h3>Standby: ${playerNames}</h3>
                        </div>
                    `;
                }
            });
            
            matchesDiv.innerHTML = html;
        }
        
        // Apply feature flags to UI
        function applyFeatureFlags() {
            // Show/hide exclude list feature based on config
            const prefsBtn = document.getElementById('prefsBtn');
            const excludeSection = document.getElementById('excludeSection');

            if (groupFeatures.excludeListForSingles) {
                if (prefsBtn) prefsBtn.style.display = 'inline-block';
                if (excludeSection) excludeSection.style.display = 'block';
            } else {
                if (prefsBtn) prefsBtn.style.display = 'none';
                if (excludeSection) excludeSection.style.display = 'none';
            }
        }

        // Initial setup
        async function init() {
            // Load available groups from Firebase
            await loadAvailableGroups();

            // Get group ID from URL path
            const urlGroupId = await getGroupIdFromUrl();

            if (urlGroupId === 'admin') {
                // Site admin route
                await openSiteAdmin();
                return;
            }

            if (urlGroupId && availableGroups[urlGroupId]) {
                // URL has a valid group - authenticate and load it
                const groupSettings = availableGroups[urlGroupId].settings || {};
                const groupName = groupSettings.groupName || urlGroupId;
                const groupPin = groupSettings.groupPin || '';

                if (checkAuth(urlGroupId, groupName, groupPin)) {
                    await selectGroup(urlGroupId);
                    // Show app, hide landing page
                    document.getElementById('appContainer').style.display = 'block';
                    document.getElementById('landingPage').style.display = 'none';

                    // Apply feature flags to UI
                    applyFeatureFlags();

                    // Track page view in Google Analytics
                    trackEvent('group_loaded');
                } else {
                    // Authentication failed - redirect to root
                    window.location.href = '/';
                    return;
                }
            } else {
                // No valid group in URL - show landing page
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('landingPage').style.display = 'block';
                return;
            }

            // Initialize UI
            initDates();
            await loadMatchNotes();
            displayWeather();
            render();

            // Show welcome modal for first-time users (no session user set)
            if (!sessionUser) {
                showWelcomeModal();
            }
        }

        // Create dynamic manifest based on current URL
        function createDynamicManifest() {
            const currentPath = window.location.pathname;
            const currentUrl = window.location.origin + currentPath;

            const manifest = {
                name: currentGroupName || "Tennis Coordinator",
                short_name: "Tennis",
                description: "Tennis match coordination and check-in system",
                start_url: currentPath || "/",
                display: "standalone",
                background_color: "#ffffff",
                theme_color: "#4CAF50",
                orientation: "portrait-primary",
                icons: [
                    {
                        src: window.location.origin + "/icon-192.png",
                        sizes: "192x192",
                        type: "image/png",
                        purpose: "any"
                    },
                    {
                        src: window.location.origin + "/icon-512.png",
                        sizes: "512x512",
                        type: "image/png",
                        purpose: "any"
                    },
                    {
                        src: window.location.origin + "/apple-touch-icon.png",
                        sizes: "180x180",
                        type: "image/png",
                        purpose: "any"
                    }
                ]
            };

            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);

            // Update manifest link
            const manifestLink = document.getElementById('manifestLink');
            if (manifestLink) {
                manifestLink.href = manifestURL;
            }
        }

        // Start the app
        init();

        // Create dynamic manifest after group is loaded
        setTimeout(createDynamicManifest, 1000);

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
