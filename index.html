<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tue/Thu+ Midday Doubles</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 12px;
            background: #f5f5f5;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-icon {
            background: transparent;
            color: #666;
            border: none;
            padding: 8px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-icon:hover {
            background: #f0f0f0;
        }
        
        .settings-icon:active {
            transform: scale(0.95);
        }
        
        .date-selector {
            margin-bottom: 16px;
        }
        
        .date-selector h2 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #666;
        }
        
        .date-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 16px;
        }
        
        .date-btn {
            padding: 6px 3px;
            background: #d0d0d0;
            color: #333;
            border: 2px solid #b0b0b0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 10px;
            transition: all 0.2s;
            min-height: 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .date-btn:active {
            transform: scale(0.95);
        }
        
        .date-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .date-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: 600;
        }
        
        .date-btn .day-name {
            font-size: 9px;
            text-transform: uppercase;
            opacity: 0.8;
            display: block;
        }

        .date-btn .day-num {
            font-size: 14px;
            font-weight: 600;
            display: block;
            margin: 2px 0;
        }
        
        .date-btn .checkin-badge {
            font-size: 9px;
            background: #ff9800;
            color: white;
            border-radius: 10px;
            padding: 2px 5px;
            margin-top: 2px;
            display: inline-block;
        }
        
        .date-btn.selected .checkin-badge {
            background: rgba(255,255,255,0.3);
        }
        
        .input-group {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        input {
            flex: 1 1 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            min-width: 0;
        }
        
        @media (min-width: 400px) {
            input {
                flex: 1 1 auto;
            }
        }
        
        .preference-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 16px;
        }
        
        .preference-btn {
            padding: 10px 6px;
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .preference-btn:active {
            transform: scale(0.95);
        }
        
        .preference-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .preference-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .preference-btn.singles.selected {
            background: #ff9800;
            border-color: #ff9800;
        }
        
        .preference-btn.doubles.selected {
            background: #2196F3;
            border-color: #2196F3;
        }
        
        input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            padding: 12px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 600;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:active {
            transform: scale(0.97);
        }
        
        button:hover {
            background: #45a049;
        }
        
        .reset-btn {
            background: #f44336;
            width: 100%;
            margin-top: 16px;
        }
        
        .reset-btn:hover {
            background: #da190b;
        }
        
        .checkins {
            margin: 16px 0;
        }
        
        .checkins h2 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #666;
        }
        
        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .checkin-item > span {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        @media (min-width: 500px) {
            .checkin-item > span {
                flex-direction: row;
                align-items: center;
                flex-wrap: wrap;
            }
        }
        
        .checkin-name {
            font-weight: 500;
            font-size: 15px;
        }
        
        .preference-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .preference-badge.singles {
            background: #fff3e0;
            color: #e65100;
        }
        
        .preference-badge.doubles {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .preference-badge.both {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .checkin-time {
            font-size: 12px;
            color: #999;
        }
        
        .remove-btn {
            padding: 8px 12px;
            background: #ff5252;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .matches {
            margin-top: 20px;
        }
        
        .match-group {
            margin-bottom: 16px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .match-group h3 {
            font-size: 15px;
            margin-bottom: 8px;
            color: #2e7d32;
        }
        
        .match-group ul {
            list-style: none;
            padding-left: 0;
        }
        
        .match-group li {
            padding: 6px 0;
            color: #333;
            font-size: 14px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
        }
        
        .singles-group {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        
        .singles-group h3 {
            color: #e65100;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: calc(100% - 40px);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-header h2 {
            font-size: 18px;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .pref-section {
            margin-bottom: 20px;
        }
        
        .pref-section h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .pref-section p {
            margin: 0 0 8px 0;
        }
        
        .pref-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .pref-input-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .pref-input-group button {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .pref-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .pref-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f5f5f5;
            border-radius: 16px;
            font-size: 13px;
        }
        
        .pref-tag.include {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .pref-tag.exclude {
            background: #ffebee;
            color: #c62828;
        }
        
        .pref-tag button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
            font-size: 16px;
            line-height: 1;
            opacity: 0.6;
        }
        
        .pref-tag button:hover {
            opacity: 1;
        }
        
        .pref-summary {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        
        .edit-prefs-btn {
            background: transparent;
            color: #4CAF50;
            border: 1px solid #4CAF50;
            padding: 6px 12px;
            font-size: 13px;
            margin-left: 8px;
        }
        
        .edit-prefs-btn:hover {
            background: #e8f5e9;
        }
        
        .match-indicator {
            font-size: 11px;
            margin-left: 4px;
        }
        
        .match-indicator.satisfied {
            color: #4CAF50;
        }
        
        .match-indicator.conflict {
            color: #f44336;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .member-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        
        .member-item button {
            padding: 6px 10px;
            background: #f44336;
            font-size: 12px;
        }
        
        .add-member-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .add-member-input input {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }
        
        .add-member-input button {
            padding: 10px 16px;
            font-size: 14px;
        }
        
        .guest-indicator {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            margin-bottom: 10px;
        }
        
        .guest-form {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .guest-form.active {
            display: block;
        }
        
        .guest-form input {
            margin-bottom: 8px;
        }
        
        .weather-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .weather-widget h3 {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .weather-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .weather-temp {
            font-size: 32px;
            font-weight: bold;
        }
        
        .weather-desc {
            font-size: 16px;
            text-transform: capitalize;
        }
        
        .weather-details {
            display: flex;
            justify-content: space-around;
            font-size: 12px;
            opacity: 0.9;
            margin-top: 8px;
        }
        
        .weather-error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .weather-loading {
            background: #e3f2fd;
            color: #1565c0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 13px;
        }
        
        .time-slots {
            margin-bottom: 16px;
        }
        
        .time-slots h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .time-slot-btn {
            padding: 10px 6px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
        }
        
        .time-slot-btn:active {
            transform: scale(0.95);
        }
        
        .time-slot-btn:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .time-slot-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: 600;
        }
        
        .time-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>
                <span id="groupNameDisplay">üéæ Tennis Coordinator</span>
                <br><small style="font-size: 12px; font-weight: 400; opacity: 0.8;">
                    <span id="groupSubtitle">Tennis Coordinator</span>
                </small>
            </span>
            <div style="display: flex; gap: 8px;">
                <button class="settings-icon" onclick="window.open('tennis-coordinator-help.md', '_blank')" title="Help">‚ùì</button>
                <button class="settings-icon" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
            </div>
        </h1>
        
        <div class="date-selector">
            <h2>Select Date</h2>
            <div class="date-grid" id="dateGrid"></div>
        </div>
        
        <div id="weatherWidget"></div>
        
        <div class="input-group">
            <select id="nameSelect" onchange="handleNameSelect()">
                <option value="">Select your name...</option>
            </select>
            <button class="edit-prefs-btn" onclick="openPreferencesModal()">‚öôÔ∏è</button>
            <button onclick="checkIn()">Check In</button>
        </div>
        
        <div class="guest-form" id="guestForm">
            <input 
                type="text" 
                id="guestNameInput" 
                placeholder="Guest's name"
            >
            <select id="addedBySelect">
                <option value="">Who is adding this guest?</option>
            </select>
        </div>
        
        <div class="preference-group">
            <button class="preference-btn singles" id="singlesBtn" onclick="selectPreference('singles')">
                Singles Only
            </button>
            <button class="preference-btn selected" id="bothBtn" onclick="selectPreference('both')">
                Either
            </button>
            <button class="preference-btn doubles" id="doublesBtn" onclick="selectPreference('doubles')">
                Doubles Only
            </button>
        </div>
        
        <div class="time-slots">
            <h3>Available Time (optional)</h3>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <input 
                    type="time" 
                    id="startTimeInput"
                    style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    placeholder="Start"
                >
                <span style="color: #666;">to</span>
                <input 
                    type="time" 
                    id="endTimeInput"
                    style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    placeholder="End"
                >
                <button 
                    onclick="clearTimeInputs()" 
                    style="padding: 10px 12px; background: #f5f5f5; color: #666; font-size: 13px;"
                >
                    Clear
                </button>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 6px;">
                Leave blank if available any time
            </div>
        </div>

        <div style="margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 14px;">
                <input
                    type="checkbox"
                    id="allowRotationCheckbox"
                    checked
                    style="width: 18px; height: 18px; cursor: pointer; margin-right: 4px;"
                >
                <span>Willing to play 3-player rotation (1v1 or 1v2 format)</span>
            </label>
            <div style="font-size: 12px; color: #666; margin-top: 4px; margin-left: 26px;">
                If unchecked, you'll only be placed in doubles or singles matches
            </div>
        </div>

        <div class="checkins">
            <h2>Check-ins (<span id="count">0</span>)</h2>
            <div id="checkinList"></div>
        </div>
        
        <div class="matches" id="matches"></div>
        
        <button class="reset-btn" onclick="resetAll()">Reset All</button>
    </div>
    
    <!-- Preferences Modal -->
    <div class="modal" id="preferencesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Singles Match Preferences</h2>
                <button class="close-btn" onclick="closePreferencesModal()">√ó</button>
            </div>

            <div class="pref-section">
                <h3>Exclude Players</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">You won't be paired with these players in singles matches</p>
                <div class="pref-input-group">
                    <input
                        type="text"
                        id="excludeInput"
                        placeholder="Enter name"
                        onkeypress="if(event.key==='Enter') addExclude()"
                    >
                    <button onclick="addExclude()">Add</button>
                </div>
                <div class="pref-list" id="excludeList"></div>
            </div>

            <button onclick="savePreferences()" style="width: 100%;">Save Preferences</button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Admin Settings</h2>
                <p style="font-size: 12px; color: #666; margin: 4px 0 0 0;">Managing: <strong id="adminGroupName">Current Group</strong></p>
                <button class="close-btn" onclick="closeSettingsModal()">√ó</button>
            </div>
            
            <div class="pref-section">
                <h3>Core Members</h3>
                <div class="member-list" id="memberList"></div>
                <div class="add-member-input">
                    <input 
                        type="text" 
                        id="newMemberInput" 
                        placeholder="New member name"
                        onkeypress="if(event.key==='Enter') addCoreMember()"
                    >
                    <button onclick="addCoreMember()">Add</button>
                </div>
            </div>
            
            <div class="pref-section">
                <h3>Admin PIN</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Required to access admin settings</p>
                <input
                    type="text"
                    id="adminPinInput"
                    value="3250"
                    style="width: 100%; margin-bottom: 12px;"
                >
            </div>

            <div class="pref-section">
                <h3>Group PIN</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Share this PIN with all group members to access the app</p>
                <input
                    type="text"
                    id="groupPinInput"
                    value="14675"
                    style="width: 100%; margin-bottom: 12px;"
                >
                <button onclick="saveSettings()" style="width: 100%;">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Group Selector Modal -->
    <div id="groupSelectorModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="margin-top: 0;">Select Tennis Group</h2>
            <div id="groupsList" style="margin-bottom: 20px;">
                <!-- Groups will be loaded here -->
            </div>
            <div id="groupPinSection" style="display: none;">
                <p style="font-size: 14px; color: #666; margin-bottom: 8px;">Enter PIN for <strong id="selectedGroupName"></strong>:</p>
                <input
                    type="password"
                    id="groupPinEntry"
                    placeholder="Enter group PIN"
                    style="width: 100%; margin-bottom: 12px;"
                    onkeypress="if(event.key === 'Enter') confirmGroupSelection()"
                >
                <div style="display: flex; gap: 8px;">
                    <button onclick="confirmGroupSelection()" style="flex: 1;">Access Group</button>
                    <button onclick="cancelGroupSelection()" style="flex: 1; background-color: #999;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCr-Ej5jeuV3kdvquu2W_R0ffSrUW0OUcQ",
            authDomain: "tennis-coordinator-43f53.firebaseapp.com",
            databaseURL: "https://tennis-coordinator-43f53-default-rtdb.firebaseio.com",
            projectId: "tennis-coordinator-43f53",
            storageBucket: "tennis-coordinator-43f53.firebasestorage.app",
            messagingSenderId: "665148711646",
            appId: "1:665148711646:web:66d14722800a12f5a3184f",
            measurementId: "G-J0KVB2Q93W"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase not configured. Please add your Firebase configuration.');
        }

        // Current selected group (determined by URL path)
        let currentGroupId = null;
        let currentGroupName = '';
        let availableGroups = {};

        // Parse group from URL path
        function getGroupIdFromUrl() {
            // Check if we were redirected from 404.html
            const redirect = sessionStorage.getItem('redirect');
            if (redirect) {
                sessionStorage.removeItem('redirect');
                const groupPath = redirect.replace(/^\/+|\/+$/g, '');
                if (groupPath && groupPath !== 'index.html') {
                    // Update browser URL without page reload
                    history.replaceState(null, '', redirect);
                    return groupPath;
                }
            }

            const path = window.location.pathname;
            // Remove leading/trailing slashes and get the group ID
            const groupPath = path.replace(/^\/+|\/+$/g, '');

            // If empty or index.html, return null (will show group selector)
            if (!groupPath || groupPath === 'index.html') {
                return null;
            }

            return groupPath;
        }

        // Firebase helper functions (group-scoped)
        const firebaseRef = {
            groups: () => db.ref('groups'),
            group: (groupId) => db.ref(`groups/${groupId}`),
            checkins: (groupId) => db.ref(`groups/${groupId}/checkins`),
            settings: (groupId) => db.ref(`groups/${groupId}/settings`),
            userPreferences: () => db.ref('userPreferences')
        };

        let allCheckins = {};
        let userPreferences = {};
        let coreMembers = [];
        let groupPin = '14675';
        let adminPin = '3250';
        let selectedDate = null;
        let selectedPreference = 'both';
        let currentEditingUser = null;
        let tempInclude = [];
        let tempExclude = [];
        let selectedName = '';
        let isGuest = false;
        let addedBy = '';
        
        // Los Gatos, CA coordinates
        const LOCATION = {
            lat: 37.2358,
            lon: -121.9623,
            name: 'Los Gatos, CA'
        };
        
        let weatherCache = {};

        // Firebase Data Loading and Sync
        async function loadAvailableGroups() {
            try {
                const groupsSnapshot = await firebaseRef.groups().once('value');
                availableGroups = groupsSnapshot.val() || {};

                // If no groups exist, create default groups
                if (Object.keys(availableGroups).length === 0) {
                    await initializeDefaultGroups();
                    const groupsSnapshot2 = await firebaseRef.groups().once('value');
                    availableGroups = groupsSnapshot2.val() || {};
                }

                return true;
            } catch (error) {
                console.error('Error loading groups:', error);
                return false;
            }
        }

        async function loadFirebaseData(groupId) {
            try {
                if (!groupId) {
                    console.log('No group ID provided');
                    return false;
                }

                // Load settings for the group
                const settingsSnapshot = await firebaseRef.settings(groupId).once('value');
                const settings = settingsSnapshot.val() || {};

                currentGroupName = settings.groupName || 'Unknown Group';
                coreMembers = settings.members || [];
                groupPin = settings.groupPin || '14675';
                adminPin = settings.adminPin || '3250';

                // Load check-ins for the group
                const checkinsSnapshot = await firebaseRef.checkins(groupId).once('value');
                allCheckins = checkinsSnapshot.val() || {};

                // Load user preferences (shared across all groups)
                const prefsSnapshot = await firebaseRef.userPreferences().once('value');
                userPreferences = prefsSnapshot.val() || {};

                console.log(`Firebase data loaded for group: ${currentGroupName}`);
                return true;
            } catch (error) {
                console.error('Error loading Firebase data:', error);
                return false;
            }
        }

        async function initializeDefaultGroups() {
            const defaultGroups = {
                'tue-thu-midday-doubles': {
                    settings: {
                        groupName: 'Tue/Thu+ Midday Doubles',
                        groupPin: '14675',
                        adminPin: '3250',
                        members: []
                    },
                    checkins: {}
                },
                'singles-tuneup-tourny': {
                    settings: {
                        groupName: '18+ Singles Tune-up Tourny',
                        groupPin: '8888',
                        adminPin: '9999',
                        members: []
                    },
                    checkins: {}
                }
            };

            await firebaseRef.groups().set(defaultGroups);
            console.log('Default groups initialized');
        }

        let activeListeners = {
            settings: null,
            checkins: null,
            preferences: null
        };

        function setupFirebaseListeners(groupId) {
            if (!groupId) return;

            // Clean up old listeners if they exist
            if (activeListeners.settings) {
                activeListeners.settings.off();
            }
            if (activeListeners.checkins) {
                activeListeners.checkins.off();
            }
            if (activeListeners.preferences) {
                activeListeners.preferences.off();
            }

            // Listen for changes to settings for current group
            activeListeners.settings = firebaseRef.settings(groupId);
            activeListeners.settings.on('value', (snapshot) => {
                const settings = snapshot.val() || {};
                currentGroupName = settings.groupName || 'Unknown Group';
                coreMembers = settings.members || [];
                groupPin = settings.groupPin || '14675';
                adminPin = settings.adminPin || '3250';
                populateNameDropdown();
                updateGroupDisplay();
            });

            // Listen for changes to check-ins for current group
            activeListeners.checkins = firebaseRef.checkins(groupId);
            activeListeners.checkins.on('value', (snapshot) => {
                allCheckins = snapshot.val() || {};
                initDates();
                render();
            });

            // Listen for changes to user preferences (shared)
            activeListeners.preferences = firebaseRef.userPreferences();
            activeListeners.preferences.on('value', (snapshot) => {
                userPreferences = snapshot.val() || {};
            });
        }

        async function saveFirebaseCheckins() {
            if (!currentGroupId) return;
            try {
                await firebaseRef.checkins(currentGroupId).set(allCheckins);
            } catch (error) {
                console.error('Error saving check-ins:', error);
            }
        }

        async function saveFirebaseSettings() {
            if (!currentGroupId) return;
            try {
                await firebaseRef.settings(currentGroupId).set({
                    groupName: currentGroupName,
                    members: coreMembers,
                    groupPin: groupPin,
                    adminPin: adminPin
                });
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        async function saveFirebasePreferences() {
            try {
                await firebaseRef.userPreferences().set(userPreferences);
            } catch (error) {
                console.error('Error saving preferences:', error);
            }
        }

        // PIN Authentication for specific group
        function checkAuth(groupId, groupName, correctPin) {
            const authKey = `tennisAuth_${groupId}`;
            const isAuth = sessionStorage.getItem(authKey);

            if (!isAuth) {
                const pin = prompt(`Enter PIN for ${groupName}:`);
                if (pin === null || pin === '') {
                    // User clicked cancel - deny access
                    return false;
                } else if (pin === correctPin) {
                    sessionStorage.setItem(authKey, 'true');
                    return true;
                } else {
                    alert('Invalid PIN. Try again.');
                    return checkAuth(groupId, groupName, correctPin); // Try again
                }
            }
            return true;
        }
        
        function normalizeName(name) {
            return name.trim().toLowerCase();
        }
        
        function handleNameSelect() {
            const select = document.getElementById('nameSelect');
            const value = select.value;
            const guestForm = document.getElementById('guestForm');
            
            if (value === '__GUEST__') {
                isGuest = true;
                selectedName = '';
                guestForm.classList.add('active');
                populateAddedByDropdown();
            } else {
                isGuest = false;
                selectedName = value;
                addedBy = '';
                guestForm.classList.remove('active');
            }
        }
        
        function populateAddedByDropdown() {
            const select = document.getElementById('addedBySelect');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));
            select.innerHTML = '<option value="">Who is adding this guest?</option>' +
                sortedMembers.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        function populateNameDropdown() {
            const select = document.getElementById('nameSelect');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));
            select.innerHTML = '<option value="">Select your name...</option>' +
                sortedMembers.map(name => `<option value="${name}">${name}</option>`).join('') +
                '<option value="__GUEST__">+ Add Guest</option>';
        }
        
        function openSettingsModal() {
            const pin = prompt('Enter admin PIN:');
            if (pin === null) {
                return; // User cancelled
            }
            if (pin !== adminPin) {
                alert('Invalid admin PIN - Only admin can access admin settings');
                return;
            }

            renderMemberList();
            document.getElementById('adminPinInput').value = adminPin;
            document.getElementById('groupPinInput').value = groupPin;
            document.getElementById('adminGroupName').textContent = currentGroupName;
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Group Selection Functions
        let selectedGroupIdTemp = null;

        async function openGroupSelector() {
            // Load available groups
            const groupsSnapshot = await firebaseRef.groups().once('value');
            availableGroups = groupsSnapshot.val() || {};

            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';

            Object.keys(availableGroups).forEach(groupId => {
                const groupSettings = availableGroups[groupId].settings || {};
                const groupName = groupSettings.groupName || groupId;

                const groupButton = document.createElement('button');
                groupButton.textContent = groupName;
                groupButton.style.cssText = 'width: 100%; margin-bottom: 8px; padding: 12px; font-size: 16px;';
                groupButton.onclick = () => promptForGroupPin(groupId, groupName);
                groupsList.appendChild(groupButton);
            });

            document.getElementById('groupPinSection').style.display = 'none';
            document.getElementById('groupSelectorModal').classList.add('active');
        }

        function promptForGroupPin(groupId, groupName) {
            selectedGroupIdTemp = groupId;
            document.getElementById('selectedGroupName').textContent = groupName;
            document.getElementById('groupsList').style.display = 'none';
            document.getElementById('groupPinSection').style.display = 'block';
            document.getElementById('groupPinEntry').value = '';
            document.getElementById('groupPinEntry').focus();
        }

        async function confirmGroupSelection() {
            const enteredPin = document.getElementById('groupPinEntry').value.trim();

            if (!selectedGroupIdTemp || !availableGroups[selectedGroupIdTemp]) {
                alert('Invalid group selection');
                return;
            }

            const groupSettings = availableGroups[selectedGroupIdTemp].settings || {};
            const correctPin = groupSettings.groupPin || '';

            if (enteredPin !== correctPin) {
                alert('Invalid PIN for this group');
                return;
            }

            // Store auth in session and navigate to group URL
            const authKey = `tennisAuth_${selectedGroupIdTemp}`;
            sessionStorage.setItem(authKey, 'true');

            // Navigate to the group's URL
            window.location.href = `/${selectedGroupIdTemp}`;
        }

        function cancelGroupSelection() {
            selectedGroupIdTemp = null;
            document.getElementById('groupsList').style.display = 'block';
            document.getElementById('groupPinSection').style.display = 'none';
        }

        function closeGroupSelector() {
            document.getElementById('groupSelectorModal').classList.remove('active');
            selectedGroupIdTemp = null;
        }

        async function selectGroup(groupId) {
            currentGroupId = groupId;

            // Load group settings
            const groupSettings = availableGroups[groupId]?.settings || {};
            currentGroupName = groupSettings.groupName || groupId;

            // Update global settings for this group
            coreMembers = groupSettings.members || [];
            groupPin = groupSettings.groupPin || '';
            adminPin = groupSettings.adminPin || '';

            updateGroupDisplay();
            await loadFirebaseData(currentGroupId);
            setupFirebaseListeners(currentGroupId);
            updateCheckinList();
            organizeMatches();
        }

        function updateGroupDisplay() {
            document.getElementById('groupNameDisplay').textContent = currentGroupName;
            document.getElementById('groupSubtitle').textContent = 'Tennis Coordinator';
        }

        function renderMemberList() {
            const list = document.getElementById('memberList');
            const sortedMembers = [...coreMembers].sort((a, b) => a.localeCompare(b));
            list.innerHTML = sortedMembers.map((name) => `
                <div class="member-item">
                    <span>${name}</span>
                    <button onclick="removeCoreMember('${name.replace(/'/g, "\\'")}')">Remove</button>
                </div>
            `).join('');
        }
        
        function addCoreMember() {
            const input = document.getElementById('newMemberInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            if (coreMembers.some(m => normalizeName(m) === normalizeName(name))) {
                alert('Member already exists');
                input.value = '';
                return;
            }
            
            coreMembers.push(name);
            input.value = '';
            renderMemberList();
        }
        
        function removeCoreMember(name) {
            if (confirm(`Remove ${name} from core members?`)) {
                const index = coreMembers.indexOf(name);
                if (index > -1) {
                    coreMembers.splice(index, 1);
                }
                renderMemberList();
            }
        }
        
        function saveSettings() {
            const newGroupPin = document.getElementById('groupPinInput').value.trim();
            const newAdminPin = document.getElementById('adminPinInput').value.trim();

            if (!newGroupPin || !newAdminPin) {
                alert('PINs cannot be empty');
                return;
            }

            groupPin = newGroupPin;
            adminPin = newAdminPin;
            saveFirebaseSettings();

            alert('Settings saved! Changes will sync to all users.');
            closeSettingsModal();
            populateNameDropdown();
        }
        
        async function fetchWeather(dateStr) {
            // Check cache first
            if (weatherCache[dateStr]) {
                return weatherCache[dateStr];
            }
            
            const widget = document.getElementById('weatherWidget');
            widget.innerHTML = '<div class="weather-loading">Loading weather...</div>';
            
            try {
                // Using Open-Meteo API (free, no key needed)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${LOCATION.lat}&longitude=${LOCATION.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode&temperature_unit=fahrenheit&timezone=America/Los_Angeles&forecast_days=14`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.daily || !data.daily.time) {
                    throw new Error('Invalid weather data format');
                }
                
                // Find the index for our selected date
                const dateIndex = data.daily.time.indexOf(dateStr);
                
                if (dateIndex === -1) {
                    throw new Error('Weather data not available for this date');
                }
                
                const weatherData = {
                    tempMax: Math.round(data.daily.temperature_2m_max[dateIndex]),
                    tempMin: Math.round(data.daily.temperature_2m_min[dateIndex]),
                    precipProb: data.daily.precipitation_probability_max[dateIndex] || 0,
                    weatherCode: data.daily.weathercode[dateIndex]
                };
                
                weatherCache[dateStr] = weatherData;
                return weatherData;
                
            } catch (error) {
                console.error('Weather fetch error:', error);
                widget.innerHTML = `<div class="weather-error">Unable to load weather (${error.message})</div>`;
                return null;
            }
        }
        
        function getWeatherDescription(code) {
            const weatherCodes = {
                0: '‚òÄÔ∏è Clear sky',
                1: 'üå§Ô∏è Mainly clear',
                2: '‚õÖ Partly cloudy',
                3: '‚òÅÔ∏è Overcast',
                45: 'üå´Ô∏è Foggy',
                48: 'üå´Ô∏è Foggy',
                51: 'üå¶Ô∏è Light drizzle',
                53: 'üå¶Ô∏è Drizzle',
                55: 'üåßÔ∏è Heavy drizzle',
                61: 'üåßÔ∏è Light rain',
                63: 'üåßÔ∏è Rain',
                65: 'üåßÔ∏è Heavy rain',
                71: 'üå®Ô∏è Light snow',
                73: 'üå®Ô∏è Snow',
                75: 'üå®Ô∏è Heavy snow',
                77: 'üå®Ô∏è Snow grains',
                80: 'üå¶Ô∏è Rain showers',
                81: 'üåßÔ∏è Rain showers',
                82: '‚õàÔ∏è Heavy rain showers',
                85: 'üå®Ô∏è Snow showers',
                86: 'üå®Ô∏è Heavy snow showers',
                95: '‚õàÔ∏è Thunderstorm',
                96: '‚õàÔ∏è Thunderstorm with hail',
                99: '‚õàÔ∏è Severe thunderstorm'
            };
            
            return weatherCodes[code] || 'üå°Ô∏è Weather';
        }
        
        async function displayWeather() {
            const widget = document.getElementById('weatherWidget');
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const daysFromToday = Math.floor((dateObj - today) / (1000 * 60 * 60 * 24));
            
            // Only show weather for next 14 days (API limitation)
            if (daysFromToday < 0 || daysFromToday > 13) {
                widget.innerHTML = '';
                return;
            }
            
            const weather = await fetchWeather(selectedDate);
            
            if (!weather) return;
            
            const dateDisplay = dateObj.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
            
            widget.innerHTML = `
                <div class="weather-widget">
                    <h3>${LOCATION.name} - ${dateDisplay}</h3>
                    <div class="weather-main">
                        <div class="weather-temp">${weather.tempMax}¬∞</div>
                        <div class="weather-desc">${getWeatherDescription(weather.weatherCode)}</div>
                    </div>
                    <div class="weather-details">
                        <span>High: ${weather.tempMax}¬∞F</span>
                        <span>Low: ${weather.tempMin}¬∞F</span>
                        <span>Rain: ${weather.precipProb}%</span>
                    </div>
                </div>
            `;
        }
        
        function normalizeName(name) {
            return name.trim().toLowerCase();
        }
        
        function initDates() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (!selectedDate) {
                selectedDate = today.toISOString().split('T')[0];
            }
            
            const dateGrid = document.getElementById('dateGrid');
            const dates = [];
            
            for (let i = 0; i < 14; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                dates.push(date);
            }
            
            dateGrid.innerHTML = dates.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();
                const month = date.toLocaleDateString('en-US', { month: 'short' });
                const checkinCount = (allCheckins[dateStr] || []).length;
                
                return `
                    <button class="date-btn ${dateStr === selectedDate ? 'selected' : ''}" 
                            onclick="selectDate('${dateStr}')">
                        <span class="day-name">${dayName}</span>
                        <span class="day-num">${dayNum}</span>
                        <span class="day-name">${month}</span>
                        ${checkinCount > 0 ? `<span class="checkin-badge">${checkinCount}</span>` : ''}
                    </button>
                `;
            }).join('');
        }
        
        function selectDate(dateStr) {
            selectedDate = dateStr;
            initDates();
            displayWeather();
            render();
        }
        
        function selectPreference(pref) {
            selectedPreference = pref;
            document.querySelectorAll('.preference-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById(pref + 'Btn').classList.add('selected');
        }
        
        function clearTimeInputs() {
            document.getElementById('startTimeInput').value = '';
            document.getElementById('endTimeInput').value = '';
        }
        
        function formatTimeRange(start, end) {
            if (!start && !end) return '';
            
            const format12Hour = (time24) => {
                if (!time24) return '';
                const [hours, minutes] = time24.split(':');
                const h = parseInt(hours);
                const ampm = h >= 12 ? 'PM' : 'AM';
                const h12 = h % 12 || 12;
                return `${h12}:${minutes}${ampm}`;
            };
            
            if (start && end) {
                return `${format12Hour(start)}-${format12Hour(end)}`;
            } else if (start) {
                return `from ${format12Hour(start)}`;
            } else if (end) {
                return `until ${format12Hour(end)}`;
            }
            return '';
        }
        
        function getCurrentCheckins() {
            return allCheckins[selectedDate] || [];
        }
        
        function setCurrentCheckins(checkins) {
            allCheckins[selectedDate] = checkins;
        }
        
        function openPreferencesModal() {
            if (!selectedName && !isGuest) {
                alert('Please select your name first');
                return;
            }
            
            const name = isGuest ? document.getElementById('guestNameInput').value.trim() : selectedName;
            
            if (!name) {
                alert('Please enter a name first');
                return;
            }
            
            currentEditingUser = normalizeName(name);
            const prefs = userPreferences[currentEditingUser] || { include: [], exclude: [] };
            tempInclude = [...prefs.include];
            tempExclude = [...prefs.exclude];
            
            renderPreferencesModal();
            document.getElementById('preferencesModal').classList.add('active');
        }
        
        function closePreferencesModal() {
            document.getElementById('preferencesModal').classList.remove('active');
            currentEditingUser = null;
        }
        
        function addInclude() {
            const input = document.getElementById('includeInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            const normalized = normalizeName(name);
            
            if (normalized === currentEditingUser) {
                alert("You can't add yourself!");
                input.value = '';
                return;
            }
            
            if (tempInclude.includes(normalized)) {
                alert('Already in your include list');
                input.value = '';
                return;
            }
            
            // Remove from exclude if present
            const excludeIdx = tempExclude.indexOf(normalized);
            if (excludeIdx > -1) {
                tempExclude.splice(excludeIdx, 1);
            }
            
            tempInclude.push(normalized);
            input.value = '';
            renderPreferencesModal();
        }
        
        function addExclude() {
            const input = document.getElementById('excludeInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            const normalized = normalizeName(name);
            
            if (normalized === currentEditingUser) {
                alert("You can't add yourself!");
                input.value = '';
                return;
            }
            
            if (tempExclude.includes(normalized)) {
                alert('Already in your exclude list');
                input.value = '';
                return;
            }
            
            // Remove from include if present
            const includeIdx = tempInclude.indexOf(normalized);
            if (includeIdx > -1) {
                tempInclude.splice(includeIdx, 1);
            }
            
            tempExclude.push(normalized);
            input.value = '';
            renderPreferencesModal();
        }
        
        function removeInclude(name) {
            const idx = tempInclude.indexOf(name);
            if (idx > -1) {
                tempInclude.splice(idx, 1);
                renderPreferencesModal();
            }
        }
        
        function removeExclude(name) {
            const idx = tempExclude.indexOf(name);
            if (idx > -1) {
                tempExclude.splice(idx, 1);
                renderPreferencesModal();
            }
        }
        
        function renderPreferencesModal() {
            const excludeList = document.getElementById('excludeList');

            if (tempExclude.length === 0) {
                excludeList.innerHTML = '<div class="pref-summary">No exclusions set</div>';
            } else {
                excludeList.innerHTML = tempExclude.map(name => `
                    <div class="pref-tag exclude">
                        ${name}
                        <button onclick="removeExclude('${name}')">√ó</button>
                    </div>
                `).join('');
            }
        }
        
        function savePreferences() {
            userPreferences[currentEditingUser] = {
                include: tempInclude,
                exclude: tempExclude
            };

            saveFirebasePreferences();
            closePreferencesModal();
        }
        
        function checkIn() {
            let name, guestAddedBy;
            
            if (isGuest) {
                name = document.getElementById('guestNameInput').value.trim();
                guestAddedBy = document.getElementById('addedBySelect').value;
                
                if (!name) {
                    alert('Please enter guest name');
                    return;
                }
                
                if (!guestAddedBy) {
                    alert('Please select who is adding this guest');
                    return;
                }
            } else {
                name = selectedName;
                
                if (!name) {
                    alert('Please select your name');
                    return;
                }
            }
            
            const checkins = getCurrentCheckins();
            const normalized = normalizeName(name);
            
            if (checkins.some(c => normalizeName(c.name) === normalized)) {
                alert('Already checked in for this date!');
                return;
            }
            
            const startTime = document.getElementById('startTimeInput').value;
            const endTime = document.getElementById('endTimeInput').value;
            const allowRotation = document.getElementById('allowRotationCheckbox').checked;

            const checkinData = {
                name: name,
                timestamp: Date.now(),
                playStyle: selectedPreference,
                allowRotation: allowRotation
            };

            if (startTime || endTime) {
                checkinData.timeRange = {
                    start: startTime,
                    end: endTime
                };
            }

            if (isGuest) {
                checkinData.isGuest = true;
                checkinData.addedBy = guestAddedBy;
            }
            
            checkins.push(checkinData);
            
            setCurrentCheckins(checkins);
            
            // Reset form
            document.getElementById('nameSelect').value = '';
            document.getElementById('guestNameInput').value = '';
            document.getElementById('addedBySelect').value = '';
            document.getElementById('guestForm').classList.remove('active');
            document.getElementById('allowRotationCheckbox').checked = true;
            clearTimeInputs();
            selectedName = '';
            isGuest = false;
            
            saveAndRender();
        }
        
        function removeCheckIn(index) {
            const checkins = getCurrentCheckins();
            checkins.splice(index, 1);
            setCurrentCheckins(checkins);
            saveAndRender();
        }
        
        function resetAll() {
            const dateDisplay = new Date(selectedDate).toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            if (confirm(`Reset all check-ins for ${dateDisplay}?`)) {
                setCurrentCheckins([]);
                saveAndRender();
            }
        }
        
        function saveAndRender() {
            saveFirebaseCheckins();
            initDates();
            render();
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }
        
        function getPreferenceLabel(pref) {
            if (pref === 'singles') return 'Singles';
            if (pref === 'doubles') return 'Doubles';
            return 'Either';
        }
        
        function getUserPrefs(name) {
            return userPreferences[normalizeName(name)] || { include: [], exclude: [] };
        }
        
        function canPlayTogether(name1, name2) {
            const prefs1 = getUserPrefs(name1);
            const prefs2 = getUserPrefs(name2);
            const n1 = normalizeName(name1);
            const n2 = normalizeName(name2);
            
            return !prefs1.exclude.includes(n2) && !prefs2.exclude.includes(n1);
        }
        
        function timesOverlap(time1, time2) {
            // If either has no time restriction, they can play together
            if (!time1 || !time2) return true;
            
            // If both have no start/end times, they're flexible
            if (!time1.start && !time1.end && !time2.start && !time2.end) return true;
            
            // Convert times to minutes for easier comparison
            const timeToMinutes = (timeStr) => {
                if (!timeStr) return null;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            
            // Get time ranges in minutes
            const t1Start = timeToMinutes(time1.start);
            const t1End = timeToMinutes(time1.end);
            const t2Start = timeToMinutes(time2.start);
            const t2End = timeToMinutes(time2.end);
            
            // Handle open-ended ranges
            // "from X" means X to end of day
            // "until X" means start of day to X
            const START_OF_DAY = 6 * 60;  // 6 AM
            const END_OF_DAY = 21 * 60;    // 9 PM
            
            const range1Start = t1Start || START_OF_DAY;
            const range1End = t1End || END_OF_DAY;
            const range2Start = t2Start || START_OF_DAY;
            const range2End = t2End || END_OF_DAY;
            
            // Check if ranges overlap
            // Ranges overlap if: start1 < end2 AND start2 < end1
            return range1Start < range2End && range2Start < range1End;
        }
        
        function canPlayTogetherWithTime(player1, player2) {
            // First check exclusion preferences
            if (!canPlayTogether(player1.name, player2.name)) {
                return false;
            }
            
            // Then check time overlap
            return timesOverlap(player1.timeRange, player2.timeRange);
        }
        
        function organizeMatches(checkins) {
            const matches = [];
            const warnings = [];
            let remaining = checkins.map((c, idx) => ({ ...c, originalIndex: idx }));
            
            // Separate by play style
            const doublesOnly = remaining.filter(p => p.playStyle === 'doubles');
            const singlesOnly = remaining.filter(p => p.playStyle === 'singles');
            const either = remaining.filter(p => p.playStyle === 'both');
            
            // Form doubles matches (NO preference filtering for doubles)
            let doublesPool = [...doublesOnly, ...either];
            const usedInDoubles = new Set();
            
            while (doublesPool.length >= 4) {
                // Just take first 4 players for doubles - no preference filtering
                const group = doublesPool.slice(0, 4);
                
                matches.push({
                    type: 'doubles',
                    number: matches.filter(m => m.type === 'doubles').length + 1,
                    players: group
                });
                
                // Mark these players as used in doubles
                group.forEach(p => usedInDoubles.add(p.originalIndex));
                
                // Remove from pool
                doublesPool.splice(0, 4);
            }
            
            // Form singles matches (WITH preference filtering AND time overlap)
            // Only include: singles-only players + "either" players not used in doubles
            let singlesPool = [
                ...singlesOnly,
                ...doublesPool.filter(p => p.playStyle === 'both')
            ];

            // Special case: if exactly 3 players in singles pool, try rotation first
            if (singlesPool.length === 3) {
                const canAll3Play =
                    canPlayTogetherWithTime(singlesPool[0], singlesPool[1]) &&
                    canPlayTogetherWithTime(singlesPool[0], singlesPool[2]) &&
                    canPlayTogetherWithTime(singlesPool[1], singlesPool[2]);

                // Check if all 3 are willing to play rotation
                const allAllowRotation =
                    (singlesPool[0].allowRotation !== false) &&
                    (singlesPool[1].allowRotation !== false) &&
                    (singlesPool[2].allowRotation !== false);

                if (canAll3Play && allAllowRotation) {
                    matches.push({
                        type: 'singles-or-practice',
                        players: [...singlesPool]
                    });
                    singlesPool = []; // Clear the pool
                }
            }

            while (singlesPool.length >= 2) {
                let pair = null;
                
                // Try to find a valid pair respecting exclusions AND time overlap
                for (let i = 0; i < singlesPool.length - 1; i++) {
                    for (let j = i + 1; j < singlesPool.length; j++) {
                        if (canPlayTogetherWithTime(singlesPool[i], singlesPool[j])) {
                            pair = [singlesPool[i], singlesPool[j]];
                            break;
                        }
                    }
                    if (pair) break;
                }
                
                if (pair) {
                    matches.push({
                        type: 'singles',
                        players: pair
                    });
                    
                    // Remove from pool
                    pair.forEach(p => {
                        const idx = singlesPool.findIndex(sp => sp.originalIndex === p.originalIndex);
                        if (idx > -1) singlesPool.splice(idx, 1);
                    });
                } else {
                    // No valid pairs possible due to exclusions or time conflicts
                    break;
                }
            }
            
            // Handle remaining (only from singlesPool and doubles-only players in doublesPool)
            const allRemaining = [
                ...doublesPool.filter(p => p.playStyle === 'doubles'),
                ...singlesPool
            ];
            
            if (allRemaining.length === 3) {
                // Check if they can all play together (preferences AND time)
                const canAll3Play = allRemaining.length === 3 && 
                    canPlayTogetherWithTime(allRemaining[0], allRemaining[1]) &&
                    canPlayTogetherWithTime(allRemaining[0], allRemaining[2]) &&
                    canPlayTogetherWithTime(allRemaining[1], allRemaining[2]);
                
                if (canAll3Play) {
                    matches.push({
                        type: 'singles-or-practice',
                        players: allRemaining
                    });
                } else {
                    // Can't all play together
                    warnings.push(`3 remaining players have conflicts (preferences or time) - placed in waiting`);
                    allRemaining.forEach(p => {
                        matches.push({
                            type: 'waiting',
                            players: [p]
                        });
                    });
                }
            } else if (allRemaining.length === 2) {
                if (canPlayTogetherWithTime(allRemaining[0], allRemaining[1])) {
                    matches.push({
                        type: 'singles',
                        players: allRemaining
                    });
                } else {
                    // Can't pair them
                    allRemaining.forEach(p => {
                        matches.push({
                            type: 'waiting',
                            players: [p]
                        });
                    });
                    
                    // Determine conflict type for warning
                    const prefConflict = !canPlayTogether(allRemaining[0].name, allRemaining[1].name);
                    const timeConflict = !timesOverlap(allRemaining[0].timeRange, allRemaining[1].timeRange);
                    
                    if (prefConflict && timeConflict) {
                        warnings.push(`${allRemaining[0].name} and ${allRemaining[1].name} cannot be paired (exclusion preference + time conflict)`);
                    } else if (prefConflict) {
                        warnings.push(`${allRemaining[0].name} and ${allRemaining[1].name} cannot be paired (exclusion preference)`);
                    } else if (timeConflict) {
                        warnings.push(`${allRemaining[0].name} and ${allRemaining[1].name} cannot be paired (time conflict)`);
                    }
                }
            } else if (allRemaining.length === 1) {
                matches.push({
                    type: 'waiting',
                    players: allRemaining
                });
            } else if (allRemaining.length > 3) {
                warnings.push(`${allRemaining.length} players could not be matched due to preference conflicts`);
                allRemaining.forEach(p => {
                    matches.push({
                        type: 'waiting',
                        players: [p]
                    });
                });
            }
            
            return { matches, warnings };
        }
        
        function getMatchIndicators(player, matchPlayers, matchType) {
            // Only show indicators for singles matches
            if (matchType !== 'singles') return '';
            
            const prefs = getUserPrefs(player.name);
            const indicators = [];
            
            matchPlayers.forEach(other => {
                if (other.name === player.name) return;
                
                const otherNorm = normalizeName(other.name);
                if (prefs.include.includes(otherNorm)) {
                    indicators.push(`<span class="match-indicator satisfied">‚úì with ${other.name}</span>`);
                }
            });
            
            return indicators.join(' ');
        }
        
        function render() {
            const checkins = getCurrentCheckins();
            
            document.getElementById('count').textContent = checkins.length;
            
            const checkinList = document.getElementById('checkinList');
            if (checkins.length === 0) {
                checkinList.innerHTML = '<div class="empty-state">No check-ins yet</div>';
            } else {
                checkinList.innerHTML = checkins.map((c, i) => {
                    const guestInfo = c.isGuest ? `<span class="guest-indicator">guest of ${c.addedBy}</span>` : '';
                    const timeInfo = c.timeRange ? `<span class="time-badge">${formatTimeRange(c.timeRange.start, c.timeRange.end)}</span>` : '';
                    const rotationInfo = c.allowRotation === false ? `<span class="time-badge" style="background: #ffebee; color: #c62828;">No rotation</span>` : '';

                    return `
                        <div class="checkin-item">
                            <span>
                                <span class="checkin-name">${i + 1}. ${c.name} ${guestInfo}${timeInfo}${rotationInfo}</span>
                                <span class="preference-badge ${c.playStyle || 'both'}">${getPreferenceLabel(c.playStyle || 'both')}</span>
                                <span class="checkin-time">${formatTime(c.timestamp)}</span>
                            </span>
                            <button class="remove-btn" onclick="removeCheckIn(${i})">Remove</button>
                        </div>
                    `;
                }).join('');
            }
            
            const matchesDiv = document.getElementById('matches');
            if (checkins.length === 0) {
                matchesDiv.innerHTML = '';
                return;
            }
            
            const { matches, warnings } = organizeMatches(checkins);
            let html = '<h2>Organized Matches</h2>';
            
            if (warnings.length > 0) {
                html += '<div class="warning-box">' + warnings.join('<br>') + '</div>';
            }
            
            matches.forEach(match => {
                if (match.type === 'doubles') {
                    html += `
                        <div class="match-group">
                            <h3>Doubles ${match.number}</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                } else if (match.type === 'singles') {
                    html += `
                        <div class="match-group singles-group">
                            <h3>Singles Match</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                } else if (match.type === 'singles-or-practice') {
                    html += `
                        <div class="match-group singles-group">
                            <h3>Rotation (3 players) - 1v1 or 1v2</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                } else if (match.type === 'waiting') {
                    html += `
                        <div class="match-group singles-group">
                            <h3>Waiting</h3>
                            <ul>
                                ${match.players.map(p => {
                                    const guestTag = p.isGuest ? ` <span class="guest-indicator">(guest of ${p.addedBy})</span>` : '';
                                    const timeTag = p.timeRange ? ` <span class="time-badge">${formatTimeRange(p.timeRange.start, p.timeRange.end)}</span>` : '';
                                    return `<li>‚Ä¢ ${p.name}${guestTag}${timeTag} <span class="preference-badge ${p.playStyle || 'both'}">${getPreferenceLabel(p.playStyle || 'both')}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                }
            });
            
            matchesDiv.innerHTML = html;
        }
        
        // Initial setup
        async function init() {
            // Load available groups from Firebase
            await loadAvailableGroups();

            // Get group ID from URL path
            const urlGroupId = getGroupIdFromUrl();

            if (urlGroupId && availableGroups[urlGroupId]) {
                // URL has a valid group - authenticate and load it
                const groupSettings = availableGroups[urlGroupId].settings || {};
                const groupName = groupSettings.groupName || urlGroupId;
                const groupPin = groupSettings.groupPin || '';

                if (checkAuth(urlGroupId, groupName, groupPin)) {
                    await selectGroup(urlGroupId);
                } else {
                    // Authentication failed - redirect to root
                    window.location.href = '/';
                    return;
                }
            } else {
                // No valid group in URL - show group selector
                await openGroupSelector();
            }

            // Initialize UI
            initDates();
            displayWeather();
        }

        // Start the app
        init();
    </script>
</body>
</html>
